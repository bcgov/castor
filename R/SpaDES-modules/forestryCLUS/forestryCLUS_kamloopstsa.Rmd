---
title: "forestryCLUS"
author: "Elizabeth Kleynhans"
date: "29 June 2020"
output:
html_document: 
keep_md: yes
---

<!--
Copyright 2020 Province of British Columbia
 
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
 
http://www.apache.org/licenses/LICENSE-2.0
 
Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.-->

# Overview

This module provides the logic for simulating forestry decisions on the landscape. These decisions currently involve spatializing the harvest flow objectives which include: where, when and how much to harvest. These factors help determine policies related to harvest flows, opening size, seral distrubitions, road densitites, preservation areas, silvicultural systems, etc. More sophistication to these decisions would involve looking at the costs and benefits beyond the current time period; this requires optimization or improved heuristics -- which may be considered in the future. The general overview of forestryCLUS follows.

At each time step, harvest units (pixels or blocks) are ranked according to a priority (e.g., oldest first), this constructs a queue. This queue of harvest units are then subject to various constraints meant to meet objectives for the study area. Harvest units are harvested until either a constraint is binding, the queue is exhausted or the harvest flow is met. Next, the age of the forest is advanced to the next time period and the process is repeated. 

During the simulation various reports and information surrounding each pixel can be saved/recorded or used in a summary. Note these outputs are considered expected future outcomes given the inputs developed by the anlayst.For a historical selection of harvesting activities see [cutblockSeqPrepCLUS](https://github.com/bcgov/clus/tree/master/R/SpaDES-modules/cutblockSeqPrepCLUS). Both  cutblockSeqPrepCLUS and forestryCLUS build a list of landing locations through simulation time. One is historical while the other is one possible future realization.

# Usage
This module could be a parent module?? It relies on: 
1. dataloadCLUS (set up the clusdb) 
2. blockingCLUS (preforms the pixel aggregation into harvest units)
3. growingStockCLUS (increments the age and volume in pixels)
4. (Optionally) rsfCLUS (track resource selection functions)
5. (Optionally) roadCLUS (preforms the access to the harvest units)
6. uploaderCLUS (uploades the outputs to a shiny app)


# Kamloops TSA Scenarios
business as usual (BAU); no new constraints, caribou or otherwise; establishes the current 'baseline' or benchmark to evaluate the potential impact of 'new' actions in caribou habitat

no harvest in Columbia North critical habtiat; to support Columbia North herd planning, we run a sceanrio with no harvest in the  Columbia North HEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Columbia North only, assuming other herds unprotected

"ECCC" in Columbia North caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on Columbia North only

No harvest in all Wells Gray South and groundhog critical habitat caribou critical habtiat; to support Wells Gray South and groundhog herd planning, we run a sceanrio with no harvest in the Wells Gray South and groundhog HEWSR and Matrix; harvest is BAU in other herds; assesses the potential maximum impact of protecting Wells Gray South and groundhog only, assuming other herds unprotected

"ECCC" in Wells Gray South and groundhog caribou critical habtiat; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low elevation critical habitat, and up to 35% disturbance in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order on Columbia/Frisbee only

no harvest in caribou critical habtait areas; where there is critical habitat, no harvest in any types (including matrix); establishes the 'maximum impact' that protection of caribou habitat might potentially have on forest harvest; in Kamloops these include Columbia North HEWSR, Columbia North Matrix, Groundhog HESWR, Groundhog Matrix, Wells Gray North HEWSR, Wells Gray North Matrix, Wells Gray South HEWSR, Wells Gray South Matrix

'ECCC' in caribou critical habtait areas; an alternative to a no harvest scenario, attemps to interpret the federal recovery strategy that stipulates no disturbance in high and low eleavtion cirtcial habitat, and up to 35% disturabnce in matrix habtiat; this is a possible scenario if Canada were to enact an emergency order; assumes all herds protected

DU9 specific scenarios developed by caribou recovery science team. These were doen for each herd indivudalls that overlaps the TSA:
First set of scenarios uses rast.zone_du9_scenarios; this raster defines priority forest stands for 'protection', i.e., old or close to old stands, plus a 500m buffer. Scenarios:
* 3a = No harvest in old forest, recruitment forest and buffered Groundhog core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Groundhog matrix habitat areas
* 3b = No harvest in old forest and recruitment forest Groundhog core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Groundhog matrix habitat areas.

Second set of scenarios uses rast.zone_barkerville_groundhog_zones_20210303; this raster defines some priority matrix and core areas, and priority forest stands for 'protection', i.e., old or close to old stands, plus a 500m buffer. scenarios:
* 2 or he0d_m12d; sets no harvest in all core priority zones and 12% max disturbance in all matrix priority zones
* high_med_low_priority (new 3a): sets no harvest in priority stands in all core priority zones and 15% max disturbance in all matrix priority zones
* high_med_priority (new 3b); sets no harvest in priority stands in high and medium core priority zones and 15% max disturbance in high and medium matrix priority zones
* high_priority (new 3c); sets no harvest in priority stands in high core priority zones and 15% max disturbance in high and medium matrix priority zones

# Kamloops TSA Parameters 
## New Caribou Zone Constraints
BAU = beo, vqo, wha, uwr, fsw, parks and protected areas, community watersheds 

No harvest in all herds = rast.zone_cond_noharvest_columbia_north_crithab_or_herd,
                          rast.zone_cond_noharvest_groundhog_crithab_or_herd,
                          rast.zone_cond_noharvest_wells_gray_south_crithab_or_herd,
                          rast.zone_cond_noharvest_wells_gray_north_crithab_or_herd

ECCC in all herds = rast.zone_cond_eccc_columbia_north_crithab_or_herd,
                    rast.zone_cond_eccc_groundhog_crithab_or_herd,
                    rast.zone_cond_eccc_wells_gray_south_crithab_or_herd,
                    rast.zone_cond_eccc_wells_gray_north_crithab_or_herd

No harvest in Columbia North = rast.zone_cond_noharvest_columbia_north_crithab_or_herd

ECCC Columbia North = rast.zone_cond_eccc_columbia_north_crithab_or_herd

No harvest in Wells Grey South and Groundhog = rast.zone_cond_noharvest_wells_grey_south_crithab_or_herd,
rast.zone_cond_noharvest_groundhog_crithab_or_herd

ECCC in Wells Grey South and Groundhog = rast.zone_eccc_wells_grey_south_crithab_or_herd,
rast.zone_cond_eccc_groundhog_crithab_or_herd

DU 9 scenarios version 1 = rast.zone_du9_scenarios

DU 9 Groundhog scenarios version 2 = rast.zone_barkerville_groundhog_zones_20210303


## 'harvestPriority' parameter 
- used oldest first

- as alternative,  could focus on minimizing 'disturbance' for caribou, then older, higher volume stands
  - 'dist, age DESC, vol DESC' prioritize based on:
      - 'dist', i.e., distance to disturbed pixel (closest first), then
      - 'age DESC', i.e., descending age (oldest first), then
      - 'vol DESC', i.e., descending volume (highest volume first)

## 'harvestFlow'
from 2015 analysis discussion paper:  maximum even flow harvest was 2,000,000m^3^/year; from determination, June 3, 2010, the  AAC was set at 485 000 cubic metres 

- First, I tested a harvest flow of 2,000,000m^3^/year (10,000,000m^3^/5-year); was not able to achieve this, so dropped to the harvest flow eventually settling on 1,500,000m^3/yr. This harvest rate was only possible with with a minimum harvest volume > 90 and age >= 60. In the report they say that to meet mid-term harvest levels they expect a significant portion of the harvest will come from stands less than 80yrs. they also provide a figure showing that between 1/4 and 1/3 of the volume harvested will be within the age range of 61 to 80 yrs So setting a minimum age to 60 is probably reasonable for this TSA

For cutblock adjacency, I used 3 m adjacency; no real mention fo this in analysis report; used 'green-up' targets at coarser scales

## Modify Constraints

```{r, zone_update}
library (DBI)
# STEP 1: Connect to the clusdb.sqlite database for the AOI
clusdb <- dbConnect(RSQLite::SQLite(), dbname = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/Kamloops_TSA_clusdb.sqlite")) # connext to clusdb -- set the locations of the sqlite

# STEP 2: View the constraints available to a zone
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_smc_zones_20210315'") # Note: the reference_zone is the name of the raster in the rast schema. If there is no 'WHERE' clause this may return 1000's of zones
zoneconstraints<-dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_cond_cw'") 

# GROUNDHOG Alternative Scenarios
# Below makes the matrix habitat available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_eccc_groundhog_crithab_or_herd' AND zoneid = 2")
#Below will set Groundhog old and recruit forest as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_gh_scenarios' AND (zoneid = 3) OR  (zoneid = 4)") 
# Below makes the matrix habitat max 12% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_eccc_groundhog_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_cond_eccc_groundhog_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_eccc_groundhog_crithab_or_herd' AND zoneid = 2") 
# Below makes priority stands in all priority zones no harvest, core outside of priority stands available, and all the matrix priority zones max 15% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 103) OR (zoneid = 104) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117) OR (zoneid = 118)") 
# Below makes priority stands in high and medium priority zones no harvest, core outside of priority stands available, and high and medium the matrix priority zones max 15% disturbance; low priority areas available for harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57)  OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 35)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 35)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33) OR (zoneid = 35)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 103) OR (zoneid = 104) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117) OR (zoneid = 118) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 34)") 
# Below makes priority stands in high priority zones no harvest, core outside of priority stands available, and high matrix priority zones max 15% disturbance; medium and low priority areas available for harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57)  ") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 33)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 103) OR (zoneid = 104) OR (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117) OR (zoneid = 118) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 34) OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63) OR (zoneid = 35)") 

# WELLS GRAY SOUTH Update the constraints available to a zone as specified in the scenario
# Below makes the matrix habitat available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd' AND zoneid = 2") 
# Below makes the matrix habitat max 12% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_eccc_wells_gray_south_crithab_or_herd' AND zoneid = 2") 
# Below makes priority stands in all priority zones no harvest, core outside of priority stands available, and all the matrix priority zones max 15% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 104) OR (zoneid = 103)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 116) OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102)  OR (zoneid = 118)") 
# Below makes priority stands in high and medium priority zones no harvest, core outside of priority stands available, and all high and medium matrix priority zones max 15% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 104)  OR (zoneid = 103)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)  OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)  OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115) OR (zoneid = 117)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 118) OR (zoneid = 116)") 
# Below makes priority stands in high priority zones no harvest, core outside of priority stands available, and all high matrix priority zones max 15% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 104)  OR (zoneid = 103)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 15 where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 115)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_smc_zones_20210315' AND (zoneid = 29) OR (zoneid = 30) OR (zoneid = 33) OR (zoneid = 34) OR (zoneid = 35) OR (zoneid = 36) OR (zoneid = 38) OR (zoneid = 43) OR (zoneid = 44) OR (zoneid = 45) OR (zoneid = 46) OR (zoneid = 55) OR (zoneid = 56) OR (zoneid = 57) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 60) OR (zoneid = 61) OR (zoneid = 62) OR (zoneid = 63) OR (zoneid = 66) OR (zoneid = 96) OR (zoneid = 102) OR (zoneid = 118) OR (zoneid = 116) OR (zoneid = 117)") 


# COLUMBIA NORTH Update the constraints available to a zone as specified in the scenario
# Below makes the matrix habitat available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_eccc_columbia_north_crithab_or_herd' AND zoneid = 1") 

# WELLS GRAY NORTH Update the constraints available to a zone as specified in the scenario
# Below makes the matrix habitat available to harvest
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_cond_eccc_wells_gray_north_crithab_or_herd' AND zoneid = 2") 
# Below makes the matrix habitat max 12% disturbance
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'le' where reference_zone = 'rast.zone_cond_eccc_wells_gray_north_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_cond_eccc_wells_gray_north_crithab_or_herd' AND zoneid = 2") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 12 where reference_zone = 'rast.zone_cond_eccc_wells_gray_north_crithab_or_herd' AND zoneid = 2") 


# WELLS GRAY SOUTH Update the constraints available to a zone as specified in the scenario
#Below will set Wells Gray South old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 15) OR (zoneid = 30) OR (zoneid = 59)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR  (zoneid = 14) OR (zoneid = 19) OR (zoneid = 29) OR (zoneid = 34) OR (zoneid = 58) OR (zoneid = 64) OR (zoneid = 67) OR (zoneid = 75)") 
#Below will set Wells Gray South old and recruit forest as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 15) OR (zoneid = 30)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND zoneid = 76")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 1) OR  (zoneid = 16) OR (zoneid = 59) OR (zoneid = 45) OR (zoneid = 44) OR (zoneid = 58) OR (zoneid = 60) OR (zoneid = 71)") 


# COLUMBIA NORTH Update the constraints available to a zone as specified in the scenario
#Below will set Columbia North old, recruit and buffer as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 19) OR (zoneid = 34) OR (zoneid = 48)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 14) OR  (zoneid = 15) OR (zoneid = 29) OR (zoneid = 30) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 67) OR (zoneid = 76) OR (zoneid = 75)") 
#Below will set Columbia North old and recruit forest as no harvest and matrix as 35% disturbance (no buffer)
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 4) OR (zoneid = 19)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'ge' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)") 
dbExecute(clusdb, "UPDATE zoneconstraints SET percentage = 65 where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 63) OR (zoneid = 64)")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = '' where reference_zone = 'rast.zone_du9_scenarios' AND (zoneid = 14) OR  (zoneid = 15) OR (zoneid = 29) OR (zoneid = 30) OR (zoneid = 34) OR (zoneid = 48) OR (zoneid = 58) OR (zoneid = 59) OR (zoneid = 67) OR (zoneid = 76) OR (zoneid = 75)") 

dbGetQuery(clusdb, "SELECT * from zoneConstraints WHERE reference_zone = 'rast.zone_smc_zones_20210315'")
dbExecute(clusdb, "UPDATE zoneconstraints SET type = 'nh' where reference_zone = 'rast.zone_smc_zones_20210315' and zoneid in (43,44,45) ")
dbExecute(clusdb, "UPDATE zoneconstraints SET threshold = 0 where reference_zone = 'rast.zone_smc_zones_20210315' and zoneid in (46) ")


dbDisconnect(clusdb)
```


```{r module_usage}
library (SpaDES.core)
library (data.table)
source (paste0(here::here(), "/R/functions/R_Postgres.R"))

moduleDir <- file.path(paste0(here::here(), "/R/SpaDES-modules"))
inputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/inputs")) %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS/outputs"))
cacheDir <- file.path(paste0(here::here(), "/R/SpaDES-modules/forestryCLUS"))
times <- list(start = 0, end = 40) # 5 year interval; 200 years = 40 intervals
parameters <- list(
  .progress = list(type = NA, interval = NA),
  .globals = list(),
  dataLoaderCLUS = list(   dbName='clus',
                           save_clusdb = FALSE,
                           useCLUSdb = paste0(here::here(), "/R/SpaDES-modules/dataLoaderCLUS/Kamloops_TSA_clusdb.sqlite"),
                           #Study Area
                           nameBoundaryFile = "tsa_aac_bounds",
                           nameBoundaryColumn = "tsa_name",
                           nameBoundary = "Kamloops_TSA",
                           nameBoundaryGeom = 'wkb_geometry',
                           nameCompartmentRaster = "rast.tsa_aac_boundary",
                           nameCompartmentTable = "tsa_aac_bounds_vat",
                           nameMaskHarvestLandbaseRaster = 'rast.bc_thlb2018',
                           nameZoneRasters=c("rast.zone_cond_beo", 
                                           "rast.zone_cond_vqo", 
                                           "rast.zone_cond_wha", 
                                           "rast.zone_cond_uwr", 
                                           "rast.zone_cond_nharv", 
                                           "rast.zone_cond_fsw", 
                                           "rast.zone_cond_cw",
                                            #"rast.zone_cond_noharvest_columbia_north_crithab_or_herd"
                                           # "rast.zone_cond_noharvest_groundhog_crithab_or_herd"
                                           # "rast.zone_cond_noharvest_wells_gray_south_crithab_or_herd"
                                           # "rast.zone_cond_noharvest_wells_gray_north_crithab_or_herd"
                                            #"rast.zone_cond_eccc_columbia_north_crithab_or_herd"
                                           # "rast.zone_cond_eccc_groundhog_crithab_or_herd"
                                           # "rast.zone_cond_eccc_wells_gray_south_crithab_or_herd"
                                           # "rast.zone_cond_eccc_wells_gray_north_crithab_or_herd"
                                           # "rast.zone_smc_zones_20210315"
                                           # "rast.zone_gh_scenarios"
                                           # "rast.zone_barkerville_groundhog_zones_20210303"
                                            ),
                                           
                           nameZoneTable = "zone.constraints",
                           # nameZonePriorityRaster = "rast.zone_cond_beo",
                           nameYieldsRaster = "rast.ycid_vdyp",
                           nameYieldTable = "yc_vdyp",
                           nameYieldsTransitionRaster = "rast.tipsy2018_id",
                           nameYieldTransitionTable = "yc_tipsy",
                           nameForestInventoryRaster = "rast.vri2019_id",
                           nameForestInventoryKey = "feature_id",
                           nameForestInventoryTable = "veg_comp_lyr_r1_poly2019",
                           nameForestInventoryAge = "proj_age_1",
                           nameForestInventoryHeight = "proj_height_1",
                           nameForestInventoryCrownClosure = "crown_closure",
                           nameForestInventoryTreed = "bclcs_level_2",
                           nameForestInventorySiteIndex = "site_index"),
  blockingCLUS = list(blockMethod ='pre', 
                      patchZone = 'rast.zone_cond_beo',
                      patchVariation = 6,
                      nameCutblockRaster ="rast.cns_cut_bl",
                      useLandingsArea = FALSE, 
                      useSpreadProbRas = FALSE),
  forestryCLUS = list(harvestBlockPriority = "age DESC", # "dist, age DESC, vol DESC"
                      #harvestZonePriority = "age DESC",
                      #harvestZonePriorityInterval = 1,
                      reportHarvestConstraints = T,
                      adjacencyConstraint = 3),
  growingStockCLUS = list (periodLength = 5),
  roadCLUS = list(roadMethod = 'pre', 
                  nameCostSurfaceRas = 'rast.rd_cost_surface', 
                  nameRoads =  'rast.crds_all'),
  # rsfCLUS = list (calculateInterval = 10, # at what time interval to calculate RSF
  #                 criticalHabitatTable = "public.vat_bc_crithab_and_herd",
  #                 randomEffectsTable = "public.rsf_re_coeff",
  #                 writeRSFRasters = TRUE,
  #                 checkRasters = FALSE),
  survivalCLUS = list (caribou_herd_density = 0.05, # assign what is appropriate for the herd
                       nameRasCaribouHerd = "rast.caribou_herd", # raster of herd boundaries
                       tableCaribouHerd = "public.caribou_herd_vat"), # look-up table of herd names
  disturbanceCalcCLUS = list(calculateInterval =  1, # should be 1 if using constraints on 'dist' (disturbance) 
                             criticalHabitatTable = "public.vat_bc_crithab_and_herd",
                             criticalHabRaster = "rast.bc_crithab_and_herd",
                             permDisturbanceRaster = "rast.mine_ag_wind_rail",
                             recovery = 40),
  volumebyareaReportCLUS = list (calculateInterval = 1,
                                 AreaofInterestRaster = "rast.bc_crithab_and_herd",
                                 AreaofInterestTable = "public.vat_bc_crithab_and_herd"),
  uploaderCLUS = list(aoiName = 'kamloops_tsa', # name of the schema that gets uploaded to postgres
                      dbInfo  = list(keyring::key_get("vmdbhost", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbuser", keyring="postgreSQL"), 
                                     keyring::key_get("vmdbpass", keyring="postgreSQL"),  
                                     keyring::key_get("vmdbname", keyring="postgreSQL"))
                  ),
  yieldUncertaintyCLUS = list(elevationRaster = 'rast.dem')
)

modules <- list("dataLoaderCLUS", 
                "growingStockCLUS", 
                "blockingCLUS", 
                "forestryCLUS", 
                "roadCLUS",  
                #"yieldUncertaintyCLUS", 
                "survivalCLUS", 
                "disturbanceCalcCLUS", 
                # "rsfCLUS", # error line 453 - need to debug
                "volumebyareaReportCLUS",
                "uploaderCLUS"
                )

# rsf_model_coeff <- data.table (getTableQuery ("SELECT * FROM rsf_model_coeff WHERE population = 'DU7' and  species = 'caribou' and season IN ('A')"))
# rsf_model_coeff[, bounds := 'rast.bc_crithab_and_herd']

# scenario = data.table (name = "kamloops_bau",
#                        description = "Business as usual (BAU). Oldest first. Adjacency = 3m. Harvest flow = 1,500,000 m3/yr.")
# scenario = data.table (name = "kamloops_wells_north_nh", description = "No harvest in Wells Gray North critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Oldest first. Adjacency = 3m. Harvest flow 1,500,000 m3/yr.")
# scenario = data.table (name = "kamloops_wells_south_nh",
#                        description = "No harvest in Wells Gray South critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Oldest first. Adjacency = 3m. Harvest flow 1,500,000 m3/yr.")
# scenario = data.table (name = "kamloops_wells_south_ch_he0d_m15d",
#                        description = "No harvest in Wells Gray South high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Wells Gray South matrix critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Oldest first. Adjacency = 3m. Harvest flow 1,500,000 m3/yr.")
# scenario = data.table (name = "kamloops_groundhog_nh",
#                        description = "No harvest in Groundhog critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Oldest first. Adjacency = 3m. Harvest flow 1,500,000 m3/yr.")
# scenario = data.table (name = "kamloops_well_south_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered Wells Gray South core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Wells Gray South matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_well_south_scen3b",
#                        description = "No harvest in old forest and recruitment forest Wells Gray South core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Wells Gray South matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_ch_he0d_m15d",
#                         description = "No harvest in Groundhog high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Groundhog matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_nh",description = "No harvest in Columbia North critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_ch_he0d_m12d",description = "No harvest in Columbia North high elevation critical habitat, maximum 12% disturbancein Columbia North matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_scen3a", description = "No harvest in old forest, recruitment forest and buffered Columbia North core critical habitat areas, as defined by Bevan Ernst, maximum 15% disturbance (unbuffered) in Columbia North matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_scen3b",
#                        description = "No harvest in old forest and recruitment forest Columbia North core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Columbia North matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_scen3a",
#                        description = "No harvest in old forest, recruitment forest and buffered Groundhog core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Groundhog matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")

# scenario = data.table (name = "kamloops_groundhog_scen3b",
#                        description = "No harvest in old forest and recruitment forest Groundhog core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Groundhog matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_scen3b",
#                        description = "No harvest in old forest and recruitment forest Columbia North core critical habitat areas, as defined by Bevan Ernst, maximum 35% buffered disturbance (unbuffered) in Groundhog matrix habitat areas. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_gray_south_he0d",
#                        description = "No harvest in Wells Gray South high elevation critical habitat; harvest allowed in matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_columbia_north_he0d",
#                        description = "No harvest in Columbia North high elevation critical habitat; harvest allowed in matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_he0d",
#                        description = "No harvest in Groundhog high elevation critical habitat; harvest allowed in matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_gray_north_he0d",
#                        description = "No harvest in Wells Gray North high elevation critical habitat; harvest allowed in matrix critical habitat. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_he0d_m12d",
#                        description = "No harvest in Groundhog high elevation critical habitat; harvest allowed in matrix critical habitat up to 12% forest disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_high_med_priority",
#                        description = "No harvest in Groundhog high priority stands in high and medium priority high elevation critical habitat; harvest allowed in high and medium matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest permitted in low priority core and matrix. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_north_he0d_m12d",
#                        description = "No harvest in Wells Gray North high elevation critical habitat; harvest allowed in matrix critical habitat up to 12% forest disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_south_he0d_m12d",
#                        description = "No harvest in Wells Gray South high elevation critical habitat; harvest allowed in matrix critical habitat up to 12% forest disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_south_hi_med_lo_priority",
#                        description = "No harvest in Wells Gray South high priority stands in all high elevation critical habitat; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_south_hi_med_priority",
#                        description = "No harvest in Wells Gray South high priority stands in all high and medium priority HEWSR; harvest allowed in high and medium priority matrix critical habitat up to 15% disturbance (no buffer) in forested area. Other areas available to harvest. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_wells_south_hi_priority",
#                        description = "No harvest in Wells Gray South high priority stands in high priority HEWSR; harvest allowed in high priority matrix critical habitat up to 15% disturbance (no buffer) in forested area. Other areas available to harvest. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_he0d_m12d",
#                        description = "No harvest in Groundhog high elevation critical habitat; harvest allowed in matrix critical habitat up to 12% forest disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_hi_med_priority",
#                        description = "No harvest in Groundhog high priority stands in high and medium priority high elevation critical habitat; harvest allowed in high and medium matrix critical habitat up to 15% disturbance (no buffer) in forested area. Low and no priority areas open to harvest. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")
# scenario = data.table (name = "kamloops_groundhog_hi_priority",
#                        description = "No harvest in Groundhog high priority stands in high priority high elevation critical habitat; harvest allowed in high matrix critical habitat up to 15% disturbance (no buffer) in forested area. Medium, low and no priority areas open to harvest. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")

#scenario = data.table (name = "kamloops_groundhog_hi_med_lo_priority", description = "No harvest in Groundhog high priority stands in all high elevation critical habitat; harvest allowed in all matrix critical habitat up to 15% disturbance (no buffer) in forested area. Harvest flow 1,500,000 m3/yr. Adjacency = 3m. Oldest first.")


# BELOW ARE OLD SCENARIOS THAT NEED TO BE RE-RUN
# scenario = data.table (name = "kamloops_colnsfb_nh",
#                        description = "No harvest in all CN, CS and FB critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "kamloops_colnsfb_ch_he0d_m15d",
#                        description = "No harvest in CN, CS and FB high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in CN, CS and FB matrix critical habitat. Adjacency was set to 3m.")
# scenario = data.table (name = "kamloops_all_nh",
#                        description = "No harvest in all critical habitat of all herds that overlap with the harvest unit (e.g., TSA or TFL). Adjacency was set to 3m.")
# scenario = data.table (name = "kamloops_all_ch_he0d_m15d",
#                        description = "No harvest in high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in matrix critical habitat of all herds that overlap with the harvest unit. Adjacency was set to 3m.")
# scenario = data.table (name = "kamloops_wgsgr_nh",
#                        description = "No harvest in Wells Gray S/Groundhog critical habitat that overlap with the harvest unit (e.g., TSA or TFL). Adjacency was set to 3m.")
 # scenario = data.table (name = "kamloops_wgsgr_ch_he0d_m15d",
 #                        description = "No harvest in Wells Gray S/Groundhog high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Chilcotin matrix critical habitat. Adjacency was set to 3m.")
 # scenario = data.table (name = "kamloops_bau_try",
 #                        description = "Testing whether changing vol >90 and age>=60 alters the flow.")
 # scenario = data.table (name = "kamloops_wells_south_ch_he0d_m15d",
 #                        description = "No harvest in Wells Gray South high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Wells Gray South matrix critical habitat. Adjacency was set to 3m.")




# scenario = data.table (name = "kamloops_wells_north_ch_he0d_m15d",
#                         description = "No harvest in Wells Gray North high elevation critical habitat, maximum 35% buffered disturbance (15% harvest) in Wells Gray North matrix critical habitat. Adjacency was set to 3m.")

# scenario = data.table (name = "kamloops_columbia_north_ch_he10d_m15d",
#                        description = "No harvest in Columbia North high elevation critical habitat areas as defined by Bevan Ernst, maximum 35% buffered disturbance (15% harvest) in Columbia North matrix habitat areas as defined by Bevan Ernst. Adjacency was set to 3m.")


harvestFlow <- rbindlist(list(data.table(compartment ="Kamloops_TSA",
                                     partition = ' vol > 90 and age >= 60 ', 
                                     year = rep( seq (from = 2018, 
                                                      to = 2218, 
                                                      by = 5),
                                                1), 
                                     flow = 7500000))) #1,500,000 m3/yr

# flow=5750000 worked for adding in the age >=60 # Note in the TSA Discussion Paper (https://www2.gov.bc.ca/assets/gov/farming-natural-resources-and-industry/forestry/stewardship/forest-analysis-inventory/tsr-annual-allowable-cut/kamloops_tsa_discussion_paper.pdf) it looks like a sustainable flow is around 2 000 000 m3/yr. 


#harvestFlow<-rbindlist(list(harvestFlowA,harvestFlowB,harvestFlowC)) # if > 1 harvest flow

patchSizeDist<- data.table(ndt= c(1,1,1,1,1,1,
                                  2,2,2,2,2,2,
                                  3,3,3,3,3,3,
                                  4,4,4,4,4,4,
                                  5,5,5,5,5,5), 
                           sizeClass = c(40,80,120,160,200,240), 
                           freq = c(0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.3,0.3,0.1,0.1,0.1, 0.1,
                                    0.2, 0.3, 0.125, 0.125, 0.125, 0.125,
                                    0.1,0.02,0.02,0.02,0.02,0.8,
                                    0.3,0.3,0.1,0.1,0.1, 0.1))

#calb_ymodel<-readRDS(paste0(here::here(), "/R/Params/calb_ymodel.rds")) #See linkHBS_VRI_Calibration.Rmd
#calb_data4<-readRDS(paste0(here::here(), "/R/Params/calb_data.rds")) #See linkHBS_VRI_Calibration.Rmd

objects <- list(harvestFlow = harvestFlow, 
                patchSizeDist = patchSizeDist, 
                scenario = scenario)

paths <- list(cachePath = cacheDir,
              modulePath = moduleDir,
              inputPath = inputDir,
              outputPath = outputDir)

mySim <- simInit(times = times, 
                 params = parameters, 
                 modules = modules,
                 objects = objects, 
                 paths = paths)

# outputs to keep; these are tables that get used in the uploader
outputs(mySim) <- data.frame (objectName = c("harvestReport",
                                             "growingStockReport",
                                             "tableSurvival",
                                             "disturbanceReport",
                                             "volumebyareaReport"))

#Run the model 1 time
system.time({mysimout<-spades(mySim)})

#Run the model with experiment
#sims3 <- experiment(mySim, replicates = 2)

#Profile the model
#profvis::profvis({system.time({mysimout<-spades(mySim)})})


```


# Events

## Flow Chart

```{r, flow_chart}
library(SpaDES.core)
eventDiagram(mysimout)
```

## Algorithum

The general algorithum (pseudo-code) follows as:

`compartment_list`= SELECT zones FROM compartments WHERE target > 0 ORDER BY priority_compartment

FOR compartment_selected in `compartment_list`
`queue`<- SELECT pixelid, blockid FROM pixels WHERE 
            compartment = compartment_selected AND thlb > 0 AND constraint = 0                 ORDER BY priority
               
IF (`queue` > 0 )
  check constraints
ELSE 
  NEXT
        

# Data dependencies

## Input data

A SQLite db is required (output from dataloaderCLUS). A harvestFlow data.table object that includes the forest management unit (i.e., compartment, aka - 'supply block'), the partition from which the harvest flow applies (e.x., All dead pine); the year at which the flow applies and the amount of volume.

## Output data

A list of landings || blocks from when they are harvested.

# Links to other modules

dataloaderCLUS is required.

