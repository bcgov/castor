---
title: "Model_validation_ignition"
author: "Elizabeth Kleynhans"
date: "2023-01-18"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source(here::here("R/functions/R_Postgres.R"))
library(tidyverse)
require (sf)
require (RPostgreSQL)
require (rpostgis)
require (fasterize)
require (raster)
require (dplyr)
library(bcdata)
library(SpaDES.tools)
library(terra)
library(ggplot2)

```

## Validating fire ignition map

Following methods outlined in Johnson et. al. (2006) Resource selection functions based on use-availability data: Theoretical motivation and evaluation methods.Journal of wildlife management 70: 347-357. I will test whether my ignition points are reasonably estimated by my logistic regression equation. Basically, the idea is to take my probability of ignition map and bin the predicted probabilities into bins. Then weight these bins by the amount of area they cover on the maps. by multiplying the mid point of the probability bin by its area we can estimate the proportion of ignition points we expect to fall in that bin. Then using an independent data set (such as 2022 ignition points) we can check whether our expected number of ignition points actually lines up with our actual data. if the two match then by ploting predicted proportion of igntions in each bin by actual proportion of igntions in each bin I should see a line that has a slope of 1 and intercept of 0. If I get this it indicates that my model is proportional to the probability of use. 

This is what the paper says: 

"First,  assess  the  slope  of  the  regression  line  for  a  significant difference   from   a   slope   of   zero   where   use   would   equal availability   and   therefore   indicate   that   the   model   is   not different  from  that  of  a  random  or  neutral  model.  Second, assess whether the slope is different from 1.0, which is the slope expected for a model that is proportional to the probability of use.  Third,  assess  the  constant  for  an  intercept  of  zero,  the intercept  expected  for  a  model  that  is  approximately  proportional to probability of use. And finally, use both the R2 of the model and Chi2 goodness-of-fit test to assess fit. A model that was  proportional  to  probability  of  use  would  have  a  slope different from 0, but not different from 1, an intercept of 0, and a high R2 value with a nonsignificant Chi2 goodness-of-fit value.Finally, chi2 tests for each observed and expected proportion can be used to determine in which RSF bins the observed frequency differs from expected. If these conditions are not satisfied, the user  might  consider  revisiting  the  process  starting  at  step  3 (reclassify the RSF using a different model), rebinning the RSF values,  or  estimating  a  model  with  different  environmental factors".

## General methods:

# 1.) Create proability of ignition map for 2022
Create proability ignition map for 2022. Basically use the data used in the 2021 fire ignition layer but extract 2022 climate data from climate BC and run the models again to create the new ignition map. 

# 2.) extract 2022 ignition data from climate BC

# 3.) get the proability of ignition for each new ignition point. Either extract it from the ignition map by overlaying the two, or determine them again by extracting all the data i.e. vegetation data, climate data, elevation data, distance to infrastructure data etc for each ignition point. I just extracted the values off the map, but it might be better to actually recalculate them for each point since my map is at 400 x 400m resolution. 

```{r}
person<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_person_ignit_final.gpkg")

#lightning<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_lighting_ignit_final.gpkg")
```


Extract climate data for 2022 from climateBC.
I had to use predicted future climate data because the 2022 actual data is not up yet. Change this in the future maybe.
```{r}
# setwd("D:/Climatebc_v730"); # set the ClimateBC root directory as the working directory
# exe <- "ClimateBC_v7.30.exe"
# 
# ## 2021
# inputFile = '/C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\bc_dem_frt.csv' 
# outputFile = '/C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\bc_dem_frt_clim.csv'
# yearPeriod = '/Year_2021.ann'
# system2(exe,args= c('/M', yearPeriod, inputFile, outputFile))

x<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\bc_dem_frt_8GCMs_ensemble_ssp370_2022M.csv")

x<- x %>% rename(idno=ID1, frt=ID2) %>% 
  select(idno, frt, Tmax01:PPT12, RH01:RH12, DD18_01:DD18_12)
table(x$frt)

x$frt[x$frt==3]<-5
table(x$frt)

head(person)

person<- person %>% select(idno:Longitude, geom)

person$frt<-as.numeric(person$frt)
person_22a<-left_join(person, x)
# notes I think person_22a should work for both lightning and person ignitions.
```

Get climate variables and make climate1 and climate2 columns
```{r}
#If you need to open the table listing the top climate
climate_variables_lightning<-read.csv("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\climate_AIC_results_lightning_FRT_summary.csv")

climate_variables_lightning

 # Lightning caused fires
person_22a$mean_Tave05_Tave06_Tave07_Tave08 <- (person_22a$Tave05 + person_22a$Tave06 + person_22a$Tave07 + person_22a$Tave08)/4
person_22a$mean_PPT05_PPT06_PPT07_PPT08<-(person_22a$PPT05 + person_22a$PPT06 + person_22a$PPT07 + person_22a$PPT08)/4

person_22a$meanRH05_RH06_RH07<-(person_22a$RH05 + person_22a$RH06 + person_22a$RH07)/3

person_22a$mean_Tave07_Tave08_Tave09 <- (person_22a$Tave07 + person_22a$Tave08 + person_22a$Tave09)/3
person_22a$mean_PPT07_PPT08_PPT09<-(person_22a$PPT07 + person_22a$PPT08 + person_22a$PPT09)/3
person_22a$mean_Tmax07_Tmax08_Tmax09<-(person_22a$Tmax07 + person_22a$Tmax08 + person_22a$Tmax09)/3

person_22a$mean_Tmax07_Tmax08<-(person_22a$Tmax07 + person_22a$Tmax08)/2

person_22a$mean_Tave07_Tave08<- (person_22a$Tave07 + person_22a$Tave08)/2

person_22a$mean_Tave06_Tave07_Tave08 <- (person_22a$Tave06 + person_22a$Tave07 + person_22a$Tave08)/3
person_22a$mean_PPT06_PPT07_PPT08 <- (person_22a$PPT06 + person_22a$PPT07 + person_22a$PPT08)/3



person_22a$climate1<-"NA"
person_22a<-person_22a %>%
    mutate(climate1 = case_when(
                            frt == "5" ~ mean_Tave05_Tave06_Tave07_Tave08 ,
                            frt == "7" ~ meanRH05_RH06_RH07,
                            frt == "9" ~ Tmax05,
                            frt == "10" ~ mean_Tave07_Tave08_Tave09 ,
                            frt == "11" ~ mean_Tmax07_Tmax08_Tmax09,
                            frt == "12" ~ mean_Tmax07_Tmax08,
                            frt == "13" ~ Tave07,
                            frt == "14" ~ mean_Tave07_Tave08,
                            frt == "15" ~ mean_Tave06_Tave07_Tave08 ,
                            TRUE ~ NA_real_))

#Repeat for climate 2
person_22a$climate2<-"NA"
# # 

person_22a <- person_22a %>%
  mutate(climate2 = if_else(frt==5, mean_PPT05_PPT06_PPT07_PPT08,
                            if_else(frt==10, mean_PPT07_PPT08_PPT09,
                                    if_else(frt==11, mean_PPT07_PPT08_PPT09,
                                    if_else(frt==13, as.numeric(PPT07),
                                            if_else(frt==15, mean_PPT06_PPT07_PPT08, NA_real_))))))

# create dummy variables for FWI_veg
person_22a$veg_C1 <- ifelse(person_22a$FWI_veg == 'C-1', 1, 0)
person_22a$veg_C2 <- ifelse(person_22a$FWI_veg == 'C-2', 1, 0)
person_22a$veg_C3 <- ifelse(person_22a$FWI_veg == 'C-3', 1, 0)
person_22a$veg_C4 <- ifelse(person_22a$FWI_veg == 'C-4', 1, 0)
person_22a$veg_C5 <- ifelse(person_22a$FWI_veg == 'C-5', 1, 0)
person_22a$veg_C7 <- ifelse(person_22a$FWI_veg == 'C-7', 1, 0)
person_22a$veg_D12 <- ifelse(person_22a$FWI_veg == 'D-1/2', 1, 0)
person_22a$veg_M12 <- ifelse(person_22a$FWI_veg == 'M-1/2', 1, 0)
person_22a$veg_M3 <- ifelse(person_22a$FWI_veg == 'M-3', 1, 0)
person_22a$veg_N <- ifelse(person_22a$FWI_veg == 'N', 1, 0)
person_22a$veg_O1ab <- ifelse(person_22a$FWI_veg == 'O-1a/b', 1, 0)
person_22a$veg_S1 <- ifelse(person_22a$FWI_veg == 'S-1', 1, 0)
person_22a$veg_S2 <- ifelse(person_22a$FWI_veg == 'S-2', 1, 0)
person_22a$veg_S3 <- ifelse(person_22a$FWI_veg == 'S-3', 1, 0)
#person_22a$veg_W <- ifelse(person_22a$FWI_veg == 'W', 1, 0)

names(person_22a)
table(person_22a$frt, person_22a$FWI_veg)

#person_22a$frt[person_22a$frt==3]<-5

no_ignition1<-person_22a %>% 
  filter(FWI_veg =="W")

ignition1<-person_22a %>% 
  filter(FWI_veg !="W")

no_ignition2<-ignition1 %>% 
  filter(bclcs_level_5 %in% c("GL", "LA"))

no_ignition<-rbind(no_ignition1, no_ignition2)

ignition2<-ignition1 %>% 
  filter(!bclcs_level_5 %in% c("GL", "LA"))

dim(no_ignition)
```

# Create proability of ignition by lightning map for all of BC in 2022

```{r}
frt5<- ignition2 %>% filter(frt==5)
head(frt5)

table(frt5$FWI_veg)

frt5_na<-frt5 %>% filter(FWI_veg == "N")
frt5<-frt5 %>% filter(FWI_veg != "N")

#NOTE C-2 is the intercept
frt5$FWI_veg[frt5$FWI_veg=="C-5"]<-"C-7"
frt5$FWI_veg[frt5$FWI_veg=="C-4"]<-"C-2"
frt5$FWI_veg[frt5$FWI_veg=="S-1"]<-"M-1/2"
frt5$FWI_veg[frt5$FWI_veg=="S-2"]<-"C-7"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt5_lightning.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt5$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt5$climate2 +
  model_coef_table[[4]]*frt5$veg_C1 +
  model_coef_table[[5]]*frt5$veg_C3 +
  model_coef_table[[6]]*frt5$veg_C7 +
  model_coef_table[[7]]*frt5$veg_D12 +
  model_coef_table[[8]]*frt5$veg_M12 +
  model_coef_table[[9]]*frt5$veg_O1ab +
  model_coef_table[[10]]*frt5$elevation

head(frt5)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt5$prob_ignition<-exp(frt5$logit_P)/(1+exp(frt5$logit_P))

summary(frt5$prob_ignition)
hist(frt5$prob_ignition)

# Adding the veg_type = N back here. I removed the FWI_veg="N" because there was only 1 occurence of this veg type in the orignial model.
frt5_na$logit_P<-0
frt5_na$prob_ignition<-0

frt5<-rbind(frt5, frt5_na)

##################################
### FRT 7
frt7<- ignition2 %>% filter(frt==7)

table(frt7$FWI_veg)

frt7_na<-frt7 %>% filter(FWI_veg == "N")
frt7<-frt7 %>% filter(FWI_veg != "N")

#NOTE C-2 is the intercept
frt7$FWI_veg[frt7$FWI_veg=="C-4"]<-"C-2"
frt7$FWI_veg[frt7$FWI_veg=="C-5"]<-"M-1/2"
frt7$FWI_veg[frt7$FWI_veg=="C-7"]<-"M-1/2"
frt7$FWI_veg[frt7$FWI_veg=="S-1"]<-"M-1/2"
frt7$FWI_veg[frt7$FWI_veg=="S-2"]<-"M-1/2"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt7_lightning.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt7$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt7$climate1 +
  model_coef_table[[4]]*frt7$veg_C1 +
  model_coef_table[[5]]*frt7$veg_C3 +
  model_coef_table[[7]]*frt7$veg_D12 +
  model_coef_table[[8]]*frt7$veg_M12 +
  model_coef_table[[9]]*frt7$veg_O1ab

head(frt7)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt7$prob_ignition<-exp(frt7$logit_P)/(1+exp(frt7$logit_P))

summary(frt7$prob_ignition)
hist(frt7$prob_ignition)

# Adding the veg_type = N back here. I removed the FWI_veg="N" because there was only 1 occurence of this veg type in the orignial model.
frt7_na$logit_P<-0
frt7_na$prob_ignition<-0

frt7<-rbind(frt7, frt7_na)


######################################
### FRT 9

frt9<- ignition2 %>% filter(frt==9)

table(frt9$FWI_veg)
#NOTE C-3 is the intercept
frt9$FWI_veg[frt9$FWI_veg=="D-1/2"]<-"C-7"
frt9$FWI_veg[frt9$FWI_veg=="C-5"]<-"C-7"
frt9$FWI_veg[frt9$FWI_veg=="C-4"]<-"C-2"
frt9$FWI_veg[frt9$FWI_veg=="S-1"]<-"M-1/2"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt9_lightning.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt9$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt9$climate1 +
  model_coef_table[[4]]*frt9$veg_C1 +
  model_coef_table[[5]]*frt9$veg_C2 +
  model_coef_table[[6]]*frt9$veg_C7 +
  model_coef_table[[7]]*frt9$veg_M12 +
  model_coef_table[[8]]*frt9$veg_N +
  model_coef_table[[9]]*frt9$veg_O1ab +
  model_coef_table[[10]]*frt9$elevation

head(frt9)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt9$prob_ignition<-exp(frt9$logit_P)/(1+exp(frt9$logit_P))

summary(frt9$prob_ignition)
hist(frt9$prob_ignition)


######################################
### FRT 10

frt10<- ignition2 %>% filter(frt==10)

table(frt10$FWI_veg)
#NOTE C-2 is the intercept
frt10$FWI_veg[frt10$FWI_veg=="S-1"]<-"M-1/2"
frt10$FWI_veg[frt10$FWI_veg=="S-2"]<-"M-1/2"
frt10$FWI_veg[frt10$FWI_veg=="C-4"]<-"C-2"
frt10$FWI_veg[frt10$FWI_veg=="C-1"]<-"C-3"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT10_lightning.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt10$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt10$climate1 +
  model_coef_table[[4]]*frt10$climate2 +
  model_coef_table[[5]]*frt10$veg_C3 +
  model_coef_table[[6]]*frt10$veg_C5 +
  model_coef_table[[7]]*frt10$veg_C7 +
  model_coef_table[[8]]*frt10$veg_D12 +
  model_coef_table[[9]]*frt10$veg_M12 +
  model_coef_table[[10]]*frt10$veg_N +
  model_coef_table[[11]]*frt10$veg_O1ab +
  model_coef_table[[12]]*frt10$elevation

head(frt10)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt10$prob_ignition<-exp(frt10$logit_P)/(1+exp(frt10$logit_P))

summary(frt10$prob_ignition)
hist(frt10$prob_ignition)

#######################################
# FRT 11

frt11<- ignition2 %>% filter(frt==11)

#NOTE C-3 is the intercept
table(frt11$FWI_veg)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT11_lightning.csv")
model_coef_table

frt11$FWI_veg[frt11$FWI_veg=="C-5"]<-"C-7"
frt11$FWI_veg[frt11$FWI_veg=="D-1/2"]<-"C-7"
frt11$FWI_veg[frt11$FWI_veg=="S-1"]<-"M-1/2"
frt11$FWI_veg[frt11$FWI_veg=="S-2"]<-"M-1/2"
frt11$FWI_veg[frt11$FWI_veg=="S-3"]<-"M-1/2"
frt11$FWI_veg[frt11$FWI_veg=="O-1a/b"]<-"C-3"

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt11$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt11$climate1 +
  model_coef_table[[4]]*frt11$climate2 +
  model_coef_table[[5]]*frt11$veg_C1 +
  model_coef_table[[6]]*frt11$veg_C2 +
  model_coef_table[[7]]*frt11$veg_C7 +
  model_coef_table[[8]]*frt11$veg_M12 +
  model_coef_table[[9]]*frt11$veg_N

head(frt11)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt11$prob_ignition<-exp(frt11$logit_P)/(1+exp(frt11$logit_P))

summary(frt11$prob_ignition)
hist(frt11$prob_ignition)


#######################################
# FRT 12

frt12<- ignition2 %>% filter(frt==12)

#NOTE C-1 is the intercept
table(frt12$FWI_veg)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT12_lightning.csv")
model_coef_table

frt12$FWI_veg[frt12$FWI_veg=="S-3"]<-"S-1"

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt12$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt12$climate1 +
  model_coef_table[[4]]*frt12$veg_C2 +
  model_coef_table[[5]]*frt12$veg_C3 +
  model_coef_table[[6]]*frt12$veg_C4 +
  model_coef_table[[7]]*frt12$veg_C5 +
  model_coef_table[[8]]*frt12$veg_C7 +
  model_coef_table[[9]]*frt12$veg_D12 +
  model_coef_table[[10]]*frt12$veg_M12 +
  model_coef_table[[11]]*frt12$veg_M3 +
  model_coef_table[[12]]*frt12$veg_N +
  model_coef_table[[13]]*frt12$veg_O1ab +
  model_coef_table[[14]]*frt12$veg_S1 +
  model_coef_table[[15]]*frt12$veg_S2 + 
  model_coef_table[[16]]*frt12$elevation

head(frt12)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt12$prob_ignition<-exp(frt12$logit_P)/(1+exp(frt12$logit_P))

summary(frt12$prob_ignition)
hist(frt12$prob_ignition)

#############################################
# FRT 13

frt13<- ignition2 %>% filter(frt==13)

table(frt13$FWI_veg)
# NOTE C2 is the intercept
#frt13$FWI_veg[frt13$FWI_veg=="C-2"]<-"C-3"
frt13$FWI_veg[frt13$FWI_veg=="C-4"]<-"C-2"
frt13$FWI_veg[frt13$FWI_veg=="C-1"]<-"C-3"
frt13$FWI_veg[frt13$FWI_veg=="M-3"]<-"O-1a/b"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT13_lightning.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt13$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt13$climate1 +
  model_coef_table[[4]]*frt13$climate2 +
  model_coef_table[[5]]*frt13$veg_C3 +
  model_coef_table[[6]]*frt13$veg_C5 +
  model_coef_table[[7]]*frt13$veg_C7 +
  model_coef_table[[8]]*frt13$veg_D12 +
  model_coef_table[[9]]*frt13$veg_M12 +
  model_coef_table[[10]]*frt13$veg_N +
  model_coef_table[[11]]*frt13$veg_O1ab +
  model_coef_table[[12]]*frt13$veg_S1 +
  model_coef_table[[13]]*frt13$veg_S2 + 
  model_coef_table[[14]]*frt13$veg_S3 + 
  model_coef_table[[15]]*frt13$elevation

head(frt13)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt13$prob_ignition<-exp(frt13$logit_P)/(1+exp(frt13$logit_P))

summary(frt13$prob_ignition)

hist(frt13$prob_ignition)

########################################3
# FRT 14

frt14<- ignition2 %>% filter(frt==14)

table(frt14$FWI_veg)
# NOTE C-2 is the intercept
frt14$FWI_veg[frt14$FWI_veg=="C-4"]<-"C-2"
frt14$FWI_veg[frt14$FWI_veg=="S-2"]<-"M-1/2"
frt14$FWI_veg[frt14$FWI_veg=="S-3"]<-"M-1/2"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT14_lightning.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt14$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt14$climate1 +
  model_coef_table[[4]]*frt14$veg_C3 +
  model_coef_table[[5]]*frt14$veg_C5 +
  model_coef_table[[6]]*frt14$veg_C7 +
  model_coef_table[[7]]*frt14$veg_D12 +
  model_coef_table[[8]]*frt14$veg_M12 +
  model_coef_table[[9]]*frt14$veg_M3 +
  model_coef_table[[10]]*frt14$veg_N +
  model_coef_table[[11]]*frt14$veg_O1ab +
  model_coef_table[[12]]*frt14$veg_S1 

head(frt14)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt14$prob_ignition<-exp(frt14$logit_P)/(1+exp(frt14$logit_P))

summary(frt14$prob_ignition)
hist(frt14$prob_ignition)

#plot(frt14[frt14$prob_ignition,])


#######################################
# FRT 15

frt15<- ignition2 %>% filter(frt==15)
table(frt15$FWI_veg)
# C-3 is the intercept
frt15$FWI_veg[frt15$FWI_veg=="C-2"]<-"C-3" 
frt15$FWI_veg[frt15$FWI_veg=="O-1a/b"]<-"C-3" 



model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT15_lightning.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

# note climate 1 and elevation were correlated 0.76 so I removed climate 1 because the model without climate 1 but with elevation had a smaller AIC than the opposite
frt15$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt15$climate2 +
  model_coef_table[[4]]*frt15$veg_C5 +
  model_coef_table[[5]]*frt15$veg_C7 +
  model_coef_table[[6]]*frt15$veg_D12 +
  model_coef_table[[7]]*frt15$veg_M12 +
  model_coef_table[[8]]*frt15$veg_N +
  model_coef_table[[9]]*frt15$veg_S3 +
  model_coef_table[[10]]*frt15$elevation

head(frt15)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt15$prob_ignition<-exp(frt15$logit_P)/(1+exp(frt15$logit_P))

summary(frt15$prob_ignition)

hist(frt15$prob_ignition)
#plot(frt15[frt15$prob_ignition,])


#############################################
# Join all data together

frt_all<-rbind(rbind(rbind(rbind(rbind(rbind(rbind(rbind(frt10, frt12), frt13), frt14), frt15), frt9), frt11), frt5),frt7)

names(frt_all)
frtall<-frt_all %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5,FWI_veg:dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2, logit_P:geom)
names(no_ignition)
names(frtall)
no_ignition<-no_ignition %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5,FWI_veg:dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,geom)
no_ignition$logit_P<-0
no_ignition$prob_ignition<-0

frt_all2<-rbind(frtall, no_ignition)
hist(frt_all2$prob_ignition)

```

save the data
```{r}
st_write(frt_all2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_lighting_ignit_final_2022.gpkg", delete_layer=TRUE, driver="GPKG")

rm(frt10, frt11, frt12, frt13, frt14, frt15, frt5, frt7, frt9, frt5_na, frt7_na)
gc()
```

######################
# Probability of person caused fires for all of BC

```{r}
climate_variable<-read.csv("C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/climate_AIC_results_person_FRT_summary.csv")

# human caused fires

person_22b<-person_22a %>% select(!c(climate1, climate2))

person_22b$mean_PPT06_PPT07 <-(person_22b$PPT06 + person_22b$PPT07)/2

person_22b$mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave09_Tave10<-(person_22b$Tave04 + person_22b$Tave05 + person_22b$Tave06 + person_22b$Tave07 +person_22b$Tave08 + person_22b$Tave09 + person_22b$Tave10)/7

person_22b$mean_PPT06_PPT07_PPT08_PPT09 <- (person_22b$PPT06 + person_22b$PPT07 + person_22b$PPT08 + person_22b$PPT09)/4

person_22b$mean_Tave08_Tave09_Tave10<-(person_22b$Tave08 + person_22b$Tave09 + person_22b$Tave10)/3

person_22b$mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10<-(person_22b$Tmax04 + person_22b$Tmax05 + person_22b$Tmax06 + person_22b$Tmax07 +person_22b$Tmax08 + person_22b$Tmax09 + person_22b$Tmax10)/7

person_22b$mean_Tave07_Tave08_Tave09<-(person_22b$Tave07 +person_22b$Tave08 + person_22b$Tave09)/3

person_22b$mean_PPT07_PPT08_PPT09 <- (person_22b$PPT07 + person_22b$PPT08 + person_22b$PPT09)/3


person_22b<-person_22b %>%
    mutate(climate1 = case_when(
                                frt == "5" ~ as.numeric(mean_PPT06_PPT07),
                                frt == "7" ~ mean_Tave04_Tave05_Tave06_Tave07_Tave08_Tave09_Tave10,
                                frt == "9" ~ Tmax05, # NDT4
                                frt == "10" ~ mean_PPT06_PPT07_PPT08_PPT09,
                                frt == "11" ~ mean_Tave08_Tave09_Tave10,
                                frt == "12" ~ mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10,
                                frt == "13" ~ mean_Tave07_Tave08_Tave09,
                                frt == "14" ~ mean_Tmax04_Tmax05_Tmax06_Tmax07_Tmax08_Tmax09_Tmax10,
                                frt == "15" ~ mean_Tave07_Tave08_Tave09,
                               TRUE ~ NA_real_))

# #Repeat for climate 2
 person_22b$climate2<-"NA"
# 
# #Perform mutate to get the applicable variable for each row
person_22b<-person_22b %>%
    mutate(climate2 = case_when(
                                frt == "13" ~ as.numeric(mean_PPT07_PPT08_PPT09),
                                frt == "15" ~ as.numeric(mean_PPT07_PPT08_PPT09),
                               TRUE ~ NA_real_))

no_ignition1<-person_22b %>% 
  filter(FWI_veg =="W")

ignition1<-person_22b %>% 
  filter(FWI_veg !="W")

no_ignition2<-ignition1 %>% 
  filter(bclcs_level_5 %in% c("GL", "LA"))

no_ignition<-rbind(no_ignition1, no_ignition2)

ignition2<-ignition1 %>% 
  filter(!bclcs_level_5 %in% c("GL", "LA"))

dim(no_ignition)

```


```{r}
### FRT 5
frt5<- ignition2 %>% filter(frt==5)

# note vegetation got kicked out of the final model

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT5_person.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt5$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt5$climate1 +
  model_coef_table[[4]]*frt5$elevation +
  model_coef_table[[5]]*(log(frt5$dist_roads_m+1))+
  model_coef_table[[6]]*(log(frt5$dist_infrastructure_m+1))
  

head(frt5)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt5$prob_ignition<-exp(frt5$logit_P)/(1+exp(frt5$logit_P))

summary(frt5$prob_ignition)
hist(frt5$prob_ignition)

##################################
##FRT 7 

frt7<- ignition2 %>% filter(frt==7)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT7_person.csv")

model_coef_table

table(frt7$FWI_veg)

#NOTE C-1 is the intercept
frt7$FWI_veg[frt7$FWI_veg=="C-4"]<-"C-2"
frt7$FWI_veg[frt7$FWI_veg=="C-5"]<-"C-7"
frt7$FWI_veg[frt7$FWI_veg=="S-1"]<-"M-1/2"
frt7$FWI_veg[frt7$FWI_veg=="S-2"]<-"C-7"


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt7$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt7$climate1 +
  model_coef_table[[4]]*frt7$veg_C2 +
  model_coef_table[[5]]*frt7$veg_C3 +
  model_coef_table[[6]]*frt7$veg_C7 +
  model_coef_table[[7]]*frt7$veg_D12 +
  model_coef_table[[8]]*frt7$veg_M12 +
  model_coef_table[[9]]*frt7$veg_M3 +
  model_coef_table[[10]]*frt7$veg_N +
  model_coef_table[[11]]*frt7$veg_O1ab + 
  model_coef_table[[12]]*(log(frt7$dist_roads_m+1))+
  model_coef_table[[13]]*(log(frt7$dist_infrastructure_m+1))

head(frt7)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt7$prob_ignition<-exp(frt7$logit_P)/(1+exp(frt7$logit_P))

summary(frt7$prob_ignition)
hist(frt7$prob_ignition)


### FRT 9

frt9<- ignition2 %>% filter(frt==9)

# no FWI_veg in model

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt9_person.csv")

model_coef_table


# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt9$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt9$climate1 +
  model_coef_table[[4]]*frt9$elevation  +
  model_coef_table[[5]]*frt9$dist_infrastructure_m

head(frt9)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt9$prob_ignition<-exp(frt9$logit_P)/(1+exp(frt9$logit_P))

summary(frt9$prob_ignition)
hist(frt9$prob_ignition)


### FRT 10

frt10<- ignition2 %>% filter(frt==10)

table(frt10$FWI_veg)
#NOTE C-2 is the intercept
frt10$FWI_veg[frt10$FWI_veg=="C-1"]<-"C-3"
frt10$FWI_veg[frt10$FWI_veg=="C-4"]<-"C-2"
frt10$FWI_veg[frt10$FWI_veg=="M-1/2"]<-"C-5"
frt10$FWI_veg[frt10$FWI_veg=="O-1a/b"]<-"C-3"
frt10$FWI_veg[frt10$FWI_veg=="S-1"]<-"C-4"
frt10$FWI_veg[frt10$FWI_veg=="S-2"]<-"C-7"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT10_person.csv")

model_coef_table

#C-2 is the intercept
# put coefficients into model formula
#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk
frt10$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt10$climate1 +
  model_coef_table[[4]]*frt10$veg_C3 +
  model_coef_table[[5]]*frt10$veg_C5 +
  model_coef_table[[6]]*frt10$veg_C7 +
  model_coef_table[[7]]*frt10$veg_N +
  model_coef_table[[8]]*(log(frt10$dist_roads_m+1))

head(frt10)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt10$prob_ignition<-exp(frt10$logit_P)/(1+exp(frt10$logit_P))

summary(frt10$prob_ignition)
hist(frt10$prob_ignition)


# FRT 11

frt11<- ignition2 %>% filter(frt==11)

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_frt11_person.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt11$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt11$climate1 +
  model_coef_table[[4]]*log(frt11$dist_roads_m+1) +
  model_coef_table[[5]]*log(frt11$dist_infrastructure_m+1) 

head(frt11)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt11$prob_ignition<-exp(frt11$logit_P)/(1+exp(frt11$logit_P))

summary(frt11$prob_ignition)
hist(frt11$prob_ignition)



# FRT 12

frt12<- ignition2 %>% filter(frt==12)

#NOTE C-2 is the intercept
table(frt12$FWI_veg)
frt12$FWI_veg[frt12$FWI_veg=="C-1"]<-"C-3"
frt12$FWI_veg[frt12$FWI_veg=="C-4"]<-"C-2"
frt12$FWI_veg[frt12$FWI_veg=="M-3"]<-"O-1a/b"
frt12$FWI_veg[frt12$FWI_veg=="S-2"]<-"C-7"
frt12$FWI_veg[frt12$FWI_veg=="S-3"]<-"S-1"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT12_person.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt12$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt12$climate1 +
  model_coef_table[[4]]*frt12$elevation + 
  model_coef_table[[5]]*log(frt12$dist_roads_m+1) +
  model_coef_table[[6]]*log(frt12$dist_infrastructure_m+1) +
  model_coef_table[[7]]*frt12$veg_C3 +
  model_coef_table[[8]]*frt12$veg_C5 +
  model_coef_table[[9]]*frt12$veg_C7 +
  model_coef_table[[10]]*frt12$veg_D12 +
  model_coef_table[[11]]*frt12$veg_M12 +
  model_coef_table[[12]]*frt12$veg_N +
  model_coef_table[[13]]*frt12$veg_O1ab +
  model_coef_table[[14]]*frt12$veg_S1 
  

head(frt12)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt12$prob_ignition<-exp(frt12$logit_P)/(1+exp(frt12$logit_P))

summary(frt12$prob_ignition)
hist(frt12$prob_ignition)


# FRT 13

frt13<- ignition2 %>% filter(frt==13)

table(frt13$FWI_veg)
# NOTE C2 is the intercept
#frt13$FWI_veg[frt13$FWI_veg=="C-2"]<-"C-3"
frt13$FWI_veg[frt13$FWI_veg=="C-4"]<-"C-2"
frt13$FWI_veg[frt13$FWI_veg=="C-1"]<-"C-3"
frt13$FWI_veg[frt13$FWI_veg=="S-2"]<-"C-7"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT13_person.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt13$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt13$climate1 +
  model_coef_table[[4]]*frt13$climate2 +
  model_coef_table[[5]]*frt13$elevation + 
  model_coef_table[[6]]*log(frt13$dist_roads_m+1) +
  model_coef_table[[7]]*log(frt13$dist_infrastructure_m+1) +
  model_coef_table[[8]]*frt13$veg_C3 +
  model_coef_table[[9]]*frt13$veg_C5 +
  model_coef_table[[10]]*frt13$veg_C7 +
  model_coef_table[[11]]*frt13$veg_D12 +
  model_coef_table[[12]]*frt13$veg_M12 +
  model_coef_table[[13]]*frt13$veg_M3 +
  model_coef_table[[14]]*frt13$veg_N +
  model_coef_table[[15]]*frt13$veg_O1ab +
  model_coef_table[[16]]*frt13$veg_S1 +
  model_coef_table[[17]]*frt13$veg_S3 

head(frt13)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt13$prob_ignition<-exp(frt13$logit_P)/(1+exp(frt13$logit_P))

summary(frt13$prob_ignition)

hist(frt13$prob_ignition)


# FRT 14

frt14<- ignition2 %>% filter(frt==14)

table(frt14$FWI_veg)
# NOTE C-2 is the intercept
frt14$FWI_veg[frt14$FWI_veg=="C-4"]<-"C-2"
frt14$FWI_veg[frt14$FWI_veg=="M-3"]<-"O-1a/b" 
frt14$FWI_veg[frt14$FWI_veg=="S-3"]<-"S-1"

model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT14_person.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

frt14$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt14$climate1 +
  model_coef_table[[4]]*log(frt14$dist_roads_m+1) +
  model_coef_table[[5]]*log(frt14$dist_infrastructure_m+1) +
  model_coef_table[[6]]*frt14$veg_C3 +
  model_coef_table[[7]]*frt14$veg_C5 +
  model_coef_table[[8]]*frt14$veg_C7 +
  model_coef_table[[9]]*frt14$veg_D12 +
  model_coef_table[[10]]*frt14$veg_M12 +
  model_coef_table[[11]]*frt14$veg_N +
  model_coef_table[[12]]*frt14$veg_O1ab +
  model_coef_table[[13]]*frt14$veg_S1 

head(frt14)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt14$prob_ignition<-exp(frt14$logit_P)/(1+exp(frt14$logit_P))

summary(frt14$prob_ignition)
hist(frt14$prob_ignition)

#plot(frt14[frt14$prob_ignition,])


# FRT 15

frt15<- ignition2 %>% filter(frt==15)
table(frt15$FWI_veg)
# C-3 is the intercept
frt15$FWI_veg[frt15$FWI_veg=="C-2"]<-"C-3" 
frt15$FWI_veg[frt15$FWI_veg=="C-7"]<-"C-5" 
frt15$FWI_veg[frt15$FWI_veg=="S-1"]<-"S-3" 



model_coef_table<-read.csv("D:\\Fire\\fire_data\\raw_data\\top_mod_table_FRT15_person.csv")
model_coef_table

#logit(p) = b0+b1X1+b2X2+b3X3….+bkXk

# note climate 1 and elevation were correlated 0.76 so I removed climate 1 because the model without climate 1 but with elevation had a smaller AIC than the opposite
frt15$logit_P<- model_coef_table[[2]] + 
  model_coef_table[[3]]*frt15$climate1 +
  model_coef_table[[4]]*frt15$climate2 +
   model_coef_table[[5]]*log(frt15$dist_roads_m+1) +
  model_coef_table[[6]]*frt15$dist_infrastructure_m +
  model_coef_table[[7]]*frt15$veg_C5 +
  model_coef_table[[8]]*frt15$veg_D12 +
  model_coef_table[[9]]*frt15$veg_M12 +
  model_coef_table[[10]]*frt15$veg_N +
  model_coef_table[[11]]*frt15$veg_O1ab +
  model_coef_table[[12]]*frt15$veg_S3

head(frt15)
# y = e^(b0 + b1*x) / (1 + e^(b0 + b1*x))
frt15$prob_ignition<-exp(frt15$logit_P)/(1+exp(frt15$logit_P))

summary(frt15$prob_ignition)

hist(frt15$prob_ignition)
#plot(frt15[frt15$prob_ignition,])


frt_all<-rbind(rbind(rbind(rbind(rbind(rbind(rbind(rbind(frt10, frt12), frt13), frt14), frt15), frt9), frt11), frt5),frt7)

names(frt_all)
frtall<-frt_all %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5,FWI_veg:dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2, logit_P:geom)
names(no_ignition)
names(frtall)
no_ignition<-no_ignition %>% dplyr::select(idno:elevation, bclcs_level_4, bclcs_level_5,FWI_veg:dist_roads_m, dist_infrastructure_m:Tmax12, Tave01:RH12, climate1, climate2,geom)
no_ignition$logit_P<-0
no_ignition$prob_ignition<-0

frt_all2<-rbind(frtall, no_ignition)
hist(frt_all2$prob_ignition)

rm(frt5, frt5_na, frt7, frt7_na, frt9, frt10, frt11, frt12, frt13, frt14, frt15, no_ignition, no_ignition1, no_ignition2, x)
gc()

```

save the data
```{r}
st_write(frt_all2, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\BC_person_ignit_2022.gpkg", delete_layer=TRUE, driver="GPKG")

```

# Overlay proability of lightning ignition on probability of human ignition and create single map of proability of ignition from both.
```{r}
lightning_ignition<-raster(" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_lightning_ignit_2022.tif")
human_ignition<-raster(" C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_human_ignit_2022.tif")

# assign negative values (no data values) NA
lightning_ignition <- reclassify(lightning_ignition, cbind(-Inf, -1, NA), right=FALSE)
human_ignition <- reclassify(human_ignition, cbind(-Inf, -1, NA), right=FALSE)

total.ignit <- (lightning_ignition * (1-human_ignition)) + (human_ignition * (1-lightning_ignition))

plot(total.ignit, col=rev(heat.colors(255)))

# run this in R:
paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_lightning_ignit_2022.tif -t 400x400 rast.prob_lightning_ignit_bc_2022 | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/castor')
# then copy the output thats between the " " from the above and paste it into the cmd and run that... should show Insert 0  1 lots of times.

paste0('raster2pgsql -s 3005 -d -I -C -M -N 2147483648  ', 'C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\rast_human_ignit_2022.tif -t 400x400 rast.prob_human_ignit_bc_2022 | psql postgres://', keyring::key_get('dbuser', keyring = 'postgreSQL'), ':', keyring::key_get('dbpass', keyring = 'postgreSQL'), '@', keyring::key_get('dbhost', keyring = 'postgreSQL'), ':5432/clus')


```


# Predict RSF values and reclassify pixels into ordinal classes or rank bins of a specified number
```{r}
x<- as.data.frame(total.ignit)
hist(x$layer)

bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)
hist(x$layer, breaks=c(0, 0.1269326, 0.1959398, 0.2403519, 0.2758387, 0.3081048, 0.3397820, 0.3772622, 0.4259310, 0.4935676, 0.9)) # I dont believe this is working properly
# 
# y<-x %>% mutate(x_bin = ntile(layer, n=10))
# table(y$x_bin)

y_alt<-x %>% mutate(x_bin = cut(layer, breaks=10))
#y_alt2<-x%>% mutate(x_bin = cut(layer, breaks =c(0, 0.1269326, 0.1959398, 0.2403519, 0.2758387, 0.3081048, 0.3397820, 0.3772622, 0.4259310, 0.4935676, 1.0))) # This method uses the quantiles identified above.

table(y_alt$x_bin)

y <- y_alt %>% drop_na()
plot(y$x_bin)


y2<-as.data.frame(table(y$x_bin))

# determine midpoints of each bin

w_1<-0.0894/2
w_2<-(0.0894+(0.179-0.0894)/2)
w_3<-(0.179+ (0.268-0.179)/2)
w_4<-0.268 + (0.358-0.268)/2
w_5<-0.358 + (0.447-0.358)/2
w_6<-0.447 + (0.536-0.447)/2
w_7<-0.536 + (0.626-0.536)/2
w_8<-0.626 + (0.715-0.626)/2
w_9<-0.715 + (0.805-0.715)/2
w_10<-0.805 + (0.895-0.805)/2

y2$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2$wi_Ai<- y2$midpoint * y2$Freq
y2$Ui<- y2$wi_Ai/sum(y2$wi_Ai)
y2<- y2 %>% rename(bins=Var1,
                   Area = Freq)
plot(y2$bins, y2$Area)
```



## Getting data from an independent data set
# 6.) Count the number of used observations from an independent data set that fall in each RSF bin. 

For this I will extract the probability of ignition points from my fire map at each of the points

```{r ignitions}

ignit<-try(
  bcdc_query_geodata("WHSE_LAND_AND_NATURAL_RESOURCE.PROT_CURRENT_FIRE_PNTS_SP") %>%    
    filter(FIRE_TYPE == "Fire") %>%
    collect()
)

# first join the ignition points to frt so that I can see whether different frt react differently i.e. whether some are better than others.
frt <- st_read ( dsn = "D:\\Fire\\fire_data\\Fire_Regime_Types\\FRT\\FRT_Canada.shp", stringsAsFactors = T) # Read simple features from file or person_22aabase, or retrieve layer names and their geometry type(s)
st_crs(frt) #Retrieve coordinate reference system from sf or sfc object
frt<-st_transform(frt, 3005) #transform coordinate system to 3005 - that for BC, Canada

#get provincial boundary for clipping the layers to the area of interest
prov.bnd <- st_read ( dsn = "T:\\FOR\\VIC\\HTS\\ANA\\PROJECTS\\CASTOR\\Data\\admin_boundaries\\province\\gpr_000b11a_e.shp", stringsAsFactors = T) # Read simple features from file or database, or retrieve layer names and their geometry type(s)
st_crs(prov.bnd) #Retrieve coordinate reference system from sf or sfc object
prov.bnd <- prov.bnd [prov.bnd$PRENAME == "British Columbia", ] 
crs(prov.bnd)# this one needs to be transformed to 3005
bc.bnd <- st_transform (prov.bnd, 3005) #Transform coordinate system
st_crs(bc.bnd)

#Clip FRT here
frt_clipped<-st_intersection(bc.bnd, frt)
#plot(st_geometry(frt_clipped), col=sf.colors(10,categorical=TRUE))
length(unique(frt_clipped$Cluster))
frt_sf<-st_as_sf(frt_clipped)

fire.ignt.frt <- st_join(ignit, frt_clipped)
table(fire.ignt.frt$Cluster)
table(is.na(fire.ignt.frt$Cluster))

# change any ignition points in FRT =3 to frt=5
fire.ignt.frt$Cluster[fire.ignt.frt$Cluster ==3] <- 5
```

# now extract the probability of ignition from the raster at each ignition point.

```{r}
fire.ignt.frt2 <- fire.ignt.frt %>%
  dplyr::select("id", "FIRE_NUMBER", "FIRE_YEAR", "IGNITION_DATE", "FIRE_CAUSE", "LATITUDE", "LONGITUDE","CURRENT_SIZE", "Cluster","geometry")

raster::crs(total.ignit) <- "EPSG:3005"

test<-cbind(fire.ignt.frt2, st_coordinates(fire.ignt.frt2))
head(test)

pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe

##Extract DEM values from stacked layer
rasValue2=raster::extract(total.ignit, pointCoordinates)
head(rasValue2)
str(rasValue2) #200298 values
str(fire.ignt.frt2)#200298 values

#Append new information
fire.ignt.frt3<-cbind(fire.ignt.frt2, rasValue2)
head(fire.ignt.frt3)

fire.ignt.frt3<-fire.ignt.frt3 %>% mutate(points_bin = cut(rasValue2, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))
table(fire.ignt.frt3$points_bin)
table(is.na(fire.ignt.frt3$points_bin))

#hist(fire.ignt.frt3$rasValue2, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0)) # I dont believe this is doing this correctly

y3<-as.data.frame(table(fire.ignt.frt3$points_bin))
y2$used_obs<-y3$Freq

plot(y2$bins, y2$used_obs)

y2$expected_no_obs<-sum(y2$used_obs)*y2$Ui

ggplot(data=y2) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2$prop_used<-y2$used_obs/(sum(y2$used_obs))
y2$prop_expected<-y2$expected_no_obs/(sum(y2$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2)
anova(relationship.fit)
summary(relationship.fit)
confint(relationship.fit) # The confidence interval overlaps 0 and the slope overlaps 1. I assume there is no statistical difference from what I would expect

Xsq<-chisq.test(y2$used_obs, p=y2$prop_expected, simulate.p.value = TRUE)  
Xsq

#Chi-squared test for given probabilities with simulated p-value (based on
#	2000 replicates)

#data:  y2$used_obs
#X-squared = 96.4, df = NA, p-value = 0.0004998

Xsq$observed   # observed counts 
Xsq$expected   # expected counts under the null
Xsq$residuals  # Pearson residuals
Xsq$stdres     # standardized residuals

# looks like there are more zero values than predicted. 


# plot(y2$prop_expected, y2$prop_used, xlim=c(0,0.18), ylim=c(0, 0.18))
# abline(0,1)
# abline(relationship.fit$coefficients[1], relationship.fit$coefficients[2], col="blue", lw=2)
lm_eqn <- function(df){
    m <- lm(y ~ x, df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

y3<-y2 %>% select(prop_used, prop_expected)

lm_eqn(y3)


p_bc <- ggplot(data=y2, aes(x=prop_expected, y=prop_used),label = lm_eqn(y2), parse = TRUE) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_bc

# looks like intercept  is close to zero and slope is close to 1 but chisqr test is singnifcant. 

# Take home ignition points happen at the same proportion as their predicted probabilities. ie.my model is close to the probability of use. When I look at it across the entire province. Now what about specific FRT's

# now see if any specific bins differ from predicted proportion of use - TO DO



```

##Now lets test the same thing but within each frt
Steps 
1. clip out frt from fire ignition map. 
2. calculate proporion of each binned category
3. extract observed values and determine number in each category.
4. do stats 
5. look at whether some frt's respond differently to others. Which are better, which are worse.

QUESTION: should I create new bins in each FRT or should I use the province wide ones? Does it matter?
I probably want the same bins so that I can compare between regions and have points at the same midpoint value. Although, my midpoint values are on a line and so maybe its does not matter. 

# Current problem How to merge FRT3 and FRT 5

# FRT 5
```{r}

# first work out proportion of habitat types across the landscape
frt5<-frt_clipped %>% filter(Cluster %in% c(3,5))
frt5<-sf::st_as_sf(frt5) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(total.ignit, extent(frt5))
r3 <- mask(r2, frt5)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer, breaks=c(0, 0.125, 0.2, 0.24, 0.28, 0.31, 0.34, 0.38, 0.43,0.5, 1.0))

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt5<-as.data.frame(table(y$points_bin))

y2_frt5$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt5$wi_Ai<- y2_frt5$midpoint * y2_frt5$Freq
y2_frt5$Ui<- y2_frt5$wi_Ai/sum(y2_frt5$wi_Ai)
y2_frt5<- y2_frt5 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in FRT5
## Start here!

frt5_ignit<-fire.ignt.frt3 %>% filter(Cluster==5)

y3_frt5<-as.data.frame(table(frt5_ignit$points_bin))
y2_frt5$used_obs<-y3_frt5$Freq

y2_frt5$expected_no_obs<-sum(y2_frt5$used_obs)*y2_frt5$Ui

ggplot(data=y2_frt5) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt5$prop_used<-y2_frt5$used_obs/(sum(y2_frt5$used_obs))
y2_frt5$prop_expected<-y2_frt5$expected_no_obs/(sum(y2_frt5$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt5)
anova(relationship.fit)
summary(relationship.fit) # slope looks close to 1 and intercept is at 0


p_frt5 <- ggplot(data=y2_frt5, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt5

Xsq<-chisq.test(y2_frt5$used_obs, p=y2_frt5$prop_expected, simulate.p.value = TRUE)  
Xsq

# Chi-squared test for given probabilities with simulated p-value (based on
# 	2000 replicates)
# 
# data:  y2_frt5$used_obs
# X-squared = 3.8941, df = NA, p-value = 0.7166
Xsq$residuals  # Pearson residuals

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# conclusion for this FRT. intercept is not different to zero and slope is not different than 1. GOOD
```

# FRT 7
```{r}
frt7<-frt_clipped %>% filter(Cluster == 7)
plot(frt7)
frt7<-sf::st_as_sf(frt7) %>% st_combine() %>% st_sf() #flatten layer


r2 <- crop(total.ignit, extent(frt7))
r3 <- mask(r2, frt7)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)
hist(x$layer, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895))

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt7<-as.data.frame(table(y$points_bin))

y2_frt7$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt7$wi_Ai<- y2_frt7$midpoint * y2_frt7$Freq
y2_frt7$Ui<- y2_frt7$wi_Ai/sum(y2_frt7$wi_Ai)
y2_frt7<- y2_frt7 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt7
## Start here!

frt7_ignit<-fire.ignt.frt3 %>% filter(Cluster==7)
head(frt7_ignit)

frt7_ignit<-frt7_ignit %>% mutate(points_bin = cut(rasValue2, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

y3<-as.data.frame(table(frt7_ignit$points_bin))
y2_frt7$used_obs<-y3$Freq

y2_frt7$expected_no_obs<-sum(y2_frt7$used_obs)*y2$Ui

ggplot(data=y2_frt7) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt7$prop_used<-y2_frt7$used_obs/(sum(y2_frt7$used_obs))
y2_frt7$prop_expected<-y2_frt7$expected_no_obs/(sum(y2_frt7$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt7)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt7 <- ggplot(data=y2_frt7, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt7

Xsq<-chisq.test(y2_frt7$used_obs, p=y2_frt7$prop_expected, simulate.p.value = TRUE)  
Xsq

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# intercept is not different to zero but note that slope overlaps both zero and 1 i.e. confidence intervals are huge. Slope is 0.5842
```

# FRT 9
```{r}
frt9<-frt_clipped %>% filter(Cluster == 9)
#plot(frt9)
frt9<-sf::st_as_sf(frt9) %>% st_combine() %>% st_sf() #flatten layer


r2 <- crop(total.ignit, extent(frt9))
r3 <- mask(r2, frt9)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(-0.01, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt9<-as.data.frame(table(y$points_bin))

y2_frt9$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt9$wi_Ai<- y2_frt9$midpoint * y2_frt9$Freq
y2_frt9$Ui<- y2_frt9$wi_Ai/sum(y2_frt9$wi_Ai)
y2_frt9<- y2_frt9 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt9
## Start here!

frt9_ignit<-fire.ignt.frt3 %>% filter(Cluster==9)
head(frt9_ignit)

y3<-as.data.frame(table(frt9_ignit$points_bin))
y2_frt9$used_obs<-y3$Freq

y2_frt9$expected_no_obs<-sum(y2_frt9$used_obs)*y2$Ui

ggplot(data=y2_frt9) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt9$prop_used<-y2_frt9$used_obs/(sum(y2_frt9$used_obs))
y2_frt9$prop_expected<-y2_frt9$expected_no_obs/(sum(y2_frt9$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt9)
anova(relationship.fit)
summary(relationship.fit) 

p_frt9 <- ggplot(data=y2_frt9, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt9

Xsq<-chisq.test(y2_frt9$used_obs, p=y2_frt9$prop_expected, simulate.p.value = TRUE)  
Xsq

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# my slope is significantly different to zero but not significantly differetn from 1. my intercept is not significantly different to zero GOOD!

```

# FRT 10
```{r}
frt10<-frt_clipped %>% filter(Cluster == 10)
#plot(frt10)
frt10<-sf::st_as_sf(frt10) %>% st_combine() %>% st_sf() #flatten layer


r2 <- crop(total.ignit, extent(frt10))
r3 <- mask(r2, frt10)
plot(r3)

x<- as.data.frame(r3)
#hist(x$layer)
x <- x %>% drop_na()

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)
y <- x2 %>% drop_na()

y2_frt10<-as.data.frame(table(y$points_bin))

y2_frt10$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt10$wi_Ai<- y2_frt10$midpoint * y2_frt10$Freq
y2_frt10$Ui<- y2_frt10$wi_Ai/sum(y2_frt10$wi_Ai)
y2_frt10<- y2_frt10 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt10
## Start here!

frt10_ignit<-fire.ignt.frt3 %>% filter(Cluster==10)
head(frt10_ignit)

y3<-as.data.frame(table(frt10_ignit$points_bin))
y2_frt10$used_obs<-y3$Freq

y2_frt10$expected_no_obs<-sum(y2_frt10$used_obs)*y2$Ui

ggplot(data=y2_frt10) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt10$prop_used<-y2_frt10$used_obs/(sum(y2_frt10$used_obs))
y2_frt10$prop_expected<-y2_frt10$expected_no_obs/(sum(y2_frt10$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt10)
anova(relationship.fit)
summary(relationship.fit) 

p_frt10 <- ggplot(data=y2_frt10, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt10

Xsq<-chisq.test(y2_frt10$used_obs, p=y2_frt10$prop_expected, simulate.p.value = TRUE)  
Xsq

# 	Chi-squared test for given probabilities with simulated p-value (based on
# 	2000 replicates)
# 
# data:  y2_frt10$used_obs
# X-squared = 54.932, df = NA, p-value = 0.0009995

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

# outcome: slope significantly different to zero but not to 1 and intercept is not significantly different to zero. GOOD
```


# FRT 11
```{r}
frt11<-frt_clipped %>% filter(Cluster == 11)
frt11<-sf::st_as_sf(frt11) %>% st_combine() %>% st_sf() #flatten layer


r2 <- crop(total.ignit, extent(frt11))
r3 <- mask(r2, frt11)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

y <- x2 %>% drop_na()

y2_frt11<-as.data.frame(table(y$points_bin))

y2_frt11$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt11$wi_Ai<- y2_frt11$midpoint * y2_frt11$Freq
y2_frt11$Ui<- y2_frt11$wi_Ai/sum(y2_frt11$wi_Ai)
y2_frt11<- y2_frt11 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt11
## Start here!

frt11_ignit<-fire.ignt.frt3 %>% filter(Cluster==11)
head(frt11_ignit)

y3<-as.data.frame(table(frt11_ignit$points_bin))
y2_frt11$used_obs<-y3$Freq

y2_frt11$expected_no_obs<-sum(y2_frt11$used_obs)*y2$Ui

ggplot(data=y2_frt11) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt11$prop_used<-y2_frt11$used_obs/(sum(y2_frt11$used_obs))
y2_frt11$prop_expected<-y2_frt11$expected_no_obs/(sum(y2_frt11$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt11)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt11 <- ggplot(data=y2_frt11, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt11

Xsq<-chisq.test(y2_frt11$used_obs, p=y2_frt11$prop_expected, simulate.p.value = TRUE)  
Xsq

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test


```

# FRT 12
```{r}
frt12<-frt_clipped %>% filter(Cluster == 12)
frt12<-sf::st_as_sf(frt12) %>% st_combine() %>% st_sf() #flatten layer
r2 <- crop(total.ignit, extent(frt12))
r3 <- mask(r2, frt12)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt12<-as.data.frame(table(y$points_bin))

# determine midpoint of each bin
y2_frt12$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt12$wi_Ai<- y2_frt12$midpoint * y2_frt12$Freq
y2_frt12$Ui<- y2_frt12$wi_Ai/sum(y2_frt12$wi_Ai)
y2_frt12<- y2_frt12 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt12
## Start here!

frt12_ignit<-fire.ignt.frt3 %>% filter(Cluster==12)
head(frt12_ignit)

y3<-as.data.frame(table(frt12_ignit$points_bin))
y2_frt12$used_obs<-y3$Freq

y2_frt12$expected_no_obs<-sum(y2_frt12$used_obs)*y2$Ui

ggplot(data=y2_frt12) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt12$prop_used<-y2_frt12$used_obs/(sum(y2_frt12$used_obs))
y2_frt12$prop_expected<-y2_frt12$expected_no_obs/(sum(y2_frt12$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt12)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt12 <- ggplot(data=y2_frt12, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt12

Xsq<-chisq.test(y2_frt12$used_obs, p=y2_frt12$prop_expected, simulate.p.value = TRUE)  
Xsq

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test
```

# FRT 13
```{r}
frt13<-frt_clipped %>% filter(Cluster == 13)
frt13<-sf::st_as_sf(frt13) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(total.ignit, extent(frt13))
r3 <- mask(r2, frt13)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))
#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)
y <- x2 %>% drop_na()

y2_frt13<-as.data.frame(table(y$points_bin))

y2_frt13$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt13$wi_Ai<- y2_frt13$midpoint * y2_frt13$Freq
y2_frt13$Ui<- y2_frt13$wi_Ai/sum(y2_frt13$wi_Ai)
y2_frt13<- y2_frt13 %>% rename(bins=Var1,
                   Area = Freq)

# now extract probabilty of ignition from fires points in frt13
## Start here!

frt13_ignit<-fire.ignt.frt3 %>% filter(Cluster==13)

y3<-as.data.frame(table(frt13_ignit$points_bin))
y2_frt13$used_obs<-y3$Freq

y2_frt13$expected_no_obs<-sum(y2_frt13$used_obs)*y2$Ui

ggplot(data=y2_frt13) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt13$prop_used<-y2_frt13$used_obs/(sum(y2_frt13$used_obs))
y2_frt13$prop_expected<-y2_frt13$expected_no_obs/(sum(y2_frt13$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt13)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt13 <- ggplot(data=y2_frt13, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt13

Xsq<-chisq.test(y2_frt13$used_obs, p=y2_frt13$prop_expected, simulate.p.value = TRUE)  
Xsq

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test

```


# FRT 14
```{r}
frt14<-frt_clipped %>% filter(Cluster == 14)
frt14<-sf::st_as_sf(frt14) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(total.ignit, extent(frt14))
r3 <- mask(r2, frt14)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)

x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

y <- x2 %>% drop_na()

y2_frt14<-as.data.frame(table(y$points_bin))
y2_frt14$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt14$wi_Ai<- y2_frt14$midpoint * y2_frt14$Freq
y2_frt14$Ui<- y2_frt14$wi_Ai/sum(y2_frt14$wi_Ai)
y2_frt14<- y2_frt14 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt14
## Start here!

frt14_ignit<-fire.ignt.frt3 %>% filter(Cluster==14)
y3<-as.data.frame(table(frt14_ignit$points_bin))
y2_frt14$used_obs<-y3$Freq

y2_frt14$expected_no_obs<-sum(y2_frt14$used_obs)*y2$Ui

ggplot(data=y2_frt14) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt14$prop_used<-y2_frt14$used_obs/(sum(y2_frt14$used_obs))
y2_frt14$prop_expected<-y2_frt14$expected_no_obs/(sum(y2_frt14$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt14)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt14 <- ggplot(data=y2_frt14, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt14

Xsq<-chisq.test(y2_frt14$used_obs, p=y2_frt14$prop_expected, simulate.p.value = TRUE)  
Xsq

Xsq$observed   # observed counts 
Xsq$expected   # expected counts under the null
Xsq$residuals  # Pearson residuals

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test
```

# FRT 15
```{r}
frt15<-frt_clipped %>% filter(Cluster == 15)
frt15<-sf::st_as_sf(frt15) %>% st_combine() %>% st_sf() #flatten layer

r2 <- crop(total.ignit, extent(frt15))
r3 <- mask(r2, frt15)
plot(r3)

x<- as.data.frame(r3)
hist(x$layer)
x2<-x %>% mutate(points_bin = cut(layer, breaks=c(0, 0.0894, 0.179, 0.268, 0.358, 0.447, 0.536, 0.626, 0.715, 0.805, 0.895)))

#bins<-quantile(x$layer, probs = seq(0, 1, 1/10), na.rm=TRUE)

y <- x2 %>% drop_na()

y2_frt15<-as.data.frame(table(y$points_bin))
y2_frt15$midpoint<-c(w_1, w_2, w_3, w_4, w_5, w_6, w_7, w_8, w_9, w_10)
y2_frt15$wi_Ai<- y2_frt15$midpoint * y2_frt15$Freq
y2_frt15$Ui<- y2_frt15$wi_Ai/sum(y2_frt15$wi_Ai)
y2_frt15<- y2_frt15 %>% rename(bins=Var1,
                   Area = Freq)


# now extract probabilty of ignition from fires points in frt15
## Start here!

frt15_ignit<-fire.ignt.frt3 %>% filter(Cluster==15)
y3<-as.data.frame(table(frt15_ignit$points_bin))
y2_frt15$used_obs<-y3$Freq

y2_frt15$expected_no_obs<-sum(y2_frt15$used_obs)*y2$Ui

ggplot(data=y2_frt15) +
  geom_line(aes(midpoint, used_obs), col="red") +
  geom_line(aes(midpoint, expected_no_obs), col="blue")

y2_frt15$prop_used<-y2_frt15$used_obs/(sum(y2_frt15$used_obs))
y2_frt15$prop_expected<-y2_frt15$expected_no_obs/(sum(y2_frt15$expected_no_obs))

relationship.fit<-lm(prop_used~prop_expected, data=y2_frt15)
anova(relationship.fit)
summary(relationship.fit) # Hmm this is not good! my intercept is somewhat close to 0 but my slope is pretty much zero. HMMMMMM!

p_frt15 <- ggplot(data=y2_frt15, aes(x=prop_expected, y=prop_used)) +
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) + 
  geom_abline(slope =1, intercept=0, linetype=2, size = 0.5)
p_frt15

Xsq<-chisq.test(y2_frt15$used_obs, p=y2_frt15$prop_expected, simulate.p.value = TRUE)  
Xsq

Xsq$observed   # observed counts 
Xsq$expected   # expected counts under the null
Xsq$residuals  # Pearson residuals

my.slope <- summary(relationship.fit)$coef["prop_expected", c("Estimate", "Std. Error")]
my.df <- summary(relationship.fit)$df[2]
t_value_zero <- my.slope["Estimate"] / my.slope["Std. Error"] # tests if the slope is different to zero
2*pt(t_value_zero, df=my.df, lower.tail=(t_value_zero<0)) # two sided test
summary(relationship.fit)
t_value_one <- (my.slope["Estimate"] - 1) / my.slope["Std. Error"] # tests if slope different to 1
2*pt(t_value_one, df=my.df, lower.tail=(t_value_one<0)) # two sided test
```

```{r}
library(ggpubr)

p_bc

ggarrange(#p_bc, 
          p_frt5,
          p_frt7,
          p_frt9,
          p_frt10,
          p_frt11,
          p_frt12,
          p_frt13,
          p_frt14,
          p_frt15 + rremove("x.text"), 
          labels = c("FRT 5", "FRT 7", "FRT 9", "FRT 10", "FRT 11", "FRT 12", "FRT 13", "FRT 14", "FRT15"),
          ncol = 3, nrow = 3)
```
