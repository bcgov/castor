---
title: "06_Fire_spread_model_fits_by_FRT_data_prep"
author: "Elizabeth Kleynhans and Cora Skaien"
contributor: "Peter Ott"
date: "20/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

THINGS TO CHECK!!
1.) when I create the following table (table(frt10$fire_label, frt10$pttype)) I get some zeros in the 0 or 1 column. In otherwords there are fires where I either have no land burnt or I have sampled burnt areas but no surrounding unburned areas. This is concerning since I think I tried not to do this. I must check what is going on.!!! 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library (kableExtra)
library (data.table)
library (DBI)
library (RPostgreSQL)
library (dplyr)
library (ggplot2)
library (here)
library(ggpubr)
library(arm)
library(tidyr)
library(AICcmodavg)
library(keyring)
library(caret)
library(pROC)
library(rje)
library(sf)
library(car)
library(ape)

source(here::here("R/functions/R_Postgres.R"))
```

<!--
Copyright 2021 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


# Introduction

Here, we are running a glmer for each separate fire regime type to develop a predictive equation so that we can extrapolate which cells are likely to burn and which are not into the future. The data that we include in these glms is vegetation, climate date, and human impact. The top climate variable for each fire regime type was determined in the script "05_spread_climate_variable_selection.R". 

Before running these glms I will plot the relationship between the climate variable and probability of spread. I should probably do partial plots because I also included lat and long in these models to try to account for autocorrelation. 




```{r eval=, message=FALSE, AIC table, echo=F}

climate_variable<-read.csv("C:/Work/caribou/castor_data/Fire/Fire_sim_data/data/climate_AIC_results_spread_summary.csv")

kable (climate_variable,
       caption = "<b>Table 1. Top candidate climate variables for fire spread as selected through an AIC analysis for each Fire Regime Type.<b>",
       digits = 2) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```

# Import the data

```{r}

fire_spread<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\spread\\Fire_spread_data_all_veg_dec23.gpkg")
head(fire_spread)
#fire_spread<-data.table(fire_spread)

table(fire_spread$fire_yr)

```


# change the vegetation fuel typing to be more like what kyle did


```{r}
restest = c(100, 100)
prov.rast <- raster( # standardized provincial raster with no data in it
  nrows = 15744, ncols = 17216,
  xmn = 159587.5, xmx = 1881187.5,
  ymn = 173787.5, ymx = 1748187.5,
  crs = "+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs",
  resolution = restest,
  vals = 0)

#lapply(seq(2009, 2022, 1), function(x) {
years<-2009:2022
  for (i in 1:length(years)){ 
    print(years[i])
  year_vri <- years[i]
  geom_column <- 'shape'
  
  vri<- getSpatialQuery(glue::glue("SELECT case 
      when proj_height_1 >=4 and basal_area >= 8 and bclcs_level_4 in ('TC') then 1
      when proj_height_1 >=4 and basal_area >= 8 and bclcs_level_4 in ('TM') then 2
      when proj_height_1 >=4 and basal_area >= 8 and bclcs_level_4 in ('TB') then 3
      when (proj_height_1 < 4 or basal_area < 8 or basal_area is null or proj_height_1 is null) and bclcs_level_4 in ('TC','TM','TB') then 4
      when bclcs_level_4 not in ('TC','TM','TB') then 5
      when (bclcs_level_1 <> 'V' and basal_area is null or basal_area < 4) then 6
                                end as hazard, {geom_column} FROM vri.veg_comp_lyr_r1_poly{year_vri} "))
  ras.haz<-fasterize::fasterize(vri, prov.rast, field = "hazard")
  rm(vri)
  gc()
  ras.haz[is.na(ras.haz[])]<-0
  plot(ras.haz)
  
  raster::writeRaster (ras.haz, 
                     filename = paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_ignit_", years[i], ".tiff", sep=""), 
                     format = "GTiff", 
                     datatype = 'INT1U')
  
  rm(ras.haz)
  gc()
  }


```

```{r}
years<-2009:2022
  for (i in 1:length(years)){ 
    print(years[i])
  year_vri <- years[i]
  
  basal_area<- getSpatialQuery(glue::glue("SELECT basal_area, shape FROM vri.veg_comp_lyr_r1_poly{year_vri}"))
  ras.haz<-fasterize::fasterize(basal_area, prov.rast, field = "basal_area")
  rm(basal_area)
  gc()
  
  ras.haz2<-terra::rast(ras.haz)
  
  terra::writeRaster (ras.haz2, 
                     filename = paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_basal_area_", years[i], ".tiff", sep=""), overwrite=TRUE,
                     datatype = 'INT1U')
  
  rm(ras.haz, ras.haz2)
  gc()
  }

```

```{r}
years<-c("2009","2010","2011","2013","2014","2015","2016","2017","2018","2019", "2020", "2021")

dat <- data.frame (matrix (ncol = 156, nrow = 0)) # add 'data' to the points
  colnames (dat) <- colnames(fire_spread)
  x<-data.frame(matrix(ncol=1, nrow=0))
  colnames(x)<- c("basal_area")
  dat<-cbind(dat, x)

for (i in 1: length(years)) {
  
ras<-terra::rast(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_basal_area_", years[i], ".tiff", sep=""))

fire_spread_yr<-fire_spread %>% filter(fire_yr == (as.numeric(years[i])+1))

x2<- st_centroid(fire_spread_yr)

x<-st_coordinates(x2)
test<-cbind(fire_spread_yr, x)
pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=terra::extract(ras, pointCoordinates)
val<-cbind(test, veg_cat)

dat<-rbind(dat, val)

}
  
#### now extract 2012 separately 
  ras<-terra::rast(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_basal_area_2011", ".tiff", sep=""))

fire_spread_yr<-fire_spread %>% filter(fire_yr == 2013)

x2<- st_centroid(fire_spread_yr)

x<-st_coordinates(x2)
test<-cbind(fire_spread_yr, x)
pointCoordinates<-data.frame(test$X, test$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=terra::extract(ras, pointCoordinates)
val<-cbind(test, veg_cat)

dat<-rbind(dat, val)
########

   
```


# extract the vri data from the tiffs created above except for 2012 which seems to have a slight glitch.

```{r}
years<-c("2009","2010","2011","2013","2014","2015","2016","2017","2018","2019", "2020", "2021")

dat1 <- data.frame (matrix (ncol = 160, nrow = 0)) # add 'data' to the points
  colnames (dat1) <- colnames(dat)
  x<-data.frame(matrix(ncol=1, nrow=0))
  colnames(x)<- c("veg_cat")
  dat1<-cbind(dat1, x)

for (i in 1: length(years)) {
  
ras<-terra::rast(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_ignit_", years[i], ".tiff", sep=""))

fire_spread_yr<-dat %>% filter(fire_yr == (as.numeric(years[i])+1))

pointCoordinates<-data.frame(fire_spread_yr$X, fire_spread_yr$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=terra::extract(ras, pointCoordinates)
colnames(veg_cat)<-c("id", "veg_cat")
val<-cbind(fire_spread_yr, veg_cat)


dat1<-rbind(dat1, val)
}

  #### now extract 2012 separately 
  ras<-terra::rast(paste0( "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\tmp\\spread\\","rast_ignit_2011", ".tiff", sep=""))

fire_spread_yr<-dat %>% filter(fire_yr == 2013)

pointCoordinates<-data.frame(fire_spread_yr$X, fire_spread_yr$Y)
head(pointCoordinates)
#crs(pointCoordinates) #No CRS when a dataframe
##Extract Wind values from stacked layer
veg_cat=terra::extract(ras, pointCoordinates)
colnames(veg_cat)<-c("id", "veg_cat")
val<-cbind(fire_spread_yr, veg_cat)

dat1<-rbind(dat1, val)
########

```


```{r}
##Change vegtype to factor

dat<-data.table(dat)
dat$fwveg<-as.factor(dat$fwveg)
dat[fwveg=="C-1", fwveg2:=1]
dat[fwveg=="C-2", fwveg2:=1]
dat[fwveg=="C-3", fwveg2:=1]
dat[fwveg=="C-5", fwveg2:=1]
dat[fwveg=="C-7", fwveg2:=1]
dat[fwveg=="D-1/2", fwveg2:=3]
dat[fwveg=="M-1/2", fwveg2:=2]
dat[fwveg=="M-3", fwveg2:=2]
dat[fwveg=="O-1a/b", fwveg2:=5]
dat[fwveg=="S-1", fwveg2:=4]
dat[fwveg=="S-2", fwveg2:=4]
dat[fwveg=="S-3", fwveg2:=4]
dat[fwveg=="W", fwveg2:=6]
dat[fwveg=="N", fwveg2:=6]

table(dat$fire_yr,dat$fwveg2, dat$veg_cat)

#create new column
fire_spread$fire_veg<-paste(fire_spread$pttype, fire_spread$fwveg)


table(dat$fire_yr)
table(fire_spread$fire_yr)

dat2<-merge(dat, fire_bounds, by.x=c("fire_yr", "fire_label"), by.y = c("FIRE_YEAR", "FIRE_LABEL"), all.x = TRUE)
dat3<-as.data.frame(dat2)

dat1<-dat1 %>% rename(basal_area = layer)

st_write(dat1, "C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\spread\\spread_data_11April2024.gpkg", delete_layer=TRUE, driver="GPKG")

dat2<-st_read("C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\spread\\spread_data_11April2024.gpkg")

names(dat2)
table(dat2$fire_yr)

```


```{r}
dat2<-data.table(dat2)
#dat<-dat2[FIRE_CAUSE=="Lightning",]
dat<-dat2

dat$PPT04<-as.numeric(dat$PPT04)
dat$PPT05<-as.numeric(dat$PPT05)
dat$PPT06<-as.numeric(dat$PPT06)
dat$PPT07<-as.numeric(dat$PPT07)
dat$PPT08<-as.numeric(dat$PPT08)
dat$PPT09<-as.numeric(dat$PPT09)


dat[frt==5, climate1:=(CMI03 + CMI04)/2]
dat[frt==9, climate1:=(Tave03 + Tave04 + Tave05 + Tave06 + Tave07)/5]
dat[frt==10, climate1:=Tmax06]
dat[frt==10, climate2:=PPT06]
dat[frt==11, climate1:=(Tmin06 + Tmin07)/2]
dat[frt==11, climate2:=(PPT06 + PPT07)/2]
dat[frt==12, climate1:=(Tmax04 + Tmax05 + Tmax06)/3]
dat[frt==12, climate2:=(PPT04 + PPT05 + PPT06)/3]
dat[frt==13,climate1:=(Tmax05 + Tmax06 + Tmax07+ Tmax08+ Tmax09)/5]
dat[frt==14, climate1:=(Tmax03 + Tmax04 + Tmax05)/3]
dat[frt==14, climate2:=(PPT03 + PPT04 + PPT05)/3]
dat[frt==15, climate1:=(CMD04 + CMD05 + CMD06 + CMD07 + CMD08 +CMD09)/6]

```

#Create climate1 and climate2 columns

```{r}
#View top variable
names(dat)

unique(dat$frt) # FRT 3 should not be in this list
table(is.na(dat$frt))

dat[is.na(frt) & bec_zone_code=="CWH", frt:=15]
dat[is.na(frt) & bec_zone_code=="CDF", frt:=15]
dat[is.na(frt) & bec_zone_code=="CMA", frt:=10]
dat[is.na(frt) & bec_zone_code=="MH", frt:=15]
dat[is.na(frt) & bec_zone_code=="ESSF", frt:=13]
dat[is.na(frt) & bec_zone_code=="MS", frt:=13]
dat[is.na(frt) & bec_zone_code=="ICH", frt:=13]
dat[is.na(frt) & bec_zone_code=="IDF", frt:=14]
dat[is.na(frt) & bec_zone_code=="BG", frt:=14]
dat[is.na(frt) & bec_zone_code=="PP", frt:=14]
#create new column
dat$fire_veg<-paste(dat$pttype, dat$veg_cat)

```

#Change Aspect to N,S,E,W

```{r}
dat[, aspect_cardinal:="O"]
dat[aspect_ha_bc>315, aspect_cardinal:="N"]
dat[aspect_ha_bc<=45, aspect_cardinal:="N"]
dat[aspect_ha_bc>45 & aspect_ha_bc<=135, aspect_cardinal:="O"]
dat[aspect_ha_bc>135 & aspect_ha_bc<=225, aspect_cardinal:="S"]
dat[aspect_ha_bc>225 & aspect_ha_bc<=315, aspect_cardinal:="O"]

x<-dat %>% filter(pttype==1)
hist(x$aspect_ha_bc)

# I think the vegetation categorization is not great! so ill change veg_cat=6  to veg_cat 4 under the following conditions
dat[veg_cat==6 & bclcs_level_1 =="V" & bclcs_level_4 %in% c("TC", "TB", "TD"), veg_cat:=4]
dat[veg_cat==6 & bclcs_level_1 =="V", veg_cat:=5]
```

#View plots (SLOW)

```{r}
#  positive association with slope

ggplot(dat, aes(x = slope_ha_bc)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)
ggplot(dat, aes(x = conifer_pct_cover_total)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)

ggplot(dat, aes(x = rast_ignit_dist)) +
  geom_histogram(fill = "white", colour = "black") +
  facet_grid(pttype ~ .)

##Seeing distribution of ignitions by slope makes me believe that slope is not a big factor for ignitions despite seemingly positive trend prior.
p <- ggplot(dat, aes(dem, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("elevation") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p # seems like there is probably no relationship with elevation

p <- ggplot(dat, aes(conifer_pct_cover_total, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("% conifer") + ylab("Pr (spread)") + 
  facet_wrap(~frt)
p
```

Checking relationship between age and veg categories
```{r}
p <- ggplot(dat, aes(proj_age_1, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("age") + ylab("Pr (spread)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(proj_age_1, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("age") + ylab("Pr (ignition)") + 
  facet_wrap(~veg_cat)
p

### its weird that there are ages in the category 0 and 6. 

p <- ggplot(dat, aes(((CMI03 + CMI04 + CMI05)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("CMI 03 to 05") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((CMI06 + CMI07 + CMI08)/4), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("CMI 06 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p


p <- ggplot(dat, aes(((CMD03 +CMD04 + CMD05 + CMD06 + CMD07 + CMD08)/5), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("CMD_04 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p 

p <- ggplot(dat, aes(((CMD03 + CMD04 + CMD05)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("CMD 03 to 05") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((CMD06 + CMD07 + CMD08)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("CMD 06 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((PPT03 + PPT04 + PPT05)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("PPT 03 to 05") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((PPT06 + PPT07 + PPT08)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("PPT 06 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((Tmax03 + Tmax04 + Tmax05)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Tmax 03 to 05") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((Tmax06 + Tmax07 + Tmax08)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Tmax 06 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(((RH06 + RH07 + RH08)/3), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("RH 06 to 08") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes(dist_roads_m, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Distance to roads") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((log(dist_roads_m+1)), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Log Distance to roads") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((log(dist_infr_m+1)), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Log Distance to infra") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((dist_infr_m), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Distance to infra") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((dem), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Elevation") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((rast_ignit_dist), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Distance to ignition") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p

p <- ggplot(dat, aes((slope_ha_bc), as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Slope") + ylab("Pr (ignition)") + 
  facet_wrap(~frt)
p


```

# remove NA values in the columns because the glmer models dont run if there are any na values
```{r}
dat<-dat[!is.na(slope_ha_bc),]
dat<-dat[!is.na(dem),]
dat<-dat[!is.na(fwveg),]
dat<-dat[!is.na(climate1),]
```

# Fit models


# FRT 5 and 7 ####

I tried various things including the interaction between climate2 and climate1 instead of dem and also I tried leaving out fire_yr. I landed on model3 being best. Tehre is a slightly weird relationship between dem and climate 2 where low elevation sites have a higher chance of spread with increasing climate 2 then at intermediate elevations there is no relationship beween spread and climate 2 and then at higher sites the relationship goes in the direction I expect. less rain = higher chance of spread. So bare this in mind. 

```{r}
# Plot climate data results

# also consider making box plots of these climatic variables to see how they perform

frt5<-dat %>% filter(frt %in% c(5, 7))
#frt7 <- dat %>% filter(frt == 7 & !veg_cat %in% c(0,6))

#frt5_7<-dat %>% filter(frt %in% c(5,7) & !veg_cat %in% c(0, 6))
#frt5[, climate2:=(PPT06+PPT07)/2]

ggplot(frt5, aes(x=factor(pttype), y=climate1))+
geom_boxplot()

ggplot(frt5, aes(x=factor(pttype), y=climate2))+
geom_boxplot()

ggplot(frt5, aes(x=factor(pttype), y=rast_ignit_dist))+
geom_boxplot()


p <- ggplot(frt5, aes((RH03 + RH04 +RH05)/3, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean_Tmax06_07") + ylab("Pr (ignition)")
p

p <- ggplot(frt5, aes((CMI03 + CMI04 +CMI05)/3, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean_Tmax06_07") + ylab("Pr (ignition)")
p

p <- ggplot(frt5, aes((CMI03 +CMI04)/2, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean_Tmax06_07") + ylab("Pr (ignition)")
p


p <- ggplot(frt5, aes(climate2, as.numeric(pttype))) +
  geom_smooth(method="glm", formula=y~x,
              method.args=list(family="binomial"),
              alpha=0.3) +
  geom_point(position=position_jitter(height=0.03, width=0)) +
  xlab("Mean_PPT06_07") + ylab("Pr (ignition)")
p

ggplot(frt5, aes(x=factor(pttype), y=dem))+
geom_boxplot()


# I dont like tahat fires typically occur at lower Tmax07. I think the reason is becuase Tmax is correlated with dem. But Im not sure how to get around this. The ppt07 data is strongly in the correct direction so maybe that makes it ok. Im not sure.

table(is.na(frt5$win_sum))

# give places with no wind info the mean value
mean_win<-frt5 %>% tidyr::drop_na(win_sum) %>% summarize(mean(win_sum))
frt5[is.na(win_sum), win_sum:=3.018047]

table(is.na(frt5$dem))
table(is.na(frt5$dist_roads))
table(is.na(frt5$dist_infr_m))
table(is.na(frt5$climate2))
table(is.na(frt5$veg_cat))
table(is.na(frt5$rast_ignit_dist))
table(is.na(frt5$proj_age_1))
```

There seems to be a problem with my veg categories
```{r}
frt5[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt5[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt5[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt5[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt5[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt5[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt5[bclcs_level_1 !="V", veg_cat:=6]

table(frt5$veg_cat, frt5$pttype)
    
```


```{r}
frt5[, climate1:=(CMI03 + CMI04)/2]

cor.test((frt5$climate1), (frt5$dem)) 
cor.test((frt5$climate2), (frt5$dem))
cor.test((frt5$climate1), (frt5$climate2))
cor.test((frt5$dist_roads_m), (frt5$dist_infr_m)) # almost correlated (0.665)
cor.test((frt5$rast_ignit_dist), (frt5$climate2))
cor.test((frt5$proj_age_1), (frt5$basal_area))

# Using AIC Ill pick the model that is better with leaving some of these combinations out

table(frt5$veg_cat, frt5$pttype)

frt5<-frt5 %>% 
  filter(!bclcs_level_5 %in% c("GL", "LA")) # remove glaciers or lakes. Sometimes these get put into the N veg category so I want to make sure there are not present
table(frt5$veg_cat, frt5$pttype)
frt5$veg_cat<-as.factor(frt5$veg_cat)

frt5<-frt5[!veg_cat %in% c("6","0")]
frt5<-frt5[!is.na(proj_age_1),]
frt5<-frt5[!is.na(basal_area),]


```

# Model fit

```{r}
frt5$fire_yr<-as.factor(frt5$fire_yr)
frt5$fire_label<-as.factor(frt5$fire_label)
frt5$frt<-as.factor(frt5$frt)
frt5$aspect_cardinal<-as.factor(frt5$aspect_cardinal)
frt5$veg_cat<-as.factor(frt5$veg_cat)

frt5$scale_climate1<-(frt5$climate1-mean(frt5$climate1, na.rm=TRUE)) / sd(frt5$climate1, na.rm=TRUE)
frt5$scale_climate2<-(frt5$climate2-mean(frt5$climate2, na.rm=TRUE)) / sd(frt5$climate2, na.rm=TRUE)
frt5$scale_dem<-(frt5$dem-mean(frt5$dem, na.rm=TRUE))/sd(frt5$dem, na.rm=TRUE)
frt5$scale_slope<-(frt5$slope_ha_bc-mean(frt5$slope_ha_bc, na.rm=TRUE)) / sd(frt5$slope_ha_bc, na.rm=TRUE)
frt5$scale_roads<-(frt5$dist_roads_m-mean(frt5$dist_roads_m, na.rm=TRUE)) / sd(frt5$dist_roads_m, na.rm=TRUE)
frt5$scale_infr<-(frt5$dist_infr_m-mean(frt5$dist_infr_m, na.rm=TRUE)) / sd(frt5$dist_infr_m, na.rm=TRUE)
frt5$scale_dist_ignit<-(frt5$rast_ignit_dist-mean(frt5$rast_ignit_dist, na.rm=TRUE)) / sd(frt5$rast_ignit_dist, na.rm=TRUE)
frt5$scale_pct_conifer<-(frt5$conifer_pct_cover_total-mean(frt5$conifer_pct_cover_total, na.rm=TRUE))/sd(frt5$conifer_pct_cover_total, na.rm=TRUE)
frt5$scale_age<-(frt5$proj_age_1-mean(frt5$proj_age_1, na.rm=TRUE))/sd(frt5$proj_age_1, na.rm=TRUE)
frt5$scale_basal_area<-(frt5$basal_area-mean(frt5$basal_area, na.rm=TRUE))/sd(frt5$basal_area, na.rm=TRUE)
frt5$scale_win_spg<-(frt5$win_spg-mean(frt5$win_spg, na.rm=TRUE))/sd(frt5$win_spg, na.rm=TRUE)

table(frt5$bec_zone_code, frt5$pttype)

frt5[bec_zone_code=="BAFA", bec_zone_code:="SWB"]

frt5<-frt5[!is.na(scale_climate2)]

# climate 1 and dem are correlated 
model1 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_roads + scale_infr + scale_slope + aspect_cardinal + scale_age + scale_pct_conifer + scale_basal_area + bec_zone_code + (1|fire_label) ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model1) #AIC = 64953.8           
Anova(model1, type=3)

# try dem instead of climate 1
model2 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_roads + scale_infr + scale_age + scale_pct_conifer + scale_basal_area + bec_zone_code + (1|fire_label) ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model2) #AIC= 64912.6          
Anova(model2, type=3)
visreg(model2)
visreg(model2, "scale_climate1", by="scale_climate2")
# the relationship is in the wrong direction


# model 1 is better
# remove slope and infrastructure
model3 <- glmer (pttype ~ scale_dem * scale_climate2 + veg_cat + scale_roads + scale_infr + scale_age + scale_pct_conifer + scale_basal_area + bec_zone_code + (1|fire_label) ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model3) #AIC = 64909.0         
Anova(model3, type=3)
visreg(model3)
visreg(model3, "scale_climate2", by="scale_dem")

# remove aspect because although its significant the relationships seem odd and also the classes dont seem very different to one another
model4 <- glmer (pttype ~ poly(scale_dem,2, raw=TRUE) + scale_climate1 + veg_cat + log(dist_infr_m+1) + scale_age + scale_pct_conifer + scale_basal_area + bec_zone_code +  (1|fire_label) ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model4) #AIC = 64909.0         
Anova(model4, type=3)

visreg(model4)

model5 <- glmer (pttype ~ scale_dem + scale_climate1 + veg_cat + log(dist_infr_m+1) + scale_age + scale_pct_conifer + scale_basal_area +  (1|fire_label) ,
               data=frt5,
               family = binomial (link = "logit"))
summary(model5) #AIC = 64909.0         
Anova(model5, type=3)
visreg(model5)

AIC(model3, model4)

frt5_2<-frt5[!is.na(scale_pct_conifer) & !is.na(bec_zone_code),]

binnedplot (fitted(model5), 
            residuals(model5), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))


plot(predict(model5),residuals(model5))
abline(h=0,lty=2,col="grey")
lines(lowess(predict(model5),residuals(model5)),col="black",lwd=2)

plot(frt5_2$scale_climate1,residuals(model5))
lines(lowess(frt5_2$scale_climate1,residuals(model5)),col="black",lwd=2)

plot(frt5_2$scale_dem,residuals(model4))
lines(lowess(frt5_2$scale_dem,residuals(model4)),col="black",lwd=2)

plot(frt5_2$scale_roads,residuals(model4))
lines(lowess(frt5_2$scale_roads,residuals(model4)),col="black",lwd=2)

plot(frt5_2$scale_dist_ignit,residuals(model4))
lines(lowess(frt5_2$scale_dist_ignit,residuals(model4)),col="black",lwd=2)

plot(frt5_2$scale_basal_area,residuals(model4))
lines(lowess(frt5_2$scale_basal_area,residuals(model4)),col="black",lwd=2)

plot(frt5_2$scale_age,residuals(model4))
lines(lowess(frt5_2$scale_age,residuals(model4)),col="black",lwd=2)

plot(frt5_2$scale_pct_conifer,residuals(model4))
lines(lowess(frt5_2$scale_pct_conifer,residuals(model4)),col="black",lwd=2)

saveRDS(model5, "C:/Work/caribou/castor/R/fire_sim/tmp/frt5.rds")

```

# get values for fixed effects of top model and test that it worked

```{r}

m5<-readRDS("C:/Work/caribou/castor/R/fire_sim/tmp/frt5.rds")

newdat<-expand.grid(scale_dem =c(0, -0.5,-1,1,0.5), 
                    scale_climate1 = c(0.4, 0.3, 1,-0.9, -0.2),
                    veg_cat=c("1", "2", "3", "4", "5"),
                    dist_infr_m=c(0, 10, 50, 100, 800), 
                    scale_age = c(-2.45, -0.72, -0.08,0.0,0.72),
                    scale_pct_conifer = c(-2.7, -0.32,0.54,0.0, 0.72),
                    scale_basal_area = c(-1.19, -0.92, -0.25,0,0.84),
                    pttype=0)

newdat$pttype <- predict(m5,newdat,re.form=NA)

newdat<-data.table(newdat)
newdat[, veg_cat2:=0]
newdat[veg_cat=="2", veg_cat2:=1]
newdat[, veg_cat3:=0]
newdat[veg_cat=="3", veg_cat3:=1]
newdat[, veg_cat4:=0]
newdat[veg_cat=="4", veg_cat4:=1]
newdat[, veg_cat5:=0]
newdat[veg_cat=="5", veg_cat5:=1]
newdat[, bec_zone_SWB:=0]
newdat[bec_zone_code=="SWB", bec_zone_SWB:=1]


newdat[,manual_predict:= 0.51426 + 
  0.19775*scale_dem +
  -0.20059*scale_climate1+
  -0.16956*veg_cat2+
  -0.04948*veg_cat3+
  -0.12951*veg_cat4+
  -0.35333*veg_cat5+
  -0.05089* log(dist_infr_m+1)+
  0.11826*scale_age+
  0.22125*scale_pct_conifer+
  0.09886*scale_basal_area]
  

plot(newdat$scale_dist_ignit, newdat$pttype)
plot(newdat$scale_climate2, newdat$pttype)

# looks like it works

```


```{r}
frt5_3<-frt5[, c("pttype","scale_dem", "scale_climate1", "veg_cat", "dist_infr_m", "scale_age", "scale_pct_conifer", "scale_basal_area")]

frt5_3<-as.data.frame(frt5_3)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:500){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt5_3$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt5_3[ trainIndex,]
   Valid <- frt5_3[-trainIndex,]
   
#Model   
model.FRT5<-glm(pttype ~  scale_dem + scale_climate1 + veg_cat + log(dist_infr_m+1) + scale_age + scale_pct_conifer + scale_basal_area, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT5, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"5"
top_mod_table_FRT5[1,2]<-"scale_dem + scale_climate1 + veg_cat + log(dist_infr_m+1) + scale_age + scale_pct_conifer + scale_basal_area" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```




################################
#FRT 9 and FRT 11
################################

```{r}
# Plot climate data results

frt9<-dat %>% filter(frt %in% c(9,11) )

frt9[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt9[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt9[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt9[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt9[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt9[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt9[bclcs_level_1 !="V", veg_cat:=6]

table(frt9$veg_cat, frt9$pttype)
    
```


Test best climate variable
```{r}
frt9[,climate1:=(CMI03+CMI04+CMI05)/3]
model1 <- glm (pttype ~ climate1 ,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(CMI03+CMI04+CMI05+CMI06+CMI07+CMI08)/6]
model2 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(CMI06+CMI07+CMI08)/3]
model3 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmax03+Tmax04+Tmax05)/3]
model4 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate2:=(PPT03+PPT04+PPT05)/3]
model5 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model6 <- glm (pttype ~ climate1+climate2 ,
               data=frt9,
               family = binomial (link = "logit"))
model7 <- glm (pttype ~ climate1*climate2 ,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tave03+Tave04+Tave05)/3]
model8 <- glm (pttype ~ climate1 ,
               data=frt9,
               family = binomial (link = "logit"))
model9 <- glm (pttype ~ climate1+climate2 ,
               data=frt9,
               family = binomial (link = "logit"))
model10 <- glm (pttype ~ climate1*climate2 ,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
model11 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model12 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model13 <- glm (pttype ~ climate1*climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
model14 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
frt9[,climate2:=(PPT06+PPT07+PPT08)/3]
model15 <- glm (pttype ~ climate2,
               data=frt9,
               family = binomial (link = "logit"))
model16 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model17 <- glm (pttype ~ climate1*climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tave06+Tave07+Tave08)/3]
model18 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model19 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model20 <- glm (pttype ~ climate1*climate2 ,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
model21 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model22 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model23 <- glm (pttype ~ climate1*climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmax03+Tmax04+Tmax05+Tmax06+Tmax07+Tmax08)/6]
model24 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
model25 <- glm (pttype ~ climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
model26 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model27 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model28 <- glm (pttype ~ climate1*climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(Tmin03+Tmin04+Tmin05+Tmin06+Tmin07+Tmin08)/6]
model29 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
model30 <- glm (pttype ~ climate1+climate2,
               data=frt9,
               family = binomial (link = "logit"))
model31 <- glm (pttype ~ climate1*climate2,
               data=frt9,
               family = binomial (link = "logit"))

frt9[,climate1:=(RH03+RH04+RH05+RH06+RH07+RH08)/6]
model32 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))
frt9[,climate1:=(CMD03+CMD04+CMD05+CMD06+CMD07+CMD08)/6]
model33 <- glm (pttype ~ climate1,
               data=frt9,
               family = binomial (link = "logit"))

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10,model11, model12, model13, model14, model15, model16, model17, model18, model19, model20,model21, model22, model23, model24, model25, model26, model27, model28, model29, model30,model31, model32, model33)

# top climate model is model28

visreg(model28, "climate1", by="climate2")
visreg(model28, "climate2", by="climate1")
```


```{r}
frt9[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
frt9[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
#frt9 %>% drop_na(win_sum) %>% summarize(mean(win_sum))
#frt9$win_sum[is.na(frt9$win_sum)]<-3.898718

table(frt9$veg_cat, frt9$pttype)
cor.test(frt9$climate1, frt9$dem) # highly correlated
cor.test(frt9$climate2, frt9$dem)
cor.test(frt9$dist_roads_m, frt9$dist_infr_m) 

frt9$fire_yr<-as.factor(frt9$fire_yr)
frt9$fire_label<-as.factor(frt9$fire_label)
frt9$frt<-as.factor(frt9$frt)
frt9$aspect_cardinal<-as.factor(frt9$aspect_cardinal)
frt9$veg_cat<-as.factor(frt9$veg_cat)

frt9$scale_climate1<-(frt9$climate1-mean(frt9$climate1, na.rm=TRUE)) / sd(frt9$climate1, na.rm=TRUE)
frt9$scale_climate2<-(frt9$climate2-mean(frt9$climate2, na.rm=TRUE)) / sd(frt9$climate2, na.rm=TRUE)
frt9$scale_dem<-(frt9$dem-mean(frt9$dem, na.rm=TRUE))/sd(frt9$dem, na.rm=TRUE)
frt9$scale_slope<-(frt9$slope_ha_bc-mean(frt9$slope_ha_bc, na.rm=TRUE)) / sd(frt9$slope_ha_bc, na.rm=TRUE)
frt9$scale_roads<-(frt9$dist_roads_m-mean(frt9$dist_roads_m, na.rm=TRUE)) / sd(frt9$dist_roads_m, na.rm=TRUE)
frt9$scale_infr<-(frt9$dist_infr_m-mean(frt9$dist_infr_m, na.rm=TRUE)) / sd(frt9$dist_infr_m, na.rm=TRUE)
frt9$scale_dist_ignit<-(frt9$rast_ignit_dist-mean(frt9$rast_ignit_dist, na.rm=TRUE)) / sd(frt9$rast_ignit_dist, na.rm=TRUE)
frt9$scale_pct_conifer<-(frt9$conifer_pct_cover_total-mean(frt9$conifer_pct_cover_total, na.rm=TRUE))/sd(frt9$conifer_pct_cover_total, na.rm=TRUE)
frt9$scale_age<-(frt9$proj_age_1-mean(frt9$proj_age_1, na.rm=TRUE))/sd(frt9$proj_age_1, na.rm=TRUE)
frt9$scale_basal_area<-(frt9$basal_area-mean(frt9$basal_area, na.rm=TRUE))/sd(frt9$basal_area, na.rm=TRUE)

table(frt9$bec_zone_code, frt9$pttype)

frt9[bec_zone_code=="CMA", bec_zone_code:="ICH"]
#frt9[bec_zone_code=="BAFA", bec_zone_code:="ESSF"]
frt9[bec_zone_code=="ICH", bec_zone_code:="SBS"]

frt9<-frt9[veg_cat != "6",]


```

# I tried making this model in both ways i.e. throwing many things into and reducing it or building it up from basics. I chose to go with building it up because adding dist_ignition changes the direction of the relationship of climate2. Which seems odd. But I only could find this from building the models up. Anyway. see below. I think model15a is best
```{r}
model1a <- glmer (pttype ~  scale_climate1*scale_climate2 +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))

summary(model1a)

model2a <- glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))

summary(model2a)

#Note scale_roads seems to go in the wrong direction i.e. the closer you are to a road the higher the chance of spread. Maybe this 
model3a <- glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat + scale_roads +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
visreg(model3a, "scale_roads")

model4a <- glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat + scale_infr +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model4a)

model5a <- glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat + scale_infr + aspect_cardinal +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model5a)

# interesting! If I put in distance to ignition then scale_climate2 becomes postive i.e. more rain = more fire. This seems strange so Ill leave out distance to ignition

model6a <- glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat + scale_infr + aspect_cardinal + scale_dist_ignit +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model6a)

model7a<-glmer (pttype ~  scale_climate1*scale_climate2 + veg_cat + scale_infr + aspect_cardinal + scale_age +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model7a)
Anova(model7a, type=3)

model8a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_infr + aspect_cardinal + scale_age +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model8a)
Anova(model8a, type=3)

# I tested basal area, its not significant and it has lots of NA values so I left it out
model9a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_infr + aspect_cardinal + scale_age + scale_slope +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model9a)
Anova(model9a, type=3)

model10a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_infr + aspect_cardinal + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model10a)
Anova(model10a, type=3)

model11a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + scale_infr + aspect_cardinal + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model11a)
Anova(model11a, type=3)

model12a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + log(dist_infr_m+1) + aspect_cardinal + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model12a)
Anova(model12a, type=3)

#drop aspect
model12b<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + log(dist_infr_m+1) + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model12b)
Anova(model12b, type=3)



frt9$log_infr<-log(frt9$dist_infr_m+1)

model13a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + poly(log_infr,2) + aspect_cardinal + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model13a)
Anova(model13a, type=3)

model14a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + poly(log_infr,3) + aspect_cardinal + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model14a)
Anova(model14a, type=3)

# Try with cut for log_infr. maybe If I split infrastructure up into categories near, medium, far it will take out the structure.
frt9$dist_infra_categories<-cut(frt9$dist_infr_m/1000,breaks = c(-1, 5, 20, 50, max(frt9$dist_infr_m/1000)+1),labels = c("A", "B", "C", "D"))

# look at the firesheds paper by WANG 2024 for maybe an idea of how large to make the bins. they say that "The average distance from which fire, when spreading at themaximum simulated rate, could reach the community perimeter was approximately 5, 12 and 18km in 1, 2 and 3days, respectively. So I think my bins are good actually

model15a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + dist_infra_categories + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model15a)
Anova(model15a, type=3)


frt9$dist_infra_categories<-cut(frt9$dist_infr_m/1000,breaks = c(-1, 1,5, 20,50, max(frt9$dist_infr_m/1000)),labels = c("A", "B", "C", "D", "E"))
model16a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + dist_infra_categories + scale_age + scale_slope + bec_zone_code +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
summary(model16a)
Anova(model16a, type=3)

visreg(model16a, "scale_climate1", by="scale_climate2")
visreg(model16a, "scale_climate1", by="veg_cat")
visreg(model16a, "scale_climate2", by="veg_cat")

# Top model I tried various other version but settled on this one below
model18a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + dist_infra_categories + scale_age + scale_slope +(1|fire_label) ,
               data=frt9,
               family = binomial (link = "logit"))
visreg(model18a, "scale_climate1", by="veg_cat")


################
## working on FRT 9 & 11
##################


# categorizing infrastructure does help but the relationship is again odd. Ie. chance of spread is higher near infrastructure then declines as you move away but then at the furthest distance its back up. maybe i should throw out infrastructure.

AIC(model1a, model2a, model3a, model4a, model5a, model7a, model8a, model9a, model10a, model11a, model12a,model12b, model13a, model14a, model15a, model16a)
visreg(model15a, "scale_climate1", by="veg_cat")
visreg(model15a)

saveRDS(model18a, "C:/Work/caribou/castor/R/fire_sim/tmp/frt9.rds")




```

#### get AUC values
```{r}
# model18a<-glmer (pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + dist_infra_categories + scale_age + scale_slope +(1|fire_label) ,
               #data=frt9,
               #family = binomial (link = "logit"))


frt9_2<-frt9[, c("pttype","scale_climate1", "scale_climate2", "veg_cat", "dist_infra_categories", "scale_age", "scale_slope")]

frt9_2<-as.data.frame(frt9_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt9_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt9_2[ trainIndex,]
   Valid <- frt9_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  scale_climate1*scale_climate2 + scale_climate1*veg_cat + dist_infra_categories + scale_age + scale_slope, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"9"
top_mod_table_FRT5[1,2]<-"scale_climate1*scale_climate2 + scale_climate1*veg_cat + dist_infra_categories + scale_age + scale_slope" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```



```{r}
# model diagnostic plots
# below model looks way better with log road dist. It had some structure with just road dist
binnedplot (fitted(model18a), 
            residuals(model18a), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))


frt9$resids<-resid(model18a)

binnedplot (frt9$scale_climate1, 
            frt9$resids, 
            nclass = NULL)

binnedplot (frt9$scale_climate2, 
            frt9$resids, 
            nclass = NULL)

binnedplot (frt9$climate2  , 
            frt9$resids, 
            nclass = NULL)

binnedplot (frt9$scale_slope, 
            frt9$resids, 
            nclass = NULL)

binnedplot (frt9$scale_age, 
            frt9$resids, 
            nclass = NULL)
binnedplot ((frt9$dist_infr_m), 
            frt9$resids, 
            nclass = NULL)

```


################################
#FRT 10
################################

```{r}
# Plot climate data results

frt10<-dat %>% filter(frt==10)

table(is.na(frt10$win_sum))
table(is.na(frt10$dem))
table(is.na(frt10$slope_ha_bc))
frt10<-frt10[!is.na(slope_ha_bc),]

frt10[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt10[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt10[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt10[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt10[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt10[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt10[bclcs_level_1 !="V", veg_cat:=6]

table(frt10$veg_cat, frt10$pttype)
frt10<-frt10[veg_cat!=6,]

frt10[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
frt10[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
frt10[veg_cat==5 & is.na(basal_area), basal_area:=0]
frt10<-(frt10[!is.na(proj_age_1),])
frt10[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
```

Test best climate variable
```{r}
frt10[,climate1:=(CMI03+CMI04+CMI05)/3]
model1 <- glm (pttype ~ climate1 ,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(CMI03+CMI04+CMI05+CMI06+CMI07+CMI08)/6]
model2 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(CMI06+CMI07+CMI08)/3]
model3 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmax03+Tmax04+Tmax05)/3]
model4 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate2:=(PPT03+PPT04+PPT05)/3]
model5 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model6 <- glm (pttype ~ climate1+climate2 ,
               data=frt10,
               family = binomial (link = "logit"))
model7 <- glm (pttype ~ climate1*climate2 ,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tave03+Tave04+Tave05)/3]
model8 <- glm (pttype ~ climate1 ,
               data=frt10,
               family = binomial (link = "logit"))
model9 <- glm (pttype ~ climate1+climate2 ,
               data=frt10,
               family = binomial (link = "logit"))
model10 <- glm (pttype ~ climate1*climate2 ,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
model11 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model12 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model13 <- glm (pttype ~ climate1*climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
model14 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
frt10[,climate2:=(PPT06+PPT07+PPT08)/3]
model15 <- glm (pttype ~ climate2,
               data=frt10,
               family = binomial (link = "logit"))
model16 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model17 <- glm (pttype ~ climate1*climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tave06+Tave07+Tave08)/3]
model18 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model19 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model20 <- glm (pttype ~ climate1*climate2 ,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
model21 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model22 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model23 <- glm (pttype ~ climate1*climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmax03+Tmax04+Tmax05+Tmax06+Tmax07+Tmax08)/6]
model24 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
model25 <- glm (pttype ~ climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
model26 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model27 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model28 <- glm (pttype ~ climate1*climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(Tmin03+Tmin04+Tmin05+Tmin06+Tmin07+Tmin08)/6]
model29 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
model30 <- glm (pttype ~ climate1+climate2,
               data=frt10,
               family = binomial (link = "logit"))
model31 <- glm (pttype ~ climate1*climate2,
               data=frt10,
               family = binomial (link = "logit"))

frt10[,climate1:=(RH03+RH04+RH05+RH06+RH07+RH08)/6]
model32 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))
frt10[,climate1:=(CMD03+CMD04+CMD05+CMD06+CMD07+CMD08)/6]
model33 <- glm (pttype ~ climate1,
               data=frt10,
               family = binomial (link = "logit"))

model34 <- glm (pttype ~ Tmax06,
               data=frt10,
               family = binomial (link = "logit"))

model35 <- glm (pttype ~ PPT06,
               data=frt10,
               family = binomial (link = "logit"))
model36 <- glm (pttype ~ Tmax06 +PPT06,
               data=frt10,
               family = binomial (link = "logit"))

model37 <- glm (pttype ~ Tmax06*PPT06,
               data=frt10,
               family = binomial (link = "logit"))

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10,model11, model12, model13, model14, model15, model16, model17, model18, model19, model20,model21, model22, model23, model24, model25, model26, model27, model28, model29, model30,model31, model32, model33,model34,model35,model36,model37)

# top climate model is model37
visreg(model17, "climate1", by="climate2")
visreg(model17, "climate2", by="climate1")
visreg(model37, "Tmax06", by="PPT06")
visreg(model37, "PPT06", by="Tmax06")
```


```{r}
frt10$scale_climate1<-(frt10$Tmax06-mean(frt10$Tmax06, na.rm=TRUE)) / sd(frt10$Tmax06, na.rm=TRUE)
frt10$scale_climate2<-(frt10$PPT06-mean(frt10$PPT06, na.rm=TRUE)) / sd(frt10$PPT06, na.rm=TRUE)
frt10$scale_dem<-(frt10$dem-mean(frt10$dem, na.rm=TRUE))/sd(frt10$dem, na.rm=TRUE)
frt10$scale_slope<-(frt10$slope_ha_bc-mean(frt10$slope_ha_bc, na.rm=TRUE)) / sd(frt10$slope_ha_bc, na.rm=TRUE)
frt10$scale_roads<-(frt10$dist_roads_m-mean(frt10$dist_roads_m, na.rm=TRUE)) / sd(frt10$dist_roads_m, na.rm=TRUE)
frt10$scale_infr<-(frt10$dist_infr_m-mean(frt10$dist_infr_m, na.rm=TRUE)) / sd(frt10$dist_infr_m, na.rm=TRUE)
frt10$scale_dist_ignit<-(frt10$rast_ignit_dist-mean(frt10$rast_ignit_dist, na.rm=TRUE)) / sd(frt10$rast_ignit_dist, na.rm=TRUE)
frt10$scale_pct_conifer<-(frt10$conifer_pct_cover_total-mean(frt10$conifer_pct_cover_total, na.rm=TRUE))/sd(frt10$conifer_pct_cover_total, na.rm=TRUE)
frt10$scale_age<-(frt10$proj_age_1-mean(frt10$proj_age_1, na.rm=TRUE))/sd(frt10$proj_age_1, na.rm=TRUE)
frt10$scale_basal_area<-(frt10$basal_area-mean(frt10$basal_area, na.rm=TRUE))/sd(frt10$basal_area, na.rm=TRUE)

cor.test(frt10$scale_dem, frt10$scale_climate2)
cor.test(frt10$scale_dem, frt10$scale_climate1) 
cor.test(frt10$Tmax06, frt10$PPT06)
cor.test(frt10$dem, frt10$Tmax06)
cor.test(frt10$dist_roads_m, frt10$dist_infr_m)
cor.test(frt10$scale_climate1, frt10$scale_climate2)
cor.test(frt10$scale_roads, frt10$scale_infr)
cor.test(frt10$scale_age, frt10$scale_pct_conifer)
cor.test(frt10$scale_roads, frt10$scale_dem)
```


# Model fit

```{r}
table(frt10$bec_zone_code, frt10$pttype)

frt10<-frt10[veg_cat != "6",]
frt10$veg_cat<-as.factor(frt10$veg_cat)

model1 <- glmer (pttype ~ scale_climate1 * scale_climate2 + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
summary(model1)

model2 <- glmer (pttype ~ scale_climate1 * scale_climate2 + veg_cat + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
summary(model2)

model3 <- glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate1 * veg_cat + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
summary(model3)
Anova(model3, type=3)

model4 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))

model5 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))

model6 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age + scale_dem + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))

model7 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age + scale_dem +scale_slope + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))

model8 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age + scale_dem +scale_slope + aspect_cardinal + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))

model9 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age + scale_dem +scale_slope + aspect_cardinal + scale_pct_conifer + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
Anova(model9, type=3)

model10 <- glmer (pttype ~ scale_climate1 + scale_climate2 + scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
Anova(model10, type=3)

model11 <- glmer (pttype ~ scale_climate1 + scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
Anova(model11, type=3)

model12 <- glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + scale_roads +scale_basal_area + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
Anova(model12, type=3)

model13 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + bec_zone_code + (1|fire_label),
               data=frt10,
               family = binomial (link = "logit"))
Anova(model13, type=3)
summary(model13)
visreg(model13)



# ##############
# model13 <- glmer (pttype ~ scale_climate1 + scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + scale_roads + scale_dist_ignit + (1|fire_label),
#                data=frt10,
#                family = binomial (link = "logit"))
# Anova(model13, type=3)
# summary(model13)
# 
# model14 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + scale_roads + scale_dist_ignit*scale_climate1 + (1|fire_label),
#                data=frt10,
#                family = binomial (link = "logit"))
# 
# model15 <- glmer (pttype ~ scale_climate1 + scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + scale_dist_ignit + (1|fire_label),
#                data=frt10,
#                family = binomial (link = "logit"))
# Anova(model15, type=3)
# summary(model15)
# 
# model16 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + scale_climate1*scale_dist_ignit + (1|fire_label),
#                data=frt10,
#                family = binomial (link = "logit"))
# Anova(model16, type=3)
# summary(model16)
# visreg(model16, "scale_dist_ignit", by="scale_climate1")
# visreg(model16, "scale_climate1", by="veg_cat")

# check that veg_cat is going in the expected direction on model16

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14, model15, model16)

visreg(model13)
ss <- getME(model13,c("theta","fixef"))
m2 <- update(model13,start=ss,control=glmerControl(optCtrl=list(maxfun=2e6)))



# I think modmodel15# I think model 13 is best but Since roads are going in the wrong direction. maybe I shoudl toss out roads as done in model 15 or model16. I think I should save model16
visreg(model9, "scale_climate1", by="scale_climate2")
visreg(model9, "scale_climate1", by="veg_cat")
visreg(model9, "scale_climate2", by="veg_cat")

```


```{r}

# model diagnostic plots
# below model looks way better with log road dist. It had some structure with just road dist
binnedplot (fitted(model13), 
            residuals(model13), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))

plot(predict(model13),residuals(model13))
abline(h=0,lty=2,col="grey")
lines(lowess(predict(model13),residuals(model13)),col="black",lwd=2)

plot(frt10$scale_climate1,residuals(model16))
lines(lowess(frt10$scale_climate1,residuals(model16)),col="black",lwd=2)

plot(frt10$scale_age,residuals(model16))
lines(lowess(frt10$scale_age,residuals(model16)),col="black",lwd=2)

plot(frt10$scale_pct_conifer,residuals(model16))
lines(lowess(frt10$scale_pct_conifer,residuals(model16)),col="black",lwd=2)

plot(frt10$scale_slope,residuals(model16))
lines(lowess(frt10$scale_slope,residuals(model16)),col="black",lwd=2)

plot(frt10$scale_dist_ignit,residuals(model16))
lines(lowess(frt10$scale_dist_ignit,residuals(model16)),col="black",lwd=2)

```


#Checking assumption of influential values

see: (http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/)

Save model output

```{r}
saveRDS(model13, "C:/Work/caribou/castor/R/fire_sim/tmp/frt10.rds")
```


#### get AUC values
```{r}
# model13 <- glmer (pttype ~ scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + bec_zone_code + (1|fire_label),
#                data=frt10,
#                family = binomial (link = "logit"))
# Anova(model13, type=3)
# summary(model13)


frt10_2<-frt10[, c("pttype","scale_climate1", "veg_cat", "scale_age", "scale_slope", "aspect_cardinal", "scale_pct_conifer", "bec_zone_code")]

frt10_2<-as.data.frame(frt10_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt10_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt10_2[ trainIndex,]
   Valid <- frt10_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + bec_zone_code, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"10"
top_mod_table_FRT5[1,2]<-"scale_climate1 * veg_cat + scale_age +scale_slope + aspect_cardinal + scale_pct_conifer + bec_zone_code" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```


################################
#FRT 12
################################

```{r}
frt12<-dat %>% filter(frt==12)

table(is.na(frt12$dem))
table(is.na(frt12$slope_ha_bc))
frt12<-frt12[!is.na(slope_ha_bc),]

frt12[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt12[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt12[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt12[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt12[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt12[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt12[bclcs_level_1 !="V", veg_cat:=6]

table(frt12$veg_cat, frt12$pttype)
frt12<-frt12[!veg_cat %in% c(0,6),]

frt12[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
frt12[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
frt12[veg_cat==5 & is.na(basal_area), basal_area:=0]
frt12<-(frt12[!is.na(proj_age_1),])
frt12[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]


frt12$log_roads<-log(frt12$dist_roads_m+1)
frt12$log_infra<-log(frt12$dist_infr_m+1)
```

Test best climate variable
```{r}
frt12[,climate1:=(CMI03+CMI04+CMI05)/3]
model1 <- glm (pttype ~ climate1 ,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(CMI03+CMI04+CMI05+CMI06+CMI07+CMI08)/6]
model2 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(CMI06+CMI07+CMI08)/3]
model3 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmax03+Tmax04+Tmax05)/3]
model4 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate2:=(PPT03+PPT04+PPT05)/3]
model5 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model6 <- glm (pttype ~ climate1+climate2 ,
               data=frt12,
               family = binomial (link = "logit"))
model7 <- glm (pttype ~ climate1*climate2 ,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tave03+Tave04+Tave05)/3]
model8 <- glm (pttype ~ climate1 ,
               data=frt12,
               family = binomial (link = "logit"))
model9 <- glm (pttype ~ climate1+climate2 ,
               data=frt12,
               family = binomial (link = "logit"))
model10 <- glm (pttype ~ climate1*climate2 ,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
model11 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model12 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model13 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
model14 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
frt12[,climate2:=(PPT06+PPT07+PPT08)/3]
model15 <- glm (pttype ~ climate2,
               data=frt12,
               family = binomial (link = "logit"))
model16 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model17 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tave06+Tave07+Tave08)/3]
model18 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model19 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model20 <- glm (pttype ~ climate1*climate2 ,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
model21 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model22 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model23 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmax03+Tmax04+Tmax05+Tmax06+Tmax07+Tmax08)/6]
model24 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
model25 <- glm (pttype ~ climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
model26 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model27 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model28 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(Tmin03+Tmin04+Tmin05+Tmin06+Tmin07+Tmin08)/6]
model29 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
model30 <- glm (pttype ~ climate1+climate2,
               data=frt12,
               family = binomial (link = "logit"))
model31 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(RH03+RH04+RH05+RH06+RH07+RH08)/6]
model32 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
frt12[,climate1:=(CMD03+CMD04+CMD05+CMD06+CMD07+CMD08)/6]
model33 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))
frt12[,climate1:=(Tmax04 + Tmax05 + Tmax06)/3]
frt12[,climate2:=(PPT04 + PPT05 + PPT06)/3]
model34 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

model35 <- glm (pttype ~ climate2,
               data=frt12,
               family = binomial (link = "logit"))
model36 <- glm (pttype ~ climate1 +climate2,
               data=frt12,
               family = binomial (link = "logit"))

model37 <- glm (pttype ~ climate1*climate2,
               data=frt12,
               family = binomial (link = "logit"))

frt12[,climate1:=(RH04 + RH05 + RH06)/3]
model38 <- glm (pttype ~ climate1,
               data=frt12,
               family = binomial (link = "logit"))

model39 <- glm (pttype ~ dem,
               data=frt12,
               family = binomial (link = "logit"))
model40 <- glm (pttype ~ dem + climate2,
               data=frt12,
               family = binomial (link = "logit"))
model41 <- glm (pttype ~ dem*climate2,
               data=frt12,
               family = binomial (link = "logit"))





AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10,model11, model12, model13, model14, model15, model16, model17, model18, model19, model20,model21, model22, model23, model24, model25, model26, model27, model28, model29, model30,model31, model32, model33,model34,model35,model36,model37, model38, model39, model40, model41)

# top climate model is model17
frt12[,climate1:=(Tmax04 + Tmax05 + Tmax06)/3]
frt12[,climate2:=(PPT04 + PPT05 + PPT06)/3]
visreg(model41, "climate2", by="dem")
visreg(model36)


```


```{r}
frt12<-frt12[!is.na(climate1),]
require (ggcorrplot)
dist.cut.corr <- (frt12 [, c("climate1", "climate2", "dem", "slope_ha_bc", "dist_infr_m", "dist_roads_m", "rast_ignit_dist", "proj_age_1", "conifer_pct_cover_total")])
corr <- round (cor (dist.cut.corr), 3)
p.mat <- round (cor_pmat (dist.cut.corr), 2)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3)

cor.test(frt12$climate1, frt12$dem) #these two are correlated
cor.test(frt12$climate2, frt12$dem)
cor.test(frt12$dist_roads_m, frt12$dist_infr_m) # correlated
cor.test(frt12$dem, frt12$slope_ha_bc)
cor.test(frt12$log_infra, frt12$log_roads)

frt12$fire_label<-as.factor(frt12$fire_label)
frt12$veg_cat<-as.factor(frt12$veg_cat)

frt12$scale_climate1<-(frt12$climate1-mean(frt12$climate1, na.rm=TRUE)) / sd(frt12$climate1, na.rm=TRUE)
frt12$scale_climate2<-(frt12$climate2-mean(frt12$climate2, na.rm=TRUE)) / sd(frt12$climate2, na.rm=TRUE)
frt12$scale_dem<-(frt12$dem-mean(frt12$dem, na.rm=TRUE))/sd(frt12$dem, na.rm=TRUE)
frt12$scale_slope<-(frt12$slope_ha_bc-mean(frt12$slope_ha_bc, na.rm=TRUE)) / sd(frt12$slope_ha_bc, na.rm=TRUE)
frt12$scale_roads<-(frt12$dist_roads_m-mean(frt12$dist_roads_m, na.rm=TRUE)) / sd(frt12$dist_roads_m, na.rm=TRUE)
frt12$scale_infr<-(frt12$dist_infr_m-mean(frt12$dist_infr_m, na.rm=TRUE)) / sd(frt12$dist_infr_m, na.rm=TRUE)
frt12$scale_dist_ignit<-(frt12$rast_ignit_dist-mean(frt12$rast_ignit_dist, na.rm=TRUE)) / sd(frt12$rast_ignit_dist, na.rm=TRUE)
frt12$scale_pct_conifer<-(frt12$conifer_pct_cover_total-mean(frt12$conifer_pct_cover_total, na.rm=TRUE))/sd(frt12$conifer_pct_cover_total, na.rm=TRUE)
frt12$scale_age<-(frt12$proj_age_1-mean(frt12$proj_age_1, na.rm=TRUE))/sd(frt12$proj_age_1, na.rm=TRUE)
frt12$scale_basal_area<-(frt12$basal_area-mean(frt12$basal_area, na.rm=TRUE))/sd(frt12$basal_area, na.rm=TRUE)

table(frt12$bec_zone_code, frt12$pttype)
frt12[bec_zone_code=="CMA", bec_zone_code:="MH"] # looks like MH is the zone right next to CMA
```

```{r}
model1 <-  glmer (pttype ~ scale_dem * scale_climate2+ (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model1)

model2 <-  glmer (pttype ~ scale_dem * scale_climate2 + veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model2)

model3 <-  glmer (pttype ~ scale_dem * scale_climate2 + scale_dem*veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model3)

model4a <-  glmer (pttype ~ scale_climate2 + scale_dem*veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model4a)

model4b <-  glmer (pttype ~ scale_dem + scale_climate2 + veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model4a)

model4c <-  glmer (pttype ~ poly(scale_dem,2) + scale_climate2 + veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))

model4d <-  glmer (pttype ~ scale_dem + scale_climate2 * veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))

model4 <-  glmer (pttype ~ scale_dem * scale_climate2 + scale_climate2*veg_cat + (1|fire_label), data=frt12, family = binomial (link = "logit"))
summary(model4)

visreg(model4c)
visreg(model3,"scale_dem", by="veg_cat")

model5 <-  glmer (pttype ~ poly(scale_dem,2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + bec_zone_code +  (1|fire_label), data=frt12, family = binomial (link = "logit"))
Anova(model5, type=3)

model6 <-  glmer (pttype ~ poly(scale_dem,2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + log_infra+ bec_zone_code +  (1|fire_label), data=frt12, family = binomial (link = "logit"))
Anova(m2, type=3)
library(optimx)
# removed distance to ignition
model7 <-  glmer (pttype ~ scale_dem + I(scale_dem^2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra + bec_zone_code +  (1|fire_label), data=frt12, family = binomial (link = "logit"))
Anova(model7, type=3)

model8 <-  glmer (pttype ~ scale_dem + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra + bec_zone_code +  (1|fire_label), data=frt12, family = binomial (link = "logit"))
Anova(model8, type=3)


AIC(model1, model2, model3, model4, model4a, model4b, model4c, model4d, model5, model6, model7, model8)
Anova(model7, type=3)

visreg(m2)
ss <- getME(model7,c("theta","fixef"))
m2 <- update(model7,start=ss,control=glmerControl(optCtrl=list(maxfun=2e4)))


# model diagnostic plots
# below model looks way better with log road dist. It had some structure with just road dist
binnedplot (fitted(m2), 
            residuals(m2), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))

frt12$resids<-resid(m2)

binnedplot (frt12$scale_climate1, 
            frt12$resids, 
            nclass = NULL)
binnedplot (frt12$scale_climate2, 
            frt12$resids, 
            nclass = NULL)

frt12$predictedx<-predict(m2)
frt12$residsy<-residuals(m2)

plot(frt12$predictedx,frt12$residsy)
abline(h=0,lty=2,col="grey")
lines(lowess(frt12$predictedx,frt12$residsy),col="green",lwd=2)

plot(frt12$scale_climate2,residuals(m2))
lines(lowess(frt12$scale_climate2,residuals(m2)),col="red",lwd=2)

plot(frt12$scale_slope,residuals(m2))
lines(lowess(frt12$scale_slope,residuals(m2)),col="red",lwd=2)

plot(frt12$scale_dem,residuals(m2))
lines(lowess(frt12$scale_dem,residuals(m2)),col="red",lwd=2)

plot(frt12$scale_age,residuals(m2))
lines(lowess(frt12$scale_age,residuals(m2)),col="red",lwd=2)

plot(frt12$scale_pct_conifer, residuals(m2))
lines(lowess(frt12$scale_pct_conifer,residuals(m2)),col="red",lwd=2)


# library(DHARMa)
# simulationOutput <- simulateResiduals(fittedModel = model6)
# plot(simulationOutput)
# simulationOutput = recalculateResiduals(simulationOutput , group = frt12$fire_label)
# testOutliers(simulationOutput, type="bootstrap")
# testDispersion(simulationOutput) # I dont actually think I have overdispersion
# plot(simulationOutput)



```


```{r}
saveRDS(m2, "C:/Work/caribou/castor/R/fire_sim/tmp/frt12.rds")
```


#### get AUC values
```{r}
# model7 <-  glmer (pttype ~ scale_dem + I(scale_dem^2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra + bec_zone_code +  (1|fire_label), data=frt12, family = binomial (link = "logit"))



frt12_2<-frt12[, c("pttype", "scale_dem","scale_climate2", "veg_cat", "scale_age", "scale_slope", "aspect_cardinal", "scale_pct_conifer", "log_infra", "bec_zone_code")]

frt12_2<-as.data.frame(frt12_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt12_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt12_2[ trainIndex,]
   Valid <- frt12_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  scale_dem + I(scale_dem^2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra + bec_zone_code, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"12"
top_mod_table_FRT5[1,2]<-"scale_dem + I(scale_dem^2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra + bec_zone_code" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```


################################
#FRT 13
################################



```{r}
frt13<-dat %>% filter(frt==13)

table(is.na(frt13$dem))
table(is.na(frt13$slope_ha_bc))
frt13<-frt13[!is.na(slope_ha_bc),]

frt13[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt13[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt13[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt13[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt13[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt13[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt13[bclcs_level_1 !="V", veg_cat:=6]

table(frt13$veg_cat, frt13$pttype)
frt13<-frt13[veg_cat!=6,]

frt13[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
frt13[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
frt13[veg_cat==5 & is.na(basal_area), basal_area:=0]
frt13<-(frt13[!is.na(proj_age_1),])
frt13[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]


frt13$log_roads<-log(frt13$dist_roads_m+1)
frt13$log_infra<-log(frt13$dist_infr_m+1)
```

Test best climate variable
```{r}
frt13[,climate1:=(CMI03+CMI04+CMI05)/3]
model1 <- glm (pttype ~ climate1 ,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(CMI03+CMI04+CMI05+CMI06+CMI07+CMI08)/6]
model2 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(CMI06+CMI07+CMI08)/3]
model3 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmax03+Tmax04+Tmax05)/3]
model4 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate2:=(PPT03+PPT04+PPT05)/3]
model5 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model6 <- glm (pttype ~ climate1+climate2 ,
               data=frt13,
               family = binomial (link = "logit"))
model7 <- glm (pttype ~ climate1*climate2 ,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tave03+Tave04+Tave05)/3]
model8 <- glm (pttype ~ climate1 ,
               data=frt13,
               family = binomial (link = "logit"))
model9 <- glm (pttype ~ climate1+climate2 ,
               data=frt13,
               family = binomial (link = "logit"))
model10 <- glm (pttype ~ climate1*climate2 ,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
model11 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model12 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model13 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
model14 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
frt13[,climate2:=(PPT06+PPT07+PPT08)/3]
model15 <- glm (pttype ~ climate2,
               data=frt13,
               family = binomial (link = "logit"))
model16 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model17 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tave06+Tave07+Tave08)/3]
model18 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model19 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model20 <- glm (pttype ~ climate1*climate2 ,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
model21 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model22 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model23 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmax03+Tmax04+Tmax05+Tmax06+Tmax07+Tmax08)/6]
model24 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
model25 <- glm (pttype ~ climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
model26 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model27 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model28 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(Tmin03+Tmin04+Tmin05+Tmin06+Tmin07+Tmin08)/6]
model29 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
model30 <- glm (pttype ~ climate1+climate2,
               data=frt13,
               family = binomial (link = "logit"))
model31 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

frt13[,climate1:=(RH03+RH04+RH05+RH06+RH07+RH08)/6]
model32 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
frt13[,climate1:=(CMD03+CMD04+CMD05+CMD06+CMD07+CMD08)/6]
model33 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))
frt13[,climate1:=(Tmax05 + Tmax06 + Tmax07 + Tmax08 + Tmax09)/5]
frt13[,climate2:=(PPT05 + PPT06 + PPT07 + PPT08 + PPT09)/5]
model34 <- glm (pttype ~ climate1,
               data=frt13,
               family = binomial (link = "logit"))

model35 <- glm (pttype ~ climate2,
               data=frt13,
               family = binomial (link = "logit"))
model36 <- glm (pttype ~ climate1 +climate2,
               data=frt13,
               family = binomial (link = "logit"))

model37 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10,model11, model12, model13, model14, model15, model16, model17, model18, model19, model20,model21, model22, model23, model24, model25, model26, model27, model28, model29, model30,model31, model32, model33,model34,model35,model36,model37)

# top climate model is model23
frt13[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
frt13[,climate2:=(PPT06+PPT07+PPT08)/3]
model23 <- glm (pttype ~ climate1*climate2,
               data=frt13,
               family = binomial (link = "logit"))

visreg(model23, "climate1", by="climate2", breaks = 6)
visreg(model37)

```


```{r}
# using the following for climate as the trends make more sense
frt13[,climate1:=(Tmax05 + Tmax06 + Tmax07 + Tmax08 + Tmax09)/5]
frt13[,climate2:=(PPT05 + PPT06 + PPT07 + PPT08 + PPT09)/5]


frt13<-frt13[!is.na(climate1),]
require (ggcorrplot)
dist.cut.corr <- (frt13 [, c("climate1", "climate2", "dem", "slope_ha_bc", "dist_infr_m", "dist_roads_m", "rast_ignit_dist", "proj_age_1", "conifer_pct_cover_total")])
corr <- round (cor (dist.cut.corr), 3)
p.mat <- round (cor_pmat (dist.cut.corr), 2)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3)

frt13$log_infra<-log(frt13$dist_infr_m+1)
frt13$log_roads<-log(frt13$dist_roads_m+1)

frt13$veg_cat<-as.factor(frt13$veg_cat)
frt13$aspect_cardinal<-as.factor(frt13$aspect_cardinal)
frt13$bec_zone_code<-as.factor(frt13$bec_zone_code)
table(frt13$bec_zone_code, frt13$pttype)

# note SWB has no locations that are burned. After consulting https://cfcg.forestry.ubc.ca/resources/cataloguing-in-situ-genetic-resources/swb-zone/
# I have decided to lump SWB and ESSF together.
frt13[bec_zone_code=="SWB", bec_zone_code:="ESSF"]

# scale variables
frt13$scale_climate1<-(frt13$climate1-mean(frt13$climate1, na.rm=TRUE)) / sd(frt13$climate1, na.rm=TRUE)
frt13$scale_climate2<-(frt13$climate2-mean(frt13$climate2, na.rm=TRUE)) / sd(frt13$climate2, na.rm=TRUE)
frt13$scale_dem<-(frt13$dem-mean(frt13$dem, na.rm=TRUE))/sd(frt13$dem, na.rm=TRUE)
frt13$scale_slope<-(frt13$slope_ha_bc-mean(frt13$slope_ha_bc, na.rm=TRUE)) / sd(frt13$slope_ha_bc, na.rm=TRUE)
frt13$scale_roads<-(frt13$dist_roads_m-mean(frt13$dist_roads_m, na.rm=TRUE)) / sd(frt13$dist_roads_m, na.rm=TRUE)
frt13$scale_infr<-(frt13$dist_infr_m-mean(frt13$dist_infr_m, na.rm=TRUE)) / sd(frt13$dist_infr_m, na.rm=TRUE)
frt13$scale_dist_ignit<-(frt13$rast_ignit_dist-mean(frt13$rast_ignit_dist, na.rm=TRUE)) / sd(frt13$rast_ignit_dist, na.rm=TRUE)
frt13$scale_pct_conifer<-(frt13$conifer_pct_cover_total-mean(frt13$conifer_pct_cover_total, na.rm=TRUE))/sd(frt13$conifer_pct_cover_total, na.rm=TRUE)
frt13$scale_age<-(frt13$proj_age_1-mean(frt13$proj_age_1, na.rm=TRUE))/sd(frt13$proj_age_1, na.rm=TRUE)
frt13$scale_basal_area<-(frt13$basal_area-mean(frt13$basal_area, na.rm=TRUE))/sd(frt13$basal_area, na.rm=TRUE)
```


Try fit glmer
```{r}
model1 <-  glmer (pttype ~ scale_climate1 * scale_climate2+ (1|fire_label), data=frt13, family = binomial (link = "logit"))
summary(model1)

model2 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + veg_cat + (1|fire_label), data=frt13, family = binomial (link = "logit"))
summary(model2)

model3 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate1*veg_cat + (1|fire_label), data=frt13, family = binomial (link = "logit"))
summary(model3)

model4 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + (1|fire_label), data=frt13, family = binomial (link = "logit"))
summary(model4)

model5 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate1*veg_cat + scale_climate2*veg_cat + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model5, type=3)

model6 <-  glmer (pttype ~ scale_climate1*veg_cat + scale_climate2*veg_cat + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model6, type=3)

AIC(model1, model2, model3, model4, model5, model6)

visreg(model4, "scale_climate1", by="scale_climate2")
visreg(model4, "scale_climate2", by="veg_cat")


model7 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope + aspect_cardinal + scale_dist_ignit + scale_age + scale_pct_conifer +bec_zone_code + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model7, type=3)

model8 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope + aspect_cardinal + poly(scale_dist_ignit,2) + scale_age + scale_pct_conifer +bec_zone_code + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model8, type=3)

model9 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope + aspect_cardinal + poly(scale_dist_ignit,2) + scale_age + scale_pct_conifer +bec_zone_code + log_infra + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model9, type=3)

model10 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope+ aspect_cardinal + scale_pct_conifer +bec_zone_code + log_infra + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model10, type=3)

model11 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope* aspect_cardinal + scale_pct_conifer +bec_zone_code + log_infra + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model11, type=3)

model12 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope* aspect_cardinal +bec_zone_code + log_infra + (1|fire_label), data=frt13, family = binomial (link = "logit"))
Anova(model12, type=3)
# I removed percent conifer because it was not very important
visreg(model12, "scale_climate1", by="scale_climate2")
visreg(model12, "scale_climate2", by="veg_cat")

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12)
# Try to get convergence
ss <- getME(model12,c("theta","fixef"))
m1 <- update(model12,start=ss,control=glmerControl(optCtrl=list(maxfun=2e5)))

# look at results
summary(m1)
Anova(m1)

# plot to see model fit
library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel =model7, plot = F)
#simulationOutput = recalculateResiduals(simulationOutput , group = frt13$fire_label)
plot(simulationOutput)
testOutliers(simulationOutput, type = 'bootstrap')
plotQQunif(simulationOutput) # left plot in plot.DHARMa()
plotResiduals(simulationOutput) # right plot in plot.DHARMa()
plotResiduals(simulationOutput, form =frt13$scale_climate1)
plotResiduals(simulationOutput, form =frt13$veg_cat ,quantreg = T)
plotResiduals(simulationOutput, form =frt13$scale_slope,quantreg = T )
plotResiduals(simulationOutput, form =frt13$aspect_cardinal, quantreg = T )
plotResiduals(simulationOutput, form =frt13$log_infra,quantreg = T )

testDispersion(simulationOutput) # I dont actually think I have overdispersion
plot(simulationOutput)
testZeroInflation(simulationOutput)

# model diagnostic plots

binnedplot (fitted(m1), 
            residuals(m1), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))



plot(predict(m1),residuals(m1))
abline(h=0,lty=2,col="grey")
lines(lowess(predict(m1),residuals(m1)),col="black",lwd=2)
#lines(preddat$fit+1.96*preddat$se.fit,residuals(m2) , col=2, lty=2, lwd=2)
#lines(preddat$fit-1.96*preddat$se.fit ~ preddat$fit, col=2, lty=2, lwd=2)


plot(frt13$scale_climate1,residuals(m1))
lines(lowess(frt13$scale_climate1,residuals(m1)),col="red",lwd=2)

plot(frt13$scale_slope,residuals(m1))
lines(lowess(frt13$scale_slope,residuals(m1)),col="red",lwd=2)

plot(frt13$scale_climate2,residuals(m1))
lines(lowess(frt13$scale_climate2,residuals(m1)),col="red",lwd=2)

plot(frt13$log_infra,residuals(m1))
lines(lowess(frt13$log_infra,residuals(m1)),col="red",lwd=2) # may have a quadratic effect


```


```{r}
saveRDS(m1, "C:/Work/caribou/castor/R/fire_sim/tmp/frt13.rds")
```

#### get AUC values
```{r}
# model12 <-  glmer (pttype ~ scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope* aspect_cardinal +bec_zone_code + log_infra + (1|fire_label), data=frt13, family = binomial (link = "logit"))



frt13_2<-frt13[, c("pttype", "scale_climate1","scale_climate2", "veg_cat", "scale_slope", "aspect_cardinal", "log_infra", "bec_zone_code")]

frt13_2<-as.data.frame(frt13_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt13_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt13_2[ trainIndex,]
   Valid <- frt13_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope* aspect_cardinal +bec_zone_code + log_infra, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"13"
top_mod_table_FRT5[1,2]<-"scale_climate1 * scale_climate2 + scale_climate2*veg_cat + scale_slope* aspect_cardinal +bec_zone_code + log_infra" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```


################################
#FRT 14
################################


```{r}
# Plot climate data results
frt14<-dat %>% filter(frt==14)
table(is.na(frt14$dem))
table(is.na(frt14$slope_ha_bc))
frt14<-frt14[!is.na(slope_ha_bc),]

frt14[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt14[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt14[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt14[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt14[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt14[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt14[bclcs_level_1 !="V", veg_cat:=6]

table(frt14$veg_cat, frt14$pttype)
frt14<-frt14[veg_cat!=6,]

frt14[veg_cat==5 & is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]
frt14[veg_cat==5 & is.na(proj_age_1), proj_age_1:=0]
frt14[veg_cat==5 & is.na(basal_area), basal_area:=0]
frt14<-(frt14[!is.na(proj_age_1),])
frt14[is.na(conifer_pct_cover_total), conifer_pct_cover_total:=0]


frt14$log_roads<-log(frt14$dist_roads_m+1)
frt14$log_infra<-log(frt14$dist_infr_m+1)
```

Test best climate variable
```{r}
frt14[,climate1:=(CMI03+CMI04+CMI05)/3]
model1 <- glm (pttype ~ climate1 ,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(CMI03+CMI04+CMI05+CMI06+CMI07+CMI08)/6]
model2 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(CMI06+CMI07+CMI08)/3]
model3 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmax03+Tmax04+Tmax05)/3]
model4 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate2:=(PPT03+PPT04+PPT05)/3]
model5 <- glm (pttype ~ climate2,
               data=frt14,
               family = binomial (link = "logit"))
model6 <- glm (pttype ~ climate1+climate2 ,
               data=frt14,
               family = binomial (link = "logit"))
model7 <- glm (pttype ~ climate1*climate2 ,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tave03+Tave04+Tave05)/3]
model8 <- glm (pttype ~ climate1 ,
               data=frt14,
               family = binomial (link = "logit"))
model9 <- glm (pttype ~ climate1+climate2 ,
               data=frt14,
               family = binomial (link = "logit"))
model10 <- glm (pttype ~ climate1*climate2 ,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
model11 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
model12 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model13 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
model14 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
frt14[,climate2:=(PPT06+PPT07+PPT08)/3]
model15 <- glm (pttype ~ climate2,
               data=frt14,
               family = binomial (link = "logit"))
model16 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model17 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tave06+Tave07+Tave08)/3]
model18 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
model19 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model20 <- glm (pttype ~ climate1*climate2 ,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmin06+Tmin07+Tmin08)/3]
model21 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
model22 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model23 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmax03+Tmax04+Tmax05+Tmax06+Tmax07+Tmax08)/6]
model24 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate2:=(PPT03+PPT04+PPT05+PPT06+PPT07+PPT08)/6]
model25 <- glm (pttype ~ climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tave03+Tave04+Tave05+Tave06+Tave07+Tave08)/6]
model26 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
model27 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model28 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(Tmin03+Tmin04+Tmin05+Tmin06+Tmin07+Tmin08)/6]
model29 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
model30 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))
model31 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

frt14[,climate1:=(RH03+RH04+RH05+RH06+RH07+RH08)/6]
model32 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
frt14[,climate1:=(CMD03+CMD04+CMD05+CMD06+CMD07+CMD08)/6]
model33 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))
frt14[,climate1:=(Tmax05 + Tmax06 + Tmax07 + Tmax08 + Tmax09)/5]
frt14[,climate2:=(PPT05 + PPT06 + PPT07 + PPT08 + PPT09)/5]
model34 <- glm (pttype ~ climate1,
               data=frt14,
               family = binomial (link = "logit"))

model35 <- glm (pttype ~ climate2,
               data=frt14,
               family = binomial (link = "logit"))
model36 <- glm (pttype ~ climate1 +climate2,
               data=frt14,
               family = binomial (link = "logit"))

model37 <- glm (pttype ~ climate1*climate2,
               data=frt14,
               family = binomial (link = "logit"))

AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10,model11, model12, model13, model14, model15, model16, model17, model18, model19, model20,model21, model22, model23, model24, model25, model26, model27, model28, model29, model30,model31, model32, model33,model34,model35,model36,model37)

# top climate model is model13
frt14[,climate1:=(Tmin03+Tmin04+Tmin05 + Tmin06 + Tmin07 + Tmin08)/6]
frt14[,climate1:=(Tmin03+Tmin04+Tmin05)/3]
frt14[,climate2:=(PPT03+PPT04+PPT05)/3]
model37 <- glm (pttype ~ climate1+climate2,
               data=frt14,
               family = binomial (link = "logit"))

visreg(model37, "climate1", by="climate2")
visreg(model37, "climate2", by="climate1")

```

```{r}
cor.test(frt14$climate1, frt14$dem) #these two are correlated
cor.test(frt14$climate2, frt14$dem)
cor.test(frt14$dist_roads_m, frt14$dist_infr_m) # correlated
cor.test(frt14$dem, frt14$slope_ha_bc)
cor.test(frt14$log_infra, frt14$log_roads)

require (ggcorrplot)
dist.cut.corr <- (frt14 [, c("climate1","climate2", "dem", "slope_ha_bc", "win_sum", "dist_roads_m", "dist_infr_m","rast_ignit_dist", "proj_age_1", "conifer_pct_cover_total" )])
corr <- round (cor (dist.cut.corr), 3)
p.mat <- round (cor_pmat (dist.cut.corr), 2)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3)

# note elevation and climate 1 are extremely highly correlated.
ggplot(frt14, aes(x = climate1)) +
  geom_boxplot() +
  facet_grid(pttype ~ .)
ggplot(frt14, aes(x = dem)) +
  geom_boxplot() +
  facet_grid(pttype ~ .)

# scale variables
frt14$scale_climate1<-(frt14$climate1-mean(frt14$climate1, na.rm=TRUE)) / sd(frt14$climate1, na.rm=TRUE)
frt14$scale_climate2<-(frt14$climate2-mean(frt14$climate2, na.rm=TRUE)) / sd(frt14$climate2, na.rm=TRUE)
frt14$scale_dem<-(frt14$dem-mean(frt14$dem, na.rm=TRUE))/sd(frt14$dem, na.rm=TRUE)
frt14$scale_slope<-(frt14$slope_ha_bc-mean(frt14$slope_ha_bc, na.rm=TRUE)) / sd(frt14$slope_ha_bc, na.rm=TRUE)
frt14$scale_roads<-(frt14$dist_roads_m-mean(frt14$dist_roads_m, na.rm=TRUE)) / sd(frt14$dist_roads_m, na.rm=TRUE)
frt14$scale_infr<-(frt14$dist_infr_m-mean(frt14$dist_infr_m, na.rm=TRUE)) / sd(frt14$dist_infr_m, na.rm=TRUE)
frt14$scale_dist_ignit<-(frt14$rast_ignit_dist-mean(frt14$rast_ignit_dist, na.rm=TRUE)) / sd(frt14$rast_ignit_dist, na.rm=TRUE)
frt14$scale_pct_conifer<-(frt14$conifer_pct_cover_total-mean(frt14$conifer_pct_cover_total, na.rm=TRUE))/sd(frt14$conifer_pct_cover_total, na.rm=TRUE)
frt14$scale_age<-(frt14$proj_age_1-mean(frt14$proj_age_1, na.rm=TRUE))/sd(frt14$proj_age_1, na.rm=TRUE)
frt14$scale_basal_area<-(frt14$basal_area-mean(frt14$basal_area, na.rm=TRUE))/sd(frt14$basal_area, na.rm=TRUE)

frt14$log_infra<-log(frt14$dist_infr_m+1)

table(frt14$bec_zone_code, frt14$pttype)
frt14$veg_cat<-as.factor(frt14$veg_cat)
frt14$aspect_cardinal<-as.factor(frt14$aspect_cardinal)
frt14$bec_zone_code<-as.factor(frt14$bec_zone_code)

frt14[bec_zone_code=="MH", bec_zone_code:="CWH"]
frt14$veg_cat<-as.factor(frt14$veg_cat)
```

## fits models
```{r}
model1 <-  glmer (pttype ~ scale_dem * scale_climate2+ (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model1)

model2 <-  glmer (pttype ~ scale_dem * scale_climate2 + veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model2)

model3 <-  glmer (pttype ~ scale_dem * scale_climate2 + scale_dem*veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model3)

model4a <-  glmer (pttype ~ scale_climate2 + scale_dem*veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model4a)

model4b <-  glmer (pttype ~ scale_dem + scale_climate2 + veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model4a)

model4c <-  glmer (pttype ~ I(scale_dem^2) + scale_climate2 + veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))

model4d <-  glmer (pttype ~ scale_dem + scale_climate2 * veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))

model4e <-  glmer (pttype ~ I(scale_dem^2) + scale_climate2 * veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))


model4 <-  glmer (pttype ~ scale_dem * scale_climate2 + scale_climate2*veg_cat + (1|fire_label), data=frt14, family = binomial (link = "logit"))
summary(model4)

model5 <-  glmer (pttype ~ poly(scale_dem,2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model5, type=3)

model6 <-  glmer (pttype ~ poly(scale_dem,2) + scale_climate2 + veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(m2, type=3)

model7 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model7, type=3)

model8 <-  glmer (pttype ~ scale_dem +  scale_climate2 * veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + scale_dist_ignit + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model7, type=3)

model9 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model9, type=3)

# my relationship with weather seems wrong. Maybe its because dist_ignit is messing it up. So looking at model9 that does not have distignit to check.

# Im going to try join veg_cat2 and veg_cat3 because the relationship between climate2 and veg_cat3 does not make much sense. Also all the data for veg_cat3 is clustered around high rainfall and does not extend out across the range of rainfalls which is maybe why it has a funny trend

frt14[veg_cat=="3", veg_cat:="2"]
model10 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + scale_pct_conifer + scale_slope + aspect_cardinal + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model10, type=3)

model11 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + scale_pct_conifer + aspect_cardinal + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model11, type=3)

model12 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + log_infra+ bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model12, type=3)

visreg(model12, "scale_climate2", by="veg_cat")
visreg(model9)

model13 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + bec_zone_code +  (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model13, type=3)
visreg(model13)

model14 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + bec_zone_code + scale_basal_area + (1|fire_label), data=frt14, family = binomial (link = "logit"))
Anova(model14, type=3)
visreg(model14)

frt14[is.na(scale_basal_area), scale_basal_area:=0]

model15 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + I(scale_dem^2) + aspect_cardinal + bec_zone_code + scale_basal_area + (1|fire_label), data=frt14, family = binomial (link = "logit"))


AIC(model1, model2, model3, model4, model4a, model4b, model4c, model4d, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14, model15)


library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model16, plot = F)
plot(simulationOutput)
testOutliers(simulationOutput, type = 'bootstrap')
testDispersion(simulationOutput, plot=T)
plotQQunif(simulationOutput) # left plot in plot.DHARMa()
plotResiduals(simulationOutput) # right plot in plot.DHARMa()
plotResiduals(simulationOutput, form =frt14$scale_climate1)
plotResiduals(simulationOutput, form =frt14$veg_cat ,quantreg = T)
plotResiduals(simulationOutput, form =frt14$scale_slope,quantreg = T )
plotResiduals(simulationOutput, form = frt14$aspect_cardinal, quantreg = T )
plotResiduals(simulationOutput, form =frt14$log_infra,quantreg = T )

#model16 <- glmer (pttype ~ scale_climate2+ veg_cat + veg_cat:scale_pct_conifer + poly(scale_dem,2) + log_roads + poly(scale_dist_ignit,2) + scale_age + scale_pct_conifer + 

plot(predict(model14),residuals(model14))
abline(h=0,lty=2,col="grey")
lines(lowess(predict(model14),residuals(model14)),col="black",lwd=2)

plot(frt14$scale_climate2,residuals(model15))
lines(lowess(frt14$scale_climate2,residuals(model15)),col="black",lwd=2)

plot(frt14$scale_dem,residuals(model15))
lines(lowess(frt14$scale_dem,residuals(model15)),col="black",lwd=2)

plot(frt14$scale_pct_conifer,residuals(model15))
lines(lowess(frt14$scale_pct_conifer,residuals(model15)),col="black",lwd=2)

plot(frt14$scale_dist_ignit,residuals(model15))
lines(lowess(frt14$scale_dist_ignit,residuals(model15)),col="black",lwd=2)

plot(frt14$log_roads,residuals(model15))
lines(lowess(frt14$log_roads,residuals(model15)),col="black",lwd=2)

plot(frt14$scale_age,residuals(model15))
lines(lowess(frt14$scale_age,residuals(model15)),col="black",lwd=2)

ss <- getME(model14,c("theta","fixef"))
m4 <- update(model14,start=ss,control=glmerControl(optCtrl=list(maxfun=2e4))) # BIC 164056.46 
summary(m4)
car::Anova(m4, type=3)
visreg(m4)


# model diagnostic plots
# below model looks way better with log road dist. It had some structure with just road dist
binnedplot (fitted(model14), 
            residuals(model14), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))


```


```{r}
saveRDS(model14, "C:/Work/caribou/castor/R/fire_sim/tmp/frt14.rds")
```



#### get AUC values
```{r}
# model14 <-  glmer (pttype ~ scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + bec_zone_code + scale_basal_area + (1|fire_label), data=frt14, family = binomial (link = "logit"))




frt14_2<-frt14[, c("pttype", "scale_dem","scale_climate2", "veg_cat", "scale_slope", "aspect_cardinal", "scale_age", "scale_basal_area", "bec_zone_code")]

frt14_2<-as.data.frame(frt14_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt14_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt14_2[ trainIndex,]
   Valid <- frt14_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + bec_zone_code + scale_basal_area, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"14"
top_mod_table_FRT5[1,2]<-"scale_dem+ I(scale_dem^2) + scale_climate2 * veg_cat + scale_age + aspect_cardinal + bec_zone_code + scale_basal_area" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```



################################
#FRT 15
################################

```{r}
# Plot climate data results

frt15<-dat %>% filter(frt==15)



frt15[is.na(proj_age_1) & bclcs_level_1=="V", proj_age_1:=0]
frt15[bclcs_level_4 == "TC" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=1]
frt15[bclcs_level_4 == "TM" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=2]
frt15[bclcs_level_4 == "TB" & basal_area >= 8 & proj_height_1 >=4, veg_cat:=3]
frt15[bclcs_level_4 %in% c("TC", "TM", "TB") & (basal_area < 8 | is.na(basal_area) | proj_height_1 <4 | is.na(proj_height_1)), veg_cat:=4]
frt15[bclcs_level_1 =="V" & !bclcs_level_4 %in% c("TC", "TM", "TB"), veg_cat:=5]
frt15[bclcs_level_1 !="V", veg_cat:=6]

table(frt15$veg_cat, frt15$pttype)
frt15<-frt15[veg_cat!=6,]

table(frt15$veg_cat, frt15$pttype)


frt15[,climate1:=(Tmax06+Tmax07+Tmax08)/3]
frt15[,climate2:=(PPT06+PPT07+PPT08)/3]

require (ggcorrplot)
dist.cut.corr <- (frt15 [, c("climate1", "climate2", "dem", "slope_ha_bc", "dist_infr_m", "dist_roads_m")])
corr <- round (cor (dist.cut.corr), 3)
p.mat <- round (cor_pmat (dist.cut.corr), 2)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3)

model1 <- glm (pttype ~ climate1 + climate2 ,
               data=frt15,
               family = binomial (link = "logit"))
summary(model1)

model2 <- glm (pttype ~ climate1 * climate2 ,
               data=frt15,
               family = binomial (link = "logit"))
summary(model2)

model3 <- glm (pttype ~ climate1 + climate2 + veg_cat,
               data=frt15,
               family = binomial (link = "logit"))

model4 <- glm (pttype ~ climate1 + climate2 + veg_cat + aspect_cardinal + slope_ha_bc + log(dist_infr_m+1),
               data=frt15,
               family = binomial (link = "logit"))
Anova(model4)

model5 <- glm (pttype ~ climate1 + veg_cat + aspect_cardinal + slope_ha_bc +conifer_pct_cover_total + bec_zone_code,
               data=frt15,
               family = binomial (link = "logit"))
Anova(model5)

AIC (model1, model2, model3, model4, model5)

frt15[veg_cat=="2", veg_cat:="3"]

model5 <- glm (pttype ~ climate1 + veg_cat + aspect_cardinal + slope_ha_bc +conifer_pct_cover_total, data=frt15, family = binomial (link = "logit"))
Anova(model5)

visreg(model5, scale="response")
# Note climate 1 and dem, and win_spg and win_sum are correlated



# model diagnostic plots
# below model looks way better with log road dist. It had some structure with just road dist
binnedplot (fitted(model5), 
            residuals(model5), 
            nclass = NULL, 
            xlab = "Expected Values", 
            ylab = "Average residual", 
            main = paste("Binned Residual Plot - glm"))
```



#### get AUC values
```{r}
# model5 <- glm (pttype ~ climate1 + veg_cat + aspect_cardinal + slope_ha_bc +conifer_pct_cover_total, data=frt15, family = binomial (link = "logit"))




frt15_2<-frt15[, c("pttype", "climate1", "veg_cat", "slope_ha_bc", "aspect_cardinal", "conifer_pct_cover_total")]

frt15_2<-as.data.frame(frt15_2)

top_mod_table_FRT5_ALL <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5_ALL ) <- c ("FRT", "Model_terms",
                                         "AUC")

for (g in 1:100){
  
  print(g)

prop<-0.75

# Creating training and testing datasets so that I can get a measure of how well the model actually predicts the data e.g. AUG
  trainIndex <- createDataPartition(frt15_2$pttype, p = prop,
                                    list = FALSE,
                                    times = 1)
  
   dat1 <- frt15_2[ trainIndex,]
   Valid <- frt15_2[-trainIndex,]
   
#Model   
model.FRT10<-glm(pttype ~  climate1 + veg_cat + aspect_cardinal + slope_ha_bc +conifer_pct_cover_total, family = binomial, data = dat1) 

mod.valid <- predict.glm(model.FRT10, newdata=Valid, type="response")
   roc_obj <- roc(Valid[,"pttype"], mod.valid, quiet=TRUE)
   mod.auc <- auc(roc_obj)
   
   top_mod_table_FRT5 <- data.frame (matrix (ncol = 3, nrow = 0))
colnames (top_mod_table_FRT5 ) <- c ("FRT", "Model_terms",
                                         "AUC")
##Add data for NDT1
top_mod_table_FRT5[1,1]<-"15"
top_mod_table_FRT5[1,2]<-"climate1 + veg_cat + aspect_cardinal + slope_ha_bc +conifer_pct_cover_total" 
top_mod_table_FRT5[1,3]<- mod.auc

top_mod_table_FRT5_ALL<-rbind(top_mod_table_FRT5_ALL, top_mod_table_FRT5)

}

FRT5_summary_table_mean<- top_mod_table_FRT5_ALL %>% summarize_if(is.numeric,mean)


```



Save table.

```{r}
write.csv(frt15_summary_table_mean, file="C:\\Work\\caribou\\castor_data\\Fire\\Fire_sim_data\\data\\BC\\top_mod_table_frt15_spread.csv")
```


###############DATA PREP COMPLETE###################
