---
title: "inla_baysian_coregional"
author: "Kyle Lochhead"
date: "2024-09-26"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(here::here("R/functions/R_Postgres.R"))
library(data.table)
library(sf)
library(tidyverse)
library(glmmTMB)
library(DHARMa)
library(sdmTMB)
library(INLA)
```

## Data
```{r}
data.lightning<-readRDS("data_lightning_occurence_10k.rds")
occ.model.data<-data.lightning[!is.na(CMI3yr),][,dCMI3yr:=CMI-(CMI3yr/3)][, coast:=0][frt==15, coast:=1][,flammable:=con + mix + dec + young + veg][flammable >0, ][, year:= as.factor(FIRE_YEAR)][!is.na(fire_centre),]

occ.model.data<-occ.model.data[, avgCMIProv:=sum(CMI)/.N, by = c("FIRE_YEAR")][,dry:=0][avgCMIProv < -0.47, dry :=1][,year:=as.integer(year)]

# Determine threshold
threshold<-occ.model.data[, .(count = sum(count), avgCMIProv = min(avgCMIProv) ), by = FIRE_YEAR]
#saveRDS(threshold, "avgCMIProv10k.rds")

#Set the trainingset
occ.model.data.train<-occ.model.data[FIRE_YEAR < 2018, ]
occ.model.data.train$frt<-as.factor(occ.model.data.train$frt)
occ.model.data.train<-cbind(occ.model.data.train, model.matrix( ~ 0 + frt, data=occ.model.data.train ))


locations<-cbind(occ.model.data.train$x, occ.model.data.train$y)
mesh<-inla.mesh.2d(locations, max.edge = c(100,800), cutoff = 15)
plot(mesh)
points(locations, col = "red", pch = 2)
```

#Model for occurence is a Poisson process
```{r}
#Fit in INLA
A_Matrix<-inla.spde.make.A(mesh, loc = locations)

fire.spde = inla.spde2.pcmatern(mesh = mesh, prior.range = c(400, 0.5), prior.sigma = c(.5, .5)) 

#Transforms
occ.model.data.train$log_flammable<-log(occ.model.data.train$flammable)

f1 <- as.formula(paste0("y ~ -1 + Intercept + CMI_MIN + dCMI3yr + avgCMIProv + log_con + log_dec + frt5 + frt7 + frt9 + frt10 + frt11 + frt12 + frt13 + frt14 + frt15 +  offset(log_flammable)  + f(spatial1, model = fire.spde)"))

s.index <- inla.spde.make.index(name = "spatial1",                                n.spde = fire.spde$n.spde,                                n.group = 1,  n.repl = 1)

StackFire <- inla.stack(
  data = list(y = occ.model.data.train$count),
  A = list(A_Matrix,1),              
  effects = list(c(s.index, list(Intercept = 1)), list(CMI_MIN = occ.model.data.train$CMI_MIN, dCMI3yr = occ.model.data.train$dCMI3yr,avgCMIProv =occ.model.data.train$avgCMIProv,  log_con =log(occ.model.data.train$con + 1), log_dec =log(occ.model.data.train$dec + 1) , frt5 = occ.model.data.train$frt5, frt7 = occ.model.data.train$frt7, frt9 = occ.model.data.train$frt9, frt10 = occ.model.data.train$frt10, frt11 = occ.model.data.train$frt11, frt12 = occ.model.data.train$frt12, frt13 = occ.model.data.train$frt13, frt14 = occ.model.data.train$frt14, frt15 = occ.model.data.train$frt15, log_flammable = log(occ.model.data.train$flammable))
    ) 
)

IM1 <- inla(f1, 
            family = "nbinomial",
            data = inla.stack.data(StackFire, spde=fire.spde),
            control.family=list(list(link="log")),
            control.compute = list(dic = TRUE),
            control.predictor = list(A = inla.stack.A(StackFire), compute=TRUE , link =1),
            control.fixed = list(mean=list(Intercept=-18, CMI_MIN=-0.118, dCMI3yr = -0.3, log_con = 0.5, log_young = 0.1, log_dec = -0.1, frt5 = -0.7, frt7 = -1.5, frt9 =-1.75, frt10 =1.8, frt11 =-1.1, frt12 =-1.2, frt13 = -1.6, frt14 = -1, frt15 =-3, default=0)),
            control.inla = list(int.strategy = "eb")
)
```

#Diagonistics