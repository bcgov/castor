---
title: "05_RSF_analysis"
author: "Elizabeth Kleynhans"
date: "01/04/2020"
output:
  bookdown::html_document2
---
  
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (dplyr)
library (ggplot2)
library (lme4)
library (arm)
library (car)
library (optimx)
library (dfoptim)
library (kableExtra)
library (here)
library (magick)
library (data.table)
require (ggcorrplot)
require (sf)
require (RPostgreSQL)
require (rpostgis)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(ggeffects)
library(cowplot)
library(ggpubr)
library(mgcv)
library(mgcViz)


```


## Introduction {#intro}
Here I develop statistical models to quantify the effect of forestry disturbance on caribou distribution. The intent is to use the models to indicate the influence of current and potential future forestry development on caribou use of habitat. The model may be added to the pre-existing rsf module in the caribou and land use simulator (CLUS). This is because this model is run at a larger spatial scale (Second-order selection) than the existing rsf model (Third-order selection). Following [DeCesare et al. 2012](https://esajournals.onlinelibrary.wiley.com/doi/10.1890/11-1610.1) second-order selection compares  points sampled within individual caribou home ranges (used) to points sampled within the population home range (available), while third-order selection compares individual caribou telemetry locations (used) to points sampled within the individual caribou's home range (available). By multiplying the probabilities of  second- and third-order selection together one can estimate an integrated relative probability of use for a given pixel on the landscape. For this analysis I fitted separate second-order selection models for the four caribou designatable units (DUs) in British Columbia (BC): DU6, boreal; DU7, northern mountain; DU8, central mountain; and DU9, southern mountain, as defined by the [Committee on the Status of Endangered Wildlife in Canada (COSEWIC)](https://www.registrelep-sararegistry.gc.ca/default.asp?lang=En&n=E6271D78-1&offset=2#_01_4). DUs were modeled independently, as they are intended to represent groups of caribou with unique ecological characteristics, and potentially different responses to forestry disturbance. 

I use a resource selection function (RSF) framework to develop the statistical models ( [Boyce et al. 1999](https://www.sciencedirect.com/science/article/pii/S0169534799015931), [Johnson et al. 2006](https://wildlife.onlinelibrary.wiley.com/doi/pdf/10.2193/0022-541X%282006%2970%5B347%3ARSFBOU%5D2.0.CO%3B2)). This framework uses a logit regression model to calculate the relationship between caribou occurence and habitat 'resources' measured using spatial data. Here I am only considering the effect of forestry disturbance 'resources', i.e., cutblocks and roads, on caribou occurrence. This approach simplifies and focuses the RSF onto modeling a statistical relationship between caribou distribution and forestry disturbance that is generalizable across a caribou DU, and is not designed to accurately identify other habitat features that influence caribou distribution. The theoretical basis for this approach is that forestry disturbance has a significant influence on caribou distribution, regardless of other habitat features. Indeed, cutblocks and linear features from forestry have routinely been shown to influence caribou distribution (e.g., [Courbin et al. 2009](https://link.springer.com/article/10.1007/s10980-009-9389-x), [DeCesare et al. 2012](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/11-1610.1), [Mumma et al. 2018](https://www.sciencedirect.com/science/article/pii/S0006320718307225)) and survival ( [Wittmer et al. 2007](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2656.2007.01220.x), [Johnson et al. 2015](https://www.sciencedirect.com/science/article/pii/S0006320715001160)).

The caribou-forestry disturbance models (CFDMs) created here can be used as a spatial indicator of current and simulated future effects of forestry activity on caribou habitat quality. For example, the sum of CFDM outputs can be calculated within caribou herd ranges or critical habitat types, and changes in the sum value over time can be used to indicate changes in forestry disturbance influencing caribou habitat quality.

## Methods {#methods}

I calculated the CFDMs using generalized linear mixed models (GLMMs) with a logit link, using the [glmer function](https://www.rdocumentation.org/packages/lme4/versions/1.1-21/topics/glmer) from the [lme4](https://cran.r-project.org/web/packages/lme4/lme4.pdf) package in [program R](https://www.r-project.org/). The model investigated whether locations within the individual home ranges of caribou were further from disturbance than randomly sampled locations within the BC defined population home ranges.

Individual home ranges of caribou were calculated by Tyler Muhley following the methods described in the folder caribou_habitat (12_RSF_version4.Rmd). Briefly caribou location data was collected from telemetry collars placed on a sample of caribou (n = 468 animals, 507,987 locations) from across BC, between 2008 to 2018. These telemetry locations were then used to create seasonal home ranges of individual collared animals within herds for each year. However, for this analysis I lumped the seasonal home ranges together to get a annual home range for each animal. Home ranges for animals within the same herd were also amalgamated to get a herd by year individual home range. From these herd by year home ranges I sampled points on a 300m x 300m grid. These points became the ones in this analysis.


BC defined population home ranges were downloaded from [https://catalogue.data.gov.bc.ca/dataset/caribou-herd-locations-for-bc]. A buffer of 25km was created around each home range. If the buffer overlapped another herds home range, the overlapping area was clipped out. For each year I also clipped out the individual home ranges (estimated above) for each radio collared animal sampled in that year. After clipping and buffering the BC home range, data points were sampled every kilometer in the remaining area. This created an average of 10 000 point per home range per year.

I estimated the distance of 'used' and 'available' caribou locations to the nearest resource road and cutblock. Cutblock locations were estimated using the [consolidated cutblocks](https://catalogue.data.gov.bc.ca/dataset/harvested-areas-of-bc-consolidated-cutblocks-) data compiled by the BC government. Road locations were estimated using data compiled to support the [British Columbia Cumulative Effects Framework](https://www2.gov.bc.ca/gov/content/environment/natural-resource-stewardship/cumulative-effects-framework). This data is not accessible to the public via a webpage, but it is not private or proprietary, and thus can be requested from the cumulative effects program. The roads data classifies roads into various types. Our focus was on roads developed specifically for resource extraction (particularly forestry), thus, we classified all unpaved road types as 'resource roads' and estimated caribou distance to these types. Cutblock and roads data were rasterized at a 1ha resolution, and the Euclidean distance of each raster pixel to a cutblock or resource road in the pixel was calculated in QGIS and attributed to corresponding 'used' and 'available' caribou locations.

I fitted GLMMs with distance to cutblock and distance to road covariates as fixed effects and random effects at the herd and year levels. Year was included to account variability in harvesting The random effects accounted for variation in the herd and year response to cutblocks and roads in the model, so that the fixed effects coefficients can be considered as 'population‚Äêlevel' effects (i.e.,the effect on an 'average' animal) of cutblocks and roads on caribou distribution ( [Gillies et al. 2006](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2656.2006.01106.x)). 


```{r, Load data, eval = T, echo = F, message = F, error = F, results = 'hide'}
# load data

conn <- dbConnect (dbDriver ("PostgreSQL"), 
                   host = "",
                   user = "postgres",
                   dbname = "postgres",
                   password = "postgres",
                   port = "5432")
Range_scale_data <- sf::st_read  (dsn = conn, # connKyle
                               query = "SELECT * FROM caribou.dist_to_disturbance_summary")
dbDisconnect (conn) # connKyle

Range_scale_data1<-st_set_geometry(Range_scale_data,NULL)

#convert distances to km. I created distance rasters in QGIS in pixel (ha) scale so here I convert the number of pixels i.e. ha between points to km

Range_scale_data1$distance_to_cut_1yo<-Range_scale_data1$distance_to_cut_1yo/100
Range_scale_data1$distance_to_cut_2yo<-Range_scale_data1$distance_to_cut_2yo/100
Range_scale_data1$distance_to_cut_3yo<-Range_scale_data1$distance_to_cut_3yo/100
Range_scale_data1$distance_to_cut_4yo<-Range_scale_data1$distance_to_cut_4yo/100
Range_scale_data1$distance_to_cut_5yo<-Range_scale_data1$distance_to_cut_5yo/100
Range_scale_data1$distance_to_cut_6yo<-Range_scale_data1$distance_to_cut_6yo/100
Range_scale_data1$distance_to_cut_7yo<-Range_scale_data1$distance_to_cut_7yo/100
Range_scale_data1$distance_to_cut_8yo<-Range_scale_data1$distance_to_cut_8yo/100
Range_scale_data1$distance_to_cut_9yo<-Range_scale_data1$distance_to_cut_9yo/100
Range_scale_data1$distance_to_cut_10yo<-Range_scale_data1$distance_to_cut_10yo/100
Range_scale_data1$distance_to_cut_11yo<-Range_scale_data1$distance_to_cut_11yo/100
Range_scale_data1$distance_to_cut_12yo<-Range_scale_data1$distance_to_cut_12yo/100
Range_scale_data1$distance_to_cut_13yo<-Range_scale_data1$distance_to_cut_13yo/100
Range_scale_data1$distance_to_cut_14yo<-Range_scale_data1$distance_to_cut_14yo/100
Range_scale_data1$distance_to_cut_15yo<-Range_scale_data1$distance_to_cut_15yo/100
Range_scale_data1$distance_to_cut_16yo<-Range_scale_data1$distance_to_cut_16yo/100
Range_scale_data1$distance_to_cut_17yo<-Range_scale_data1$distance_to_cut_17yo/100
Range_scale_data1$distance_to_cut_18yo<-Range_scale_data1$distance_to_cut_18yo/100
Range_scale_data1$distance_to_cut_19yo<-Range_scale_data1$distance_to_cut_19yo/100
Range_scale_data1$distance_to_cut_20yo<-Range_scale_data1$distance_to_cut_20yo/100
Range_scale_data1$distance_to_cut_21yo<-Range_scale_data1$distance_to_cut_21yo/100
Range_scale_data1$distance_to_cut_22yo<-Range_scale_data1$distance_to_cut_22yo/100
Range_scale_data1$distance_to_cut_23yo<-Range_scale_data1$distance_to_cut_23yo/100
Range_scale_data1$distance_to_cut_24yo<-Range_scale_data1$distance_to_cut_24yo/100
Range_scale_data1$distance_to_cut_25yo<-Range_scale_data1$distance_to_cut_25yo/100
Range_scale_data1$distance_to_cut_26yo<-Range_scale_data1$distance_to_cut_26yo/100
Range_scale_data1$distance_to_cut_27yo<-Range_scale_data1$distance_to_cut_27yo/100
Range_scale_data1$distance_to_cut_28yo<-Range_scale_data1$distance_to_cut_28yo/100
Range_scale_data1$distance_to_cut_29yo<-Range_scale_data1$distance_to_cut_29yo/100
Range_scale_data1$distance_to_cut_30yo<-Range_scale_data1$distance_to_cut_30yo/100
Range_scale_data1$distance_to_cut_31yo<-Range_scale_data1$distance_to_cut_31yo/100
Range_scale_data1$distance_to_cut_32yo<-Range_scale_data1$distance_to_cut_32yo/100
Range_scale_data1$distance_to_cut_33yo<-Range_scale_data1$distance_to_cut_33yo/100
Range_scale_data1$distance_to_cut_34yo<-Range_scale_data1$distance_to_cut_34yo/100
Range_scale_data1$distance_to_cut_35yo<-Range_scale_data1$distance_to_cut_35yo/100
Range_scale_data1$distance_to_cut_36yo<-Range_scale_data1$distance_to_cut_36yo/100
Range_scale_data1$distance_to_cut_37yo<-Range_scale_data1$distance_to_cut_37yo/100
Range_scale_data1$distance_to_cut_38yo<-Range_scale_data1$distance_to_cut_38yo/100
Range_scale_data1$distance_to_cut_39yo<-Range_scale_data1$distance_to_cut_39yo/100
Range_scale_data1$distance_to_cut_40yo<-Range_scale_data1$distance_to_cut_40yo/100
Range_scale_data1$distance_to_cut_41yo<-Range_scale_data1$distance_to_cut_41yo/100
Range_scale_data1$distance_to_cut_42yo<-Range_scale_data1$distance_to_cut_42yo/100
Range_scale_data1$distance_to_cut_43yo<-Range_scale_data1$distance_to_cut_43yo/100
Range_scale_data1$distance_to_cut_44yo<-Range_scale_data1$distance_to_cut_44yo/100
Range_scale_data1$distance_to_cut_45yo<-Range_scale_data1$distance_to_cut_45yo/100
Range_scale_data1$distance_to_cut_46yo<-Range_scale_data1$distance_to_cut_46yo/100
Range_scale_data1$distance_to_cut_47yo<-Range_scale_data1$distance_to_cut_47yo/100
Range_scale_data1$distance_to_cut_48yo<-Range_scale_data1$distance_to_cut_48yo/100
Range_scale_data1$distance_to_cut_49yo<-Range_scale_data1$distance_to_cut_49yo/100
Range_scale_data1$distance_to_cut_50yo<-Range_scale_data1$distance_to_cut_50yo/100
Range_scale_data1$dist_crds_resource<-Range_scale_data1$dist_crds_resource/1000 # dividing by 1000 because the distance raster was created by Tyler and this is what he does in his script to convert his values to km.
Range_scale_data1$dist_crds_loose<-Range_scale_data1$dist_crds_loose/1000
Range_scale_data1$dist_crds_paved<-Range_scale_data1$dist_crds_paved/1000
Range_scale_data1$dist_crds_petroleum<-Range_scale_data1$dist_crds_petroleum/1000
Range_scale_data1$dist_crds_rough<-Range_scale_data1$dist_crds_rough/1000
Range_scale_data1$dist_crds_trim_transport<-Range_scale_data1$dist_crds_trim_transport/1000
Range_scale_data1$dist_crds_unknown<-Range_scale_data1$dist_crds_unknown/1000

Range_scale_data1$cnt<-1

#write.csv(Range_scale_data1, file="C:\\Work\\caribou\\clus\\R\\range_scale_habitat_analysis\\data\\Range_scale_data.csv")

#Range_scale_data1$distance_to_resource_road<-Range_scale_data1$dist_crds_resource
#Range_scale_data1$distance_to_resource_road_log<-log(Range_scale_data1$distance_to_resource_road+0.00001)


# Binning the data into cutblock age categories and binned distance to the disturbance
Range_scale_data1 <- dplyr::mutate (Range_scale_data1, distance_to_cut_1to5yo = pmin (distance_to_cut_1yo, distance_to_cut_2yo, distance_to_cut_3yo, distance_to_cut_4yo, distance_to_cut_5yo))

Range_scale_data1 <- dplyr::mutate (Range_scale_data1, distance_to_cut_6to10yo = pmin (distance_to_cut_6yo, distance_to_cut_7yo,distance_to_cut_8yo, distance_to_cut_9yo, distance_to_cut_10yo))

Range_scale_data1 <- dplyr::mutate (Range_scale_data1, distance_to_cut_11to40yo = pmin (distance_to_cut_11yo, distance_to_cut_12yo, distance_to_cut_13yo, distance_to_cut_14yo,distance_to_cut_15yo,distance_to_cut_16yo, distance_to_cut_17yo, distance_to_cut_18yo, distance_to_cut_19yo,distance_to_cut_20yo,distance_to_cut_21yo, distance_to_cut_22yo, distance_to_cut_23yo, distance_to_cut_24yo, distance_to_cut_25yo, distance_to_cut_26yo, distance_to_cut_27yo, distance_to_cut_28yo, distance_to_cut_2yo, distance_to_cut_30yo, distance_to_cut_31yo, distance_to_cut_32yo, distance_to_cut_33yo, distance_to_cut_34yo, distance_to_cut_35yo, distance_to_cut_36yo, distance_to_cut_37yo,distance_to_cut_38yo, distance_to_cut_39yo, distance_to_cut_40yo))

Range_scale_data1 <- dplyr::mutate (Range_scale_data1, distance_to_road = pmin (dist_crds_resource))


```


```{r}
Snake<-Range_scale_data1 %>% filter(HERD_NAME=="Snake-Sahtaneh")
dist.cut.corr <- (Snake [c (65:68)])
corr <- round (cor (dist.cut.corr), 3)
p.mat <- round (cor_pmat (dist.cut.corr), 2)
ggcorrplot (corr, type = "lower", lab = TRUE, tl.cex = 10,  lab_size = 3,
            title = "Snake Distance to Cutblock Correlation")

ggplot (Snake, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to roads(km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

ggplot (Snake, aes (x = as.factor(pttype), y = distance_to_cut_1to5yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to 1 to 5 yo cutblocks (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

ggplot (Snake, aes (x = as.factor(pttype), y = distance_to_cut_6to10yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to 6 to 10 yo cutblocks (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

ggplot (Snake, aes (x = as.factor(pttype), y = distance_to_cut_11to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to 11 to 40 yo cutblocks (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

```

```{r}
model.snake <- glm (pttype ~ distance_to_road +
                                         distance_to_cut_1to5yo +
                                         distance_to_cut_6to10yo +
                                         distance_to_cut_11to40yo,
                                      data = Snake, 
                                      family = binomial (link = "logit")) 
summary(model.snake)

binnedplot (predict (model.snake), 
             residuals(model.snake, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")


```


## Results
### DU6
In DU6, the home ranges of individual animals were calculated from 160 animals from the Calendar, Chinchaga, Maxhamish, Parker and Prophet (now grouped together and known as Westside Fort Nelson), and Snake-Sahtaneh herds. Number of used and available sample points are presented in Table \@ref(tab:du6-sample-size)

```{r du6-sample-size, eval = T, echo = F, message = F, eval = T}

# number of animals, by herd
du6<- Range_scale_data1 %>% filter(du=="du6")

count.individual.home.range <- du6  %>%
  filter(pttype==1) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Used=count)

count.herd.range <- du6  %>%
  filter(pttype==0) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Available=count)


summary_du6 <- du6 %>% 
  group_by(HERD_NAME, pttype) %>% 
  summarise(mean=mean(distance_to_road),
            sd = sd(distance_to_road),
            count = sum(cnt),
            se= sd(distance_to_road)/(sqrt(sum(cnt))))



table <- full_join(count.individual.home.range, count.herd.range)


kable (table,
       caption = "<b>Number of points sampled in individual caribou home ranges (Used - 1's) and across the herd ranges (Available - 0's) in DU6 (Boreal).<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 

```

#### Herd-Level Effect of Forestry on Caribou Distribution
Overall there was a slight tendency for caribou in DU 6 to avoid roads but this relationship was not signficant (fig \@ref(fig:du6road-effect-plot)). For example, caribou in the Chinchaga, Maxhamish, Parker and Prophet herds were further from roads than what was available on average in their home range but the opposite pattern was observed in Calendar and Snake-Sahtaneh. Due to these differences in relationships a random effect for distance to road was included in the GLMM. 


```{r du6road-effect-plot, fig.cap="Distance to Resource Road at Available (0) and Used (1) Locations by Caribou Herd in DU6", echo = F, message = F, eval = T}

ggplot (du6, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock(km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

There was a non-significant tendency for caribou to avoid to 1 to 5 year old cutblocks in DU6 (Fig. \@ref(fig:du6-cutblock-1to5yo)). For example, caribou in all herds except Calendar tended to utlize habitat slightly further from 1 to 5 year old cutblocks than what was available. In contrast the Calendar herd showed no preference or avoidance of 1 to 5 year old cutblocks. We included random effect for distance to 1 to 5 year old cutblocks in the GLMM to account for the variability in preference between herds.

```{r du6-cutblock-1to5yo, fig.cap="Distance to 1 to 5 year old cutblock at available (0) and used (1) locations by caribou herds in DU6", echo = F, message = F, eval = T}
ggplot (du6, aes (x = as.factor(pttype), y = distance_to_cut_1to5yo)) +
  geom_violin() +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

There was variability in the response of caribou herds to 6 to 10 year old cutblocks in DU6 (Fig. \@ref(fig:du6-cutblock-6to10yo)). Caribou in the Chinchaga, Maxhamish, Parker, and Snake-Sahtaneh herds were further from 6 to 10 year old cutblocks than what was available on average in their home range. In contrast Calendar and Prophet were slightly closer to 5 to 10 year old cutblocks than what was available on average. A random effect for distance to 6 to 10 year old cutblocks was included in the GLMM to account for this variability.

```{r du6-cutblock-6to10yo,fig.cap="Distance to 6 to 10 year old cutblock at available (0) and used (1) locations by caribou herds in DU6", echo = F, message = F, eval = T}
ggplot (du6, aes (x = as.factor(pttype), y = distance_to_cut_6to10yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock(km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

All Caribou herds were further from 11 to 40 years old cutblocks than what was available on average in DU6 (Fig. \@ref(fig:du6-cutblock-11to40yo)). Although the trends were similar across herds the degree of this difference varied thus a random effect for distance to 11 to 50 year old cutblocks was included in the GLMM.

```{r du6-cutblock-11to40yo,fig.cap="Distance to 11 to 50 year old cutblock at available (0) and used (1) locations by caribou herds in DU6", echo = F, message = F, eval = T}
ggplot (du6, aes (x = as.factor(pttype), y = distance_to_cut_11to40yo)) +
  geom_violin() +
  geom_boxplot (width=0.1, outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

#### Year-Level Effect of Forestry on Caribou Distribution

The response of caribou herds to forestry disturbances also varied by year.  Two examples are the Calendar (Fig. \@ref(fig:du6-CalendarHerdByYear)) and Prophet (Fig. \@ref(fig:du6-ProphetHerdByYear)) herds who showed both positive and negative responses to distance to 1 to 5 year old cutblocks and 6 to 10 year old cutblocks in different years. To control for this variability in the response across years I included year as a random effect in the GLMM. 

```{r du6-CalendarHerdByYear,fig.cap="Response of caribou to (A) distance to roads, (B) distance to 1 to 5 year old cutblocks, (C) distance to 6 to 10 year old cutblocks, and (D) distance to 11 to 40 year old cutblocks per year for the Calendar herd", echo = F, message = F, eval = T}

Calendar<-du6 %>% filter(HERD_NAME=="Calendar")
p1<-ggplot (Calendar, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to road (km)") +
  #ggtitle("Calendar Herd")+
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p2<-ggplot (Calendar, aes (x = as.factor(pttype), y = distance_to_cut_1to5yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 1 to 5 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p3<-ggplot (Calendar, aes (x = as.factor(pttype), y = distance_to_cut_6to10yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 6 to 10 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p4<-ggplot (Calendar, aes (x = as.factor(pttype), y = distance_to_cut_11to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 11 to 40 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

ggarrange(p1, p2,p3,p4, ncol=2, nrow=2,labels=c("A","B","C","D"))

```

```{r du6-ProphetHerdByYear,fig.cap="Response of caribou to (A) distance to roads, (B) distance to 1 to 5 year old cutblocks, (C) distance to 6 to 10 year old cutblocks, and (D) distance to 11 to 40 year old cutblocks per year for the Prophet herd", echo = F, message = F, eval = T}

Prophet<-du6 %>% filter(HERD_NAME=="Prophet")
p1<-ggplot (Prophet, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to road (km)") +
  #ggtitle("Calendar Herd")+
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p2<-ggplot (Prophet, aes (x = as.factor(pttype), y = distance_to_cut_1to5yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 1 to 5 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p3<-ggplot (Prophet, aes (x = as.factor(pttype), y = distance_to_cut_6to10yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 6 to 10 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

p4<-ggplot (Prophet, aes (x = as.factor(pttype), y = distance_to_cut_11to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock 11 to 40 years (km)") +
  facet_grid (. ~ year, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

ggarrange(p1, p2,p3,p4, ncol=2, nrow=2,labels=c("A","B","C","D"))

```


```{r}
ggplot(du6, aes(x = distance_to_cut_1to5yo,fill=as.factor(pttype))) +
    theme_bw() +
    geom_density(position="identity",alpha=0.6) +
    facet_grid(HERD_NAME~.) +
    scale_fill_brewer(palette="Accent")+
    scale_x_continuous(name="Distance to cutblocks (km)") +
    scale_y_continuous(name = "Density") + 
    ggtitle("Distance to 1 to 5 year old cutblocks")
   # geom_vline(xintercept=cutblock_mean$median_dist, size=1,colour="black",linetype="dashed")
```
```{r}
ggplot(du6, aes(x = distance_to_cut_6to10yo,fill=as.factor(pttype))) +
    theme_bw() +
    geom_density(position="identity",alpha=0.6) +
    facet_grid(HERD_NAME~.) +
    scale_fill_brewer(palette="Accent")+
    scale_x_continuous(name="Distance to cutblocks (km)") +
    scale_y_continuous(name = "Density") + 
    ggtitle("Distance to 6 to 10 year old cutblocks")
   # geom_vline(xintercept=cutblock_mean$median_dist, size=1,colour="black",linetype="dashed")
```

```{r}
ggplot(du6, aes(x = distance_to_cut_11to40yo,fill=as.factor(pttype))) +
    theme_bw() +
    geom_density(position="identity",alpha=0.6) +
    facet_grid(HERD_NAME~.) +
    scale_fill_brewer(palette="Accent")+
    scale_x_continuous(name="Distance to cutblocks (km)") +
    scale_y_continuous(name = "Density") + 
    ggtitle("Distance to 11 to 40 year old cutblocks")
   # geom_vline(xintercept=cutblock_mean$median_dist, size=1,colour="black",linetype="dashed")
```
```{r}
ggplot(du6, aes(x = distance_to_road,fill=as.factor(pttype))) +
    theme_bw() +
    geom_density(position="identity",alpha=0.6) +
    facet_grid(HERD_NAME~.) +
    scale_fill_brewer(palette="Accent")+
    scale_x_continuous(name="Distance to road (km)") +
    scale_y_continuous(name = "Density") + 
    ggtitle("Distance to resource roads")
   # geom_vline(xintercept=cutblock_mean$median_dist, size=1,colour="black",linetype="dashed")
```


#### Caribou-Forestry Disturbance Model
There were statistically significant (P < 0.05) positive population-level effect of 1 to 5 and 6 to 10 year old cutblocks (figure \@ref(fig:random-fixed-effects-du6) ,Table \@ref(tab:du6-fix-eff-coef)). In contrast, there was a highly significant (P << 0.00001)  negative population-level effect of 11 to 40 year old cutblocks on caribou distribution (figure \@ref(fig:random-fixed-effects-du6) ,Table \@ref(tab:du6-fix-eff-coef)). There was a general trend for caribou to avoid roads (figure \@ref(fig:random-fixed-effects-du6)) but this relationship was not statistically significant (p=0.39, Table \@ref(tab:du6-fix-eff-coef))

```{r du6 model, echo = T, message = F, eval = T, cache=TRUE}
# model spec
# varying intercept and slope for each factor. Essentially I am assuming that a increase in 1 of resource road is not the same in each herd (slopes are allowed to vary)

# determined specification of model using Harrison et al.2018 (https://peerj.com/articles/4794/)


model.lme4.du6.cut.rd.yr <- glmer (pttype ~ distance_category_road +
                                         distance_category_1to5_cut +
                                         distance_category_6to10_cut +
                                         distance_category_11to40_cut +
                                        (distance_category_road +
                                         distance_category_1to5_cut +
                                         distance_category_6to10_cut +
                                         distance_category_11to40_cut || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.lme4.du6.cut.rd.yr)
du6$residual_val<-residuals(model.lme4.du6.cut.rd.yr, type = "response")
du6$fitted_val<-fitted(model.lme4.du6.cut.rd.yr)

```

```{r du6 model, echo = T, message = F, eval = T, cache=TRUE}
# model spec
# varying intercept and slope for each factor. Essentially I am assuming that a increase in 1 of resource road is not the same in each herd (slopes are allowed to vary)

# determined specification of model using Harrison et al.2018 (https://peerj.com/articles/4794/)

model.rd <- glmer (pttype ~ distance_to_road +
                                     (distance_to_road || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.rd)
binnedplot (fitted(model.rd), 
            residuals(model.rd, type = "pearson"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

binnedplot(du6$distance_to_road, residuals(model.rd),
           xlab = "Distance to road", 
             ylab ="Residual Values" , 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")


model.1to5cut <- glmer (pttype ~ distance_to_cut_1to5yo +
                                     (distance_to_cut_1to5yo || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.1to5cut)
binnedplot (fitted(model.1to5cut), 
            residuals(model.1to5cut, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

binnedplot (du6$distance_to_cut_1to5yo, 
            residuals(model.1to5cut, type = "response"), 
             nclass = NULL, 
             xlab = "distance_to_cut_1to5yo", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

model.6to10cut <- glmer (pttype ~ distance_to_cut_6to10yo +
                                     (distance_to_cut_6to10yo || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.6to10cut)
binnedplot (fitted(model.6to10cut), 
            residuals(model.6to10cut, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
model.11to40cut <- glmer (pttype ~ distance_to_cut_11to40yo +
                                     (distance_to_cut_11to40yo || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.11to40cut)
binnedplot (fitted(model.11to40cut), 
            residuals(model.11to40cut, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")


```

#### Caveats
Note that the model fit is fairly bad, as Fig. \@ref(fig:du6-model-fitted-vs-residual) shows the relationship betwen the fitted and residual values is mostly well beyond the bounds of the binned confidence intervals suggesting that this model fits poorly.

```{r du6-model-fitted-vs-residual, echo = F, message = F, eval = T}
binnedplot (du6$fitted_val, 
            du6$residual_val, 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
```

#### Try to reduce the trend in the analysis
First Ill try to check whether the trends are consistent whether I subsample the data or not. Assuming they are consistent Ill bin my distance to variables into close, medium and far. This will remove the trends.

```{r}
du6_0_25perc<-du6 %>% filter(pttype==0) %>% sample_frac(0.25)
du6_1_25perc<-du6 %>% filter(pttype==1) %>% sample_frac(0.25)
du6_perc25<-rbind(du6_0_25perc,du6_1_25perc)

perc_25_du6_0<-sample_frac(du6_0, 0.25)


model.lme4.du6.25perc <- glmer (pttype ~ distance_to_road +
                                         distance_to_cut_1to5yo +
                                         distance_to_cut_6to10yo +
                                         distance_to_cut_11to40yo +
                                        (distance_to_road +
                                         distance_to_cut_1to5yo +
                                         distance_to_cut_6to10yo +
                                         distance_to_cut_11to40yo || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = perc_25_du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.lme4.du6.25perc)

binnedplot (fitted(model.lme4.du6.25perc), 
            residuals(model.lme4.du6.25perc, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

# 50% of data
perc_50_du6<-sample_frac(du6, 0.5)

model.lme4.du6.50perc <- glmer (pttype ~ distance_to_road +
                                         distance_to_cut_1to5yo +
                                         distance_to_cut_6to10yo +
                                         distance_to_cut_11to40yo +
                                        (distance_to_road +
                                         distance_to_cut_1to5yo +
                                         distance_to_cut_6to10yo +
                                         distance_to_cut_11to40yo || HERD_NAME) +
                                        (1|year),
                                        nAGQ = 0,
                                      data = perc_50_du6, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 
VarCorr(model.lme4.du6.50perc)

binnedplot (fitted(model.lme4.du6.50perc), 
            residuals(model.lme4.du6.50perc, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU6 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")


```



```{r du6-fix-eff-coef, echo = F, message = F, eval = T}
# summary table
table.glm.summary.du6 <- data.frame (matrix (ncol = 5, nrow = 0))
colnames (table.glm.summary.du6) <- c ("Coefficient", "Coefficient.Estimate", "Std.Error","z.value", "p.values")

table.glm.summary.du6[1,1]<-"Intercept"
table.glm.summary.du6[2,1]<-"Distance to Resource Road"
table.glm.summary.du6[3,1]<-"Distance to Cutblock 1 to 5 years old"
table.glm.summary.du6[4,1]<-"Distance to Cutblock 6 to 10 years old"
table.glm.summary.du6[5,1]<-"Distance to Cutblock 11 to 40 years old"
table.glm.summary.du6 [1, 2] <-fixef(model.lme4.du6.cut.rd.yr)[1]
table.glm.summary.du6 [2, 2] <-fixef(model.lme4.du6.cut.rd.yr)[2]
table.glm.summary.du6 [3, 2] <-fixef(model.lme4.du6.cut.rd.yr)[3]
table.glm.summary.du6 [4, 2] <-fixef(model.lme4.du6.cut.rd.yr)[4]
table.glm.summary.du6 [5, 2] <-fixef(model.lme4.du6.cut.rd.yr)[5]
table.glm.summary.du6 [1, 3] <-se.fixef(model.lme4.du6.cut.rd.yr)[1]
table.glm.summary.du6 [2, 3] <-se.fixef(model.lme4.du6.cut.rd.yr)[2]
table.glm.summary.du6 [3, 3] <-se.fixef(model.lme4.du6.cut.rd.yr)[3]
table.glm.summary.du6 [4, 3] <-se.fixef(model.lme4.du6.cut.rd.yr)[4]
table.glm.summary.du6 [5, 3] <-se.fixef(model.lme4.du6.cut.rd.yr)[5]
table.glm.summary.du6 [1, 4] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"z value"][1]
table.glm.summary.du6 [2, 4] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"z value"][2]
table.glm.summary.du6 [3, 4] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"z value"][3]
table.glm.summary.du6 [4, 4] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"z value"][4]
table.glm.summary.du6 [5, 4] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"z value"][5]
table.glm.summary.du6 [1, 5] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"Pr(>|z|)"][1]
table.glm.summary.du6 [2, 5] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"Pr(>|z|)"][2]
table.glm.summary.du6 [3, 5] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"Pr(>|z|)"][3]
table.glm.summary.du6 [4, 5] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"Pr(>|z|)"][4]
table.glm.summary.du6 [5, 5] <-coef(summary(model.lme4.du6.cut.rd.yr))[,"Pr(>|z|)"][5]

kable (table.glm.summary.du6,
       caption = "<b>Fixed Effect Coefficients of the DU6 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```

Random effects in the DU6 model indicated that there was variability in the avoidance of caribou to roads across herds (Table \@ref(tab:du6-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du6)A). Similarly, there was variability in the response of caribou to 1 to 5 year old and 6 to 10 year old cutblocks across herds (Table \@ref(tab:du6-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du6) B, C). Finally, caribou consistently avoided 11 to 40 year old cutblocks (Table \@ref(tab:du6-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du6) D).

```{r du6-random-effects-coeffs, echo = F, message = F, eval = T}
table.glm.summary.raneff <- data.frame (matrix (ncol = 6, nrow = 0))
colnames (table.glm.summary.raneff) <- c ("Herd", "Intercept", "Distance to road","Distance to cutblock 1 to 4 years old", "Distance to cutblock 5 to 10 years old", "Distance to cutblock 11 to 40 years old")
tab<-as.data.frame(coef(model.lme4.du6.cut.rd.yr)$HERD_NAME)

table.glm.summary.raneff[1,1]<- "Calendar"
table.glm.summary.raneff[2,1]<-"Chinchaga"
table.glm.summary.raneff[3,1]<-"Maxhamish"
table.glm.summary.raneff[4,1]<-"Parker"
table.glm.summary.raneff[5,1]<-"Prophet"
table.glm.summary.raneff[6,1]<-"Snake-Sahtaneh"
table.glm.summary.raneff[1,2]<-tab[,"(Intercept)"][1]
table.glm.summary.raneff[2,2]<-tab[,"(Intercept)"][2]
table.glm.summary.raneff[3,2]<-tab[,"(Intercept)"][3]
table.glm.summary.raneff[4,2]<-tab[,"(Intercept)"][4]
table.glm.summary.raneff[5,2]<-tab[,"(Intercept)"][5]
table.glm.summary.raneff[6,2]<-tab[,"(Intercept)"][6]
table.glm.summary.raneff[1,3]<-(tab[,"distance_to_road_s"][1])
table.glm.summary.raneff[2,3]<-(tab[,"distance_to_road_s"][2])
table.glm.summary.raneff[3,3]<-(tab[,"distance_to_road_s"][3])
table.glm.summary.raneff[4,3]<-(tab[,"distance_to_road_s"][4])
table.glm.summary.raneff[5,3]<-(tab[,"distance_to_road_s"][5])
table.glm.summary.raneff[6,3]<-(tab[,"distance_to_road_s"][6])
table.glm.summary.raneff[1,4]<-(tab[,"distance_to_cut_1to5yo_s"][1])
table.glm.summary.raneff[2,4]<-(tab[,"distance_to_cut_1to5yo_s"][2])
table.glm.summary.raneff[3,4]<-(tab[,"distance_to_cut_1to5yo_s"][3])
table.glm.summary.raneff[4,4]<-(tab[,"distance_to_cut_1to5yo_s"][4])
table.glm.summary.raneff[5,4]<-(tab[,"distance_to_cut_1to5yo_s"][5])
table.glm.summary.raneff[6,4]<-(tab[,"distance_to_cut_1to5yo_s"][6])
table.glm.summary.raneff[1,5]<-(tab[,"distance_to_cut_6to10yo_s"][1])
table.glm.summary.raneff[2,5]<-(tab[,"distance_to_cut_6to10yo_s"][2])
table.glm.summary.raneff[3,5]<-(tab[,"distance_to_cut_6to10yo_s"][3])
table.glm.summary.raneff[4,5]<-(tab[,"distance_to_cut_6to10yo_s"][4])
table.glm.summary.raneff[5,5]<-(tab[,"distance_to_cut_6to10yo_s"][5])
table.glm.summary.raneff[6,5]<-(tab[,"distance_to_cut_6to10yo_s"][6])
table.glm.summary.raneff[1,6]<-(tab[,"distance_to_cut_11to40yo_s"][1])
table.glm.summary.raneff[2,6]<-(tab[,"distance_to_cut_11to40yo_s"][2])
table.glm.summary.raneff[3,6]<-(tab[,"distance_to_cut_11to40yo_s"][3])
table.glm.summary.raneff[4,6]<-(tab[,"distance_to_cut_11to40yo_s"][4])
table.glm.summary.raneff[5,6]<-(tab[,"distance_to_cut_11to40yo_s"][5])
table.glm.summary.raneff[6,6]<-(tab[,"distance_to_cut_11to40yo_s"][6])



kable (table.glm.summary.raneff,
       caption = "<b>Random Effect Herd-Level Coefficients of the DU6 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```




```{r random-fixed-effects-du6, fig.cap="Population and herd level effects of distance to (A)roads, (B) 1 to 5 year old cutblocks, (C) 6 to 10 year old cutblocks, and (D) 11 to 40 year old cutblocks. x-axis values were centered and scaled  to 1 standard deviation to assist model fitting. The thick black line represents the fixed effect model output with 95% confidence intervals and coloured lines are the fits for each herd.",  echo = F, message = F, eval = T}

re1<-ggpredict(model.lme4.du6.cut.rd.yr, terms = c("distance_to_cut_1to5yo_s", "HERD_NAME"), type = "re")
fe1<-ggpredict(model.lme4.du6.cut.rd.yr, "distance_to_cut_1to5yo_s")

p1<-ggplot(data=fe1,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe1,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
  geom_line(data=re1, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 1 to 5 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()
  


re2<-ggpredict(model.lme4.du6.cut.rd.yr, terms = c("distance_to_cut_6to10yo_s", "HERD_NAME"), type = "re")
fe2<-ggpredict(model.lme4.du6.cut.rd.yr, "distance_to_cut_6to10yo_s")

p2<-ggplot(data=fe2,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe2,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re2, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 6 to 10 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()

re3<-ggpredict(model.lme4.du6.cut.rd.yr, terms = c("distance_to_cut_11to40yo_s", "HERD_NAME"), type = "re")
fe3<-ggpredict(model.lme4.du6.cut.rd.yr, "distance_to_cut_11to40yo_s")

p3<-ggplot(data=fe3,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe3,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re3, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 11 to 40 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()

re4<-ggpredict(model.lme4.du6.cut.rd.yr, terms = c("distance_to_road_s", "HERD_NAME"), type = "re")
fe4<-ggpredict(model.lme4.du6.cut.rd.yr, "distance_to_road_s")

p4<-ggplot(data=fe4,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe4,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re4, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to roads") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()

ggarrange(p4, p1, p2,p3, ncol=2, nrow=2,labels=c("A","B","C","D"), common.legend = TRUE, legend="right")

```

### DU7
In DU7, the home ranges of individual animals were calculated from 131 animals from the Charlotte Alplands, Chase, Finlay, Frog, Graham, Itcha-Ilgachuz, Muskwa, Pink Mountain, Rainbows, Spatsizi, Telkwa, Tsenaglode and Tweedsmuir herds. Sample sizes of used and available points are presented in table \@ref(tab:DU7-samp-size-table)

```{r DU7-samp-size-table, echo = F, message = F, eval = T}
# number of animals, by herd
count.individual.home.range <- du7  %>%
  filter(pttype==1) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Used=count)

count.herd.range <- du7  %>%
  filter(pttype==0) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Available=count)


summary_du7 <- du7 %>% 
  group_by(HERD_NAME, pttype) %>% 
  summarise(mean=mean(distance_to_road),
            sd = sd(distance_to_road),
            count = sum(cnt),
            se= sd(distance_to_road)/(sqrt(sum(cnt))))



table <- full_join(count.individual.home.range, count.herd.range)


kable (table,
       caption = "<b> Number of points sampled in individual caribou home ranges (Used - 1's) and across the herd ranges (Available - 0's) in du7 (Northern).<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

#### Herd-Level Effect of Forestry on Caribou Distribution
There was a mixed response of caribou to the presence of roads (Fig. \@ref(fig:du7-road-effect)). For example, caribou in the Chase, Frog, Graham, Itcha-Ilgachuz, Muskwa, Rainbows, Telkwa, Tsenaglode, and Tweedsmuir herds were further from roads than what was available on average in their home range but the opposite pattern was observed in Charlotte Alplands, Finlay, and Spatsizi. Due to these differences in relationships a random effect for distance to road was included in the GLMM. 

```{r du7-road-effect,fig.cap="Distance to Resource Road at Available (0) and Used (1) Locations by Caribou Herd in du7", echo = F, message = F, eval = T}
ggplot (du7, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to road (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))

```
Similar to road, caribou in du7 had a mixed response to 1 to 40 year old cutblocks (Fig. \@ref(fig:du7-cutblock-1to40yo)). For example, caribou in the Chase, Graham, Itcha-Ilgachuz, Muskwa, Pink Mountain, Rainbows, Telkwa, Tsenaglode, and Tweedsmuir herds tended to utlize habitat slightly further from 1 to 40 year old cutblocks than what was available. In contrast the Charlotte Alplands, Finlay, Frog, and Spatsizi herds utilized habitats closer to 1 to 40 year old cutblocks than what was available. We included random effect for distance to 1 to 40 year old cutblocks in the GLMM to account for the variability in preference between herds.

```{r du7-cutblock-1to40yo, fig.cap="Distance to 1 to 40 year old cutblock at available (0) and used (1) locations \n by caribou herds in du7",echo = F, message = F, eval = T}
ggplot (du7, aes (x = as.factor(pttype), y = distance_to_cut_1to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```



#### Caribou-Forestry Disturbance Model
There was no relationship between caribou use and distance to road (P=0.49) (Table \@ref(tab:du7-fix-eff-coef), Fig. \@ref(fig:random-fixed-effects-du7)A). The model indicated a weakly significant (P=0.084) effect of 1 to 5 year old cutblocks on caribou distribution.  Thus, on average, across caribou individuals and herds, caribou used areas further from 1 to 5 year old cutblocks (note that a positive coefficient is a negative effect, because the covariate is a 'distance to' metric) (Table \@ref(tab:du7-fix-eff-coef), Fig. \@ref(fig:random-fixed-effects-du7)B). Lastly, the model indicated a strongly significant (P<<0.0001) positive effect of 6 to 40 year old cutblocks on caribou, suggesting that caribou avoided 6 to 40 year old cutblocks (Table \@ref(tab:du7-fix-eff-coef), Fig. \@ref(fig:random-fixed-effects-du7)C).

```{r du7-model, echo = T, message = F, eval = T, cache=TRUE}
# model spec

model.lme4.du7.cut.rd.yr <- glmer (pttype ~ distance_to_road +
                                         distance_to_cut_1to40yo +
                                         (distance_to_road +
                                         distance_to_cut_1to40yo||HERD_NAME) +
                                         (1|year),
                                      data = du7, 
                                      family = binomial (link = "logit"),
                                      verbose = T)  

summary(model.lme4.du7.cut.rd.yr)
Anova(model.lme4.du7.cut.rd.yr,type="III")

```

```{r du7-fix-eff-coef, echo = F, message = F, eval = T}
# summary table
table.glm.summary.du7 <- data.frame (matrix (ncol = 5, nrow = 0))
colnames (table.glm.summary.du7) <- c ("Coefficient", "Coefficient.Estimate", "Std.Error","z.value", "p.values")

table.glm.summary.du7[1,1]<-"Intercept"
table.glm.summary.du7[2,1]<-"Distance to Resource Road"
table.glm.summary.du7[3,1]<-"Distance to Cutblock 1 to 5 years old"
table.glm.summary.du7[4,1]<-"Distance to Cutblock 6 to 40 years old"
table.glm.summary.du7 [1, 2] <-fixef(model.lme4.du7.cut.rd.yr)[1]
table.glm.summary.du7 [2, 2] <-fixef(model.lme4.du7.cut.rd.yr)[2]
table.glm.summary.du7 [3, 2] <-fixef(model.lme4.du7.cut.rd.yr)[3]
table.glm.summary.du7 [4, 2] <-fixef(model.lme4.du7.cut.rd.yr)[4]
table.glm.summary.du7 [1, 3] <-se.fixef(model.lme4.du7.cut.rd.yr)[1]
table.glm.summary.du7 [2, 3] <-se.fixef(model.lme4.du7.cut.rd.yr)[2]
table.glm.summary.du7 [3, 3] <-se.fixef(model.lme4.du7.cut.rd.yr)[3]
table.glm.summary.du7 [4, 3] <-se.fixef(model.lme4.du7.cut.rd.yr)[4]
table.glm.summary.du7 [1, 4] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"z value"][1]
table.glm.summary.du7 [2, 4] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"z value"][2]
table.glm.summary.du7 [3, 4] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"z value"][3]
table.glm.summary.du7 [4, 4] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"z value"][4]
table.glm.summary.du7 [1, 5] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"Pr(>|z|)"][1]
table.glm.summary.du7 [2, 5] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"Pr(>|z|)"][2]
table.glm.summary.du7 [3, 5] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"Pr(>|z|)"][3]
table.glm.summary.du7 [4, 5] <-coef(summary(model.lme4.du7.cut.rd.yr))[,"Pr(>|z|)"][4]

kable (table.glm.summary.du7,
       caption = "<b>Fixed Effect Coefficients of the du7 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```

Random effects in the du7 model indicated that there was variability in the response of caribou to roads across herds (Table \@ref(tab:du7-random-effects-coeffs), Fig. \@ref(fig: random-fixed-effects-du7)A). Some herds such as Frog and Tsenaglode tended to avoid roads. While other herds, such as, Rainbow, Graham, and Tweedsmuir utlized areas closer to roads than what was generally available. On average, caribou herds avoided 1 to 5 year old cutblocks (Table \@ref(tab:du7-random-effects-coeffs), Fig. \@ref(fig: random-fixed-effects-du7) B), but again this response was variabliity between herds. For example, Pink Mountain and Tweedsmuir tended to use areas close to roads more frequently than what was available on average while the opposite was true for Itcha-Ilgachuz, Spatsizi, and Tsenglode. Lastly, most caribou herds avoid 6 to 40 year old cutblocks, with the exception of Finlay and Frog who showed a slight trend towards prefering 6 to 40 year old cutblock (Table \@ref(tab:du7-random-effects-coeffs), Fig. \@ref(fig: random-fixed-effects-du7) C).


```{r du7-random-effects-coeffs, echo = F, message = F, eval = T}
table.glm.summary.raneff <- data.frame (matrix (ncol = 5, nrow = 0))
colnames (table.glm.summary.raneff) <- c ("Herd", "Intercept", "Distance to road","Distance to cutblock 1 to 5 years old", "Distance to cutblock 6 to 40 years old")
tab<-as.data.frame(coef(model.lme4.du7.cut.rd.yr)$HERD_NAME)

table.glm.summary.raneff[1,1]<- "Charlotte Alplands"
table.glm.summary.raneff[2,1]<-"Chase"
table.glm.summary.raneff[3,1]<-"Finlay"
table.glm.summary.raneff[4,1]<-"Frog"
table.glm.summary.raneff[5,1]<-"Graham"
table.glm.summary.raneff[6,1]<-"Itcha-Ilgachuz"
table.glm.summary.raneff[7,1]<- "Muskwa"
table.glm.summary.raneff[8,1]<-"Pink Mountain"
table.glm.summary.raneff[9,1]<-"Rainbows"
table.glm.summary.raneff[10,1]<-"Spatsizi"
table.glm.summary.raneff[11,1]<-"Telkwa"
table.glm.summary.raneff[12,1]<-"Tsenaglode"
table.glm.summary.raneff[13,1]<-"Tweedsmuir"

table.glm.summary.raneff[1,2]<-tab[,"(Intercept)"][1]
table.glm.summary.raneff[2,2]<-tab[,"(Intercept)"][2]
table.glm.summary.raneff[3,2]<-tab[,"(Intercept)"][3]
table.glm.summary.raneff[4,2]<-tab[,"(Intercept)"][4]
table.glm.summary.raneff[5,2]<-tab[,"(Intercept)"][5]
table.glm.summary.raneff[6,2]<-tab[,"(Intercept)"][6]
table.glm.summary.raneff[7,2]<-tab[,"(Intercept)"][7]
table.glm.summary.raneff[8,2]<-tab[,"(Intercept)"][8]
table.glm.summary.raneff[9,2]<-tab[,"(Intercept)"][9]
table.glm.summary.raneff[10,2]<-tab[,"(Intercept)"][10]
table.glm.summary.raneff[11,2]<-tab[,"(Intercept)"][11]
table.glm.summary.raneff[12,2]<-tab[,"(Intercept)"][12]
table.glm.summary.raneff[13,2]<-tab[,"(Intercept)"][13]

table.glm.summary.raneff[1,3]<-(tab[,"distance_to_road_scale"][1])
table.glm.summary.raneff[2,3]<-(tab[,"distance_to_road_scale"][2])
table.glm.summary.raneff[3,3]<-(tab[,"distance_to_road_scale"][3])
table.glm.summary.raneff[4,3]<-(tab[,"distance_to_road_scale"][4])
table.glm.summary.raneff[5,3]<-(tab[,"distance_to_road_scale"][5])
table.glm.summary.raneff[6,3]<-(tab[,"distance_to_road_scale"][6])
table.glm.summary.raneff[7,3]<-(tab[,"distance_to_road_scale"][7])
table.glm.summary.raneff[8,3]<-(tab[,"distance_to_road_scale"][8])
table.glm.summary.raneff[9,3]<-(tab[,"distance_to_road_scale"][9])
table.glm.summary.raneff[10,3]<-(tab[,"distance_to_road_scale"][10])
table.glm.summary.raneff[11,3]<-(tab[,"distance_to_road_scale"][11])
table.glm.summary.raneff[12,3]<-(tab[,"distance_to_road_scale"][12])
table.glm.summary.raneff[13,3]<-(tab[,"distance_to_road_scale"][13])

table.glm.summary.raneff[1,4]<-(tab[,"distance_to_cut_1to5yo_scale"][1])
table.glm.summary.raneff[2,4]<-(tab[,"distance_to_cut_1to5yo_scale"][2])
table.glm.summary.raneff[3,4]<-(tab[,"distance_to_cut_1to5yo_scale"][3])
table.glm.summary.raneff[4,4]<-(tab[,"distance_to_cut_1to5yo_scale"][4])
table.glm.summary.raneff[5,4]<-(tab[,"distance_to_cut_1to5yo_scale"][5])
table.glm.summary.raneff[6,4]<-(tab[,"distance_to_cut_1to5yo_scale"][6])
table.glm.summary.raneff[7,4]<-(tab[,"distance_to_cut_1to5yo_scale"][7])
table.glm.summary.raneff[8,4]<-(tab[,"distance_to_cut_1to5yo_scale"][8])
table.glm.summary.raneff[9,4]<-(tab[,"distance_to_cut_1to5yo_scale"][9])
table.glm.summary.raneff[10,4]<-(tab[,"distance_to_cut_1to5yo_scale"][10])
table.glm.summary.raneff[11,4]<-(tab[,"distance_to_cut_1to5yo_scale"][11])
table.glm.summary.raneff[12,4]<-(tab[,"distance_to_cut_1to5yo_scale"][12])
table.glm.summary.raneff[13,4]<-(tab[,"distance_to_cut_1to5yo_scale"][13])

table.glm.summary.raneff[1,5]<-(tab[,"distance_to_cut_6to40yo_scale"][1])
table.glm.summary.raneff[2,5]<-(tab[,"distance_to_cut_6to40yo_scale"][2])
table.glm.summary.raneff[3,5]<-(tab[,"distance_to_cut_6to40yo_scale"][3])
table.glm.summary.raneff[4,5]<-(tab[,"distance_to_cut_6to40yo_scale"][4])
table.glm.summary.raneff[5,5]<-(tab[,"distance_to_cut_6to40yo_scale"][5])
table.glm.summary.raneff[6,5]<-(tab[,"distance_to_cut_6to40yo_scale"][6])
table.glm.summary.raneff[7,5]<-(tab[,"distance_to_cut_6to40yo_scale"][7])
table.glm.summary.raneff[8,5]<-(tab[,"distance_to_cut_6to40yo_scale"][8])
table.glm.summary.raneff[9,5]<-(tab[,"distance_to_cut_6to40yo_scale"][9])
table.glm.summary.raneff[10,5]<-(tab[,"distance_to_cut_6to40yo_scale"][10])
table.glm.summary.raneff[11,5]<-(tab[,"distance_to_cut_6to40yo_scale"][11])
table.glm.summary.raneff[12,5]<-(tab[,"distance_to_cut_6to40yo_scale"][12])
table.glm.summary.raneff[13,5]<-(tab[,"distance_to_cut_6to40yo_scale"][13])

kable (table.glm.summary.raneff,
       caption = "<b>Random Effect Herd-Level Coefficients of the du7 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```

#### Caveats
Note that the model fit is fairly bad, as Fig. \@ref(fig:du7-model-fitted-vs-residual) shows the relationship betwen the fitted and residual values is frequently beyond the bounds of the binned confidence intervals suggesting that this model fits poorly.

```{r du7-model-fitted-vs-residual,fig.cap="DU7 Model Binned Residual Plot", echo = F, message = F, eval = T}
# check residuals
binnedplot (fitted (model.lme4.du7.cut.rd.yr), 
             residuals(model.lme4.du7.cut.rd.yr, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
```


```{r random-fixed-effects-du7, fig.cap="Population and herd level effects of distance to (A) roads, (B) 1 to 5 year old cutblocks, and (C) 6 to 40 year old cutblocks. x-axis values were centered and scaled to 1 standard deviation to assist model fitting",  echo = F, message = F, eval = T}

re1<-ggpredict(model.lme4.du7.cut.rd.yr, terms = c("distance_to_cut_1to5yo_scale", "HERD_NAME"), type = "re")
fe1<-ggpredict(model.lme4.du7.cut.rd.yr, "distance_to_cut_1to5yo_scale")

p1<-ggplot(data=fe1,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe1,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
  geom_line(data=re1, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 1 to 5 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid")) +
  scale_color_manual (name = "Herd Name",
                      values = c ('coral', 'chartreuse', "yellowgreen", "brown", "aquamarine", "dodgerblue", "deeppink", "darkviolet", "seagreen","darkorange", "darkolivegreen", "gold", "red")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw () 
  


re2<-ggpredict(model.lme4.du7.cut.rd.yr, terms = c("distance_to_cut_6to40yo_scale", "HERD_NAME"), type = "re")
fe2<-ggpredict(model.lme4.du7.cut.rd.yr, "distance_to_cut_6to40yo_scale")

p2<-ggplot(data=fe2,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe2,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re2, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 6 to 10 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid")) +
  scale_color_manual (name = "Herd Name",
                      values = c ('coral', 'chartreuse', "yellowgreen", "brown", "aquamarine", "dodgerblue", "deeppink", "darkviolet", "seagreen","darkorange", "darkolivegreen", "gold", "red")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()+ theme(legend.position = "none")



re4<-ggpredict(model.lme4.du7.cut.rd.yr, terms = c("distance_to_road_scale", "HERD_NAME"), type = "re")
fe4<-ggpredict(model.lme4.du7.cut.rd.yr, "distance_to_road_scale")

p4<-ggplot(data=fe4,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe4,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re4, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to roads") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid",  "longdash", "solid",  "longdash", "solid", "longdash","solid")) +
  scale_color_manual (name = "Herd Name",
                      values = c ('coral', 'chartreuse', "yellowgreen", "brown", "aquamarine", "dodgerblue", "deeppink", "darkviolet", "seagreen","darkorange", "darkolivegreen", "gold", "red")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()+ theme(legend.position = "none")

ggarrange(p4, p1, p2, ncol=2, nrow=2,labels=c("A","B","C"), common.legend = TRUE, legend="right")


```

### DU8
In DU8, caribou location data was collected from 152 animals from the Burnt Pine, Kennedy Siding, Moberly, Narraway, Quintette and Scott herds. The number of animals sampled per herd ranged from 8 to 57 and the number of telemetry locations per herd ranged from 5,414 to 65,431 per herd (Table \@ref(tab:DU8-sample-points)).

```{r DU8-sample-points, echo = F, message = F, eval = T}
# number of animals, by herd

count.individual.home.range <- du8  %>%
  filter(pttype==1) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Used=count)

count.herd.range <- du8  %>%
  filter(pttype==0) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Available=count)


summary_du8 <- du8 %>% 
  group_by(HERD_NAME, pttype) %>% 
  summarise(mean=mean(distance_to_road),
            sd = sd(distance_to_road),
            count = sum(cnt),
            se= sd(distance_to_road)/(sqrt(sum(cnt))))



table <- full_join(count.individual.home.range, count.herd.range)


kable (table,
       caption = "<b> Number of points sampled in individual caribou home ranges (Used - 1's) and across the herd ranges (Available - 0's) in DU8 (Northern).<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 

```

#### Herd-Level Effect of Forestry on Caribou Distribution
In general caribou herds avoided roads in DU8 (Fig. \@ref(fig:du8-Herd-road-effect)). For example, caribou in the Burnt Pine, Kennedy Siding, Moberly, Quintette and Scott herds tended to be further from roads, whereas caribou in the Narraway herd utlized habitat in the same proportion as what was available. A random effect for distance to road was included in the GLMM to account for this variability.

```{r du8-Herd-road-effect, fig.cap="Distance to Resource Road at Available (0) and Used (1) Locations by Caribou Herd in DU8", echo = F, message = F, eval = T}
ggplot (du8, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to road (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

Caribou tended to avoid cutblocks 1 to 4 years old across herds in DU8 (Fig. \@ref(fig:du8-Herd-cutblock-1-to-4)). For example, all herds except Narraway tended to use areas further from to 1 to 4 year old cutblocks than what was available. A random effect for distance to cutblock 1 to 4 years old was included in the GLMM to account for this variability.

```{r du8-Herd-cutblock-1-to-4, fig.cap="Distance to 1 to 4 year old cutblock at available (0) and used (1) locations by caribou herds in DU8", echo = F, message = F, eval = T}
ggplot (du8, aes (x = as.factor(pttype), y = distance_to_cut_1to4yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

Caribou tended to avoid cutblocks 6 to 40 years of age across herds in DU8 (Fig. \@ref(du8-Herd-cutblock-6-to-40)). For example, all herds except Narraway used areas further from to 6 to 40 year old cutblocks than what was available. A random effect for distance to cutblock 6 to 10 years old was included in the GLMM to account for this variability.

```{r du8-Herd-cutblock-5-to-10, fig.cap="Distance to 5 to 40 year old cutblock at available (0) and used (1) locations by caribou herds in DU8", echo = F, message = F, eval = T}
ggplot (du8, aes (x = as.factor(pttype), y = distance_to_cut_5to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```



#### Caribou-Forestry Disturbance Model
Caribou in DU8 avoided 1 to 4 year old cutblocks (P<<0.0001) and weakly avoided roads (P = 0.116) and 5 to 40 year old cutblocks (P = 0.125) (Table \@ref(tab:du8-fix-eff-coef), Figure \@ref(fig:random-fixed-effects-du8)).

```{r, du8 model, echo = T, message = F, eval = T, cache=TRUE}
# model spec

model.lme4.du8.cut.rd.yr2 <- glmer (pttype ~ distance_to_road +
                                         distance_to_cut_1to4yo +
                                         distance_to_cut_5to40yo +
                                          distance_to_cut_1to4yo^2 +
                                        distance_to_cut_5to40yo^2 +
                                        (distance_to_road +
                                         distance_to_cut_1to4yo +
                                         distance_to_cut_5to40yo||HERD_NAME) +
                                        (1|year),
                                      data = du8, 
                                      family = binomial (link = "logit"),
                                      verbose = T)  
```

```{r}
du8$HERD_NAME<-as.factor(du8$HERD_NAME)
du8$year<-as.numeric(du8$year)
ga_model=bam(pttype ~ distance_to_road +
              distance_to_cut_1to4yo +
              distance_to_cut_5to40yo +
               s(HERD_NAME, bs='re') +
               s(distance_to_road, HERD_NAME, bs='re' ) +
               s(distance_to_cut_1to4yo, HERD_NAME, bs='re') +
               s(distance_to_cut_5to40yo, HERD_NAME, bs='re'),
             family=binomial(link="logit"),
             data=du8)

lr.fit<-getViz(ga_model)
plot(ga_model)
qq(lr.fit, rep = 20, showReps = T, CI = "none", a.qqpoi = list("shape" = 19), a.replin = list("alpha" = 0.2))

check(lr.fit)

,
      a.qq = list(method = "tnorm", 
                  a.cipoly = list(fill = "light blue")), 
      a.respoi = list(size = 0.5), 
      a.hist = list(bins = 10))
```


```{r du7-model-fitted-vs-residual,fig.cap="DU7 Model Binned Residual Plot", echo = F, message = F, eval = T}
# check residuals
binnedplot (fitted (model.lme4.du8.cut.rd.yr2), 
             residuals(model.lme4.du8.cut.rd.yr2, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

binnedplot (du8$distance_to_road, 
             residuals(model.lme4.du8.cut.rd.yr2, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

binnedplot (du8$distance_to_cut_1to4yo, 
             residuals(model.lme4.du8.cut.rd.yr2, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

binnedplot (du8$distance_to_cut_5to40yo, 
             residuals(model.lme4.du8.cut.rd.yr2, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual",
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")

```


```{r du8-fix-eff-coef, echo = F, message = F, eval = T}
# summary table
table.glm.summary.du8 <- data.frame (matrix (ncol = 5, nrow = 0))
colnames (table.glm.summary.du8) <- c ("Coefficient", "Coefficient.Estimate", "Std.Error","z.value", "p.values")

table.glm.summary.du8[1,1]<-"Intercept"
table.glm.summary.du8[2,1]<-"Distance to Resource Road"
table.glm.summary.du8[3,1]<-"Distance to Cutblock 1 to 4 years old"
table.glm.summary.du8[4,1]<-"Distance to Cutblock 5 to 40 years old"
table.glm.summary.du8 [1, 2] <-fixef(model.lme4.du8.cut.rd.yr2)[1]
table.glm.summary.du8 [2, 2] <-fixef(model.lme4.du8.cut.rd.yr2)[2]
table.glm.summary.du8 [3, 2] <-fixef(model.lme4.du8.cut.rd.yr2)[3]
table.glm.summary.du8 [4, 2] <-fixef(model.lme4.du8.cut.rd.yr2)[4]
table.glm.summary.du8 [1, 3] <-se.fixef(model.lme4.du8.cut.rd.yr2)[1]
table.glm.summary.du8 [2, 3] <-se.fixef(model.lme4.du8.cut.rd.yr2)[2]
table.glm.summary.du8 [3, 3] <-se.fixef(model.lme4.du8.cut.rd.yr2)[3]
table.glm.summary.du8 [4, 3] <-se.fixef(model.lme4.du8.cut.rd.yr2)[4]
table.glm.summary.du8 [1, 4] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"z value"][1]
table.glm.summary.du8 [2, 4] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"z value"][2]
table.glm.summary.du8 [3, 4] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"z value"][3]
table.glm.summary.du8 [4, 4] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"z value"][4]
table.glm.summary.du8 [1, 5] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"Pr(>|z|)"][1]
table.glm.summary.du8 [2, 5] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"Pr(>|z|)"][2]
table.glm.summary.du8 [3, 5] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"Pr(>|z|)"][3]
table.glm.summary.du8 [4, 5] <-coef(summary(model.lme4.du8.cut.rd.yr2))[,"Pr(>|z|)"][4]

kable (table.glm.summary.du8,
       caption = "<b> Fixed Effect Coefficients of the DU8 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```

Random effects in the DU8 model indicated that most caribou herds (Burnt Pine, Kennedy Sidin, Moberly, and Scott) avoided roads. However, caribou in the Moberly and Narraway herds had a slight tendency to utilize habitats closer to roads than what was generally available in the population home range (Table \@ref(tab:du8-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du8)A). All caribou herds, with the exception of Narraway avoided 1 to 5 year old cutblocks. The Narraway herd showed neither preference or avoidance of 1 to 5 year old cutblocks (Table \@ref(tab:du8-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du8)B). Similar but weaker trends of avoidance of 6 to 10 year old cutblocks were observed for most herds (Burnt Pine, Kennedy Sidin, Quintette, and Scott) . However, the Moberly and Narraway herds showed a weak trend of utilizing areas closer to 6 to 10 year cutblocks (Table \@ref(tab:du8-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du8)C). Lastly, the response to 11 to 40 year old cutblocks was mixed. The Burnt Pine, Moberly and Quintette herds avoided 11 to 40 year old cutblocks while Kennedy Sidin, Narraway, and Scott utilized areas closer to 11 to 40 year old cutblocks (Table \@ref(tab:du8-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du8)D).


```{r du8-random-effects-coeffs, echo = F, message = F, eval = T}
table.glm.summary.raneff8 <- data.frame (matrix (ncol = 6, nrow = 0))
colnames (table.glm.summary.raneff8) <- c ("Herd", "Intercept", "Distance to road","Distance to cutblock 1 to 5 years old", "Distance to cutblock 6 to 10 years old", "Distance to cutblock 11 to 40 years old")
tab<-as.data.frame(coef(model.lme4.du8.cut.rd.yr2)$HERD_NAME)

table.glm.summary.raneff8[1,1]<- "Burnt Pine"
table.glm.summary.raneff8[2,1]<-"Kennedy Sidin"
table.glm.summary.raneff8[3,1]<-"Moberly"
table.glm.summary.raneff8[4,1]<-"Narraway"
table.glm.summary.raneff8[5,1]<-"Quintette"
table.glm.summary.raneff8[6,1]<-"Scott"
table.glm.summary.raneff8[1,2]<-tab[,"(Intercept)"][1]
table.glm.summary.raneff8[2,2]<-tab[,"(Intercept)"][2]
table.glm.summary.raneff8[3,2]<-tab[,"(Intercept)"][3]
table.glm.summary.raneff8[4,2]<-tab[,"(Intercept)"][4]
table.glm.summary.raneff8[5,2]<-tab[,"(Intercept)"][5]
table.glm.summary.raneff8[6,2]<-tab[,"(Intercept)"][6]
table.glm.summary.raneff8[1,3]<-(tab[,"distance_to_road"][1])
table.glm.summary.raneff8[2,3]<-(tab[,"distance_to_road"][2])
table.glm.summary.raneff8[3,3]<-(tab[,"distance_to_road"][3])
table.glm.summary.raneff8[4,3]<-(tab[,"distance_to_road"][4])
table.glm.summary.raneff8[5,3]<-(tab[,"distance_to_road"][5])
table.glm.summary.raneff8[6,3]<-(tab[,"distance_to_road"][6])
table.glm.summary.raneff8[1,4]<-(tab[,"distance_to_cut_1to4yo"][1])
table.glm.summary.raneff8[2,4]<-(tab[,"distance_to_cut_1to4yo"][2])
table.glm.summary.raneff8[3,4]<-(tab[,"distance_to_cut_1to4yo"][3])
table.glm.summary.raneff8[4,4]<-(tab[,"distance_to_cut_1to4yo"][4])
table.glm.summary.raneff8[5,4]<-(tab[,"distance_to_cut_1to4yo"][5])
table.glm.summary.raneff8[6,4]<-(tab[,"distance_to_cut_1to4yo"][6])
table.glm.summary.raneff8[1,5]<-(tab[,"distance_to_cut_5to40yo"][1])
table.glm.summary.raneff8[2,5]<-(tab[,"distance_to_cut_5to40yo"][2])
table.glm.summary.raneff8[3,5]<-(tab[,"distance_to_cut_5to40yo"][3])
table.glm.summary.raneff8[4,5]<-(tab[,"distance_to_cut_5to40yo"][4])
table.glm.summary.raneff8[5,5]<-(tab[,"distance_to_cut_5to40yo"][5])
table.glm.summary.raneff8[6,5]<-(tab[,"distance_to_cut_5to40yo"][6])

kable (table.glm.summary.raneff8,
       caption = "<b> Random Effect Herd-Level Coefficients of the DU8 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```


```{r random-fixed-effects-du8, fig.cap="Population and herd level effects of distance to (A) roads, (B) 1 to 5 year old cutblocks, (C) 6 to 10 year old cutblocks, and (D) 11 to 40 year old cutblocks in DU8. x-axis values were centered and scaled  to 1 standard deviation to assist model fitting. The black line represents the fixed effect model fits with 95% confidence intervals and the coloured lines are the fits per herd",  echo = F, message = F, eval = T}

re1<-ggpredict(model.lme4.du8.cut.rd.yr2, terms = c("distance_to_cut_1to4yo", "HERD_NAME"), type = "re")
fe1<-ggpredict(model.lme4.du8.cut.rd.yr2, "distance_to_cut_1to4yo")

p1<-ggplot(data=fe1,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe1,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
  geom_line(data=re1, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 1 to 4 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()
  


re2<-ggpredict(model.lme4.du8.cut.rd.yr2, terms = c("distance_to_cut_5to40y", "HERD_NAME"), type = "re")
fe2<-ggpredict(model.lme4.du8.cut.rd.yr2, "distance_to_cut_5to40y")

p2<-ggplot(data=fe2,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe2,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re2, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 5 to 40 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()

re4<-ggpredict(model.lme4.du8.cut.rd.yr2, terms = c("distance_to_road", "HERD_NAME"), type = "re")
fe4<-ggpredict(model.lme4.du8.cut.rd.yr2, "distance_to_road")

p4<-ggplot(data=fe4,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe4,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re4, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to roads") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("solid",  "longdash", "solid",  "longdash", "solid", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "dodgerblue", "darkblue", "darkviolet", "seagreen", "darkorange")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8, 0.8, 0.8, 0.8)) +
  theme_bw ()

ggarrange(p4, p1, p2, ncol=2, nrow=2,labels=c("A","B","C"), common.legend = TRUE, legend="right")

```


### DU9
In DU9, caribou home ranges were estimated from 25 animals from the Hart Ranges, Nakusp and South Selkirks herds. Within these home ranges points were sampled (Used locations in table \@ref(tab:du9-data-summary)).Points were also sampled from the larger population home range (Available locations in table \@ref(tab:du9-data-summary)).

```{r du9-data-summary, echo = F, message = F, eval = T}
# number of animals, by herd
count.individual.home.range <- du9  %>%
  filter(pttype==1) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Used=count)

count.herd.range <- du9  %>%
  filter(pttype==0) %>%
  group_by(HERD_NAME,year) %>%
  summarise(count = n()) %>% 
  rename(Available=count)


summary_du9 <- du9 %>% 
  group_by(HERD_NAME, pttype) %>% 
  summarise(mean=mean(distance_to_road),
            sd = sd(distance_to_road),
            count = sum(cnt),
            se= sd(distance_to_road)/(sqrt(sum(cnt))))



table <- full_join(count.individual.home.range, count.herd.range)


kable (table,
       caption = "<b> Number of points sampled in individual caribou home ranges (Used - 1's) and across the herd ranges (Available - 0's) in du9 (Northern).<b>") %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11) 
```

#### Herd-Level Effect of Forestry on Caribou Distribution
All herds in DU9 avoided roads however, the degree to which they avoided roads varied between herds. Hart Ranges avoided roads most strongly while South Selkirks only showed minor avoidance (Fig. \@ref(fig:du9-Herd-road-effect). A random effect for distance to road was included in the GLMM to account for this variability.

```{r du9-Herd-road-effect, fig.cap="Distance to roads at Available (0) and Used (1) Locations by Caribou Herds in DU9", echo = F, message = F, eval = T}
ggplot (du9, aes (x = as.factor(pttype), y = distance_to_road)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and Used (1) Locations",
        y = "Distance to Road (Km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 11))
```

Caribou in DU9 avoided 1 to 5 year old cutblocks. This was consistend across all herds but the strength of this relationship varied between herds (Fig. \@ref(fig:du9-Herd-1-to-5-yo-cutblock). A random effect for distance to 1 to 5 year old cutblock was included in the GLMM to account for this variability.

```{r du9-Herd-1-to-5-yo-cutblock, fig.cap="Distance to 1 to 5 year old cutblocks at Available (0) and Used (1) Locations by Caribou Herds in DU9", echo = F, message = F, eval = T}
ggplot (du9, aes (x = as.factor(pttype), y = distance_to_cut_1to5yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```


Caribou in DU9 avoided 6 to 10 year old cutblocks. This was consistend across all herds \@ref(fig:du9-Herd-6-to-10-yo-cutblock). A random effect for distance to 6 to 10 year old cutblock was included in the GLMM to account for this variability.

```{r du9-Herd-6-to-10-yo-cutblock, fig.cap="Distance to 6 to 10 year old cutblocks at Available (0) and Used (1) Locations by Caribou Herds in DU9", echo = F, message = F, eval = T}
ggplot (du9, aes (x = as.factor(pttype), y = distance_to_cut_6to10yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

There was variability in the response of Caribou to 11 to 40 year old cutblocks in du9. Hart Ranges and Nakusp avoided 11 to 40 year old cutblocks while South Selkirks appeared to utilize habitat closer to 11 to 40 year old cutblocks than what is available \@ref(fig:du9-Herd-11-to-40-yo-cutblock). A random effect for distance to 11 to 40 year old cutblock was included in the GLMM to account for this variability.

```{r du9-Herd-11-to-40-yo-cutblock, fig.cap="Distance to 11 to 40 year old cutblocks at Available (0) and Used (1) Locations by Caribou Herds in DU9",echo = F, message = F, eval = T}
ggplot (du9, aes (x = as.factor(pttype), y = distance_to_cut_11to40yo)) +
  geom_boxplot (outlier.colour = "red") +
  labs (x = "Available (0) and used (1) locations",
        y = "Distance to cutblock (km)") +
  facet_grid (. ~ HERD_NAME, scales='free_x', space='free_x') +
  theme (strip.text.x = element_text (size = 8),
         plot.title = element_text (size = 12))
```

#### Caribou-Forestry Disturbance Model
The model included a statistically significant (p < 0.05), negative population-level (fixed) effect of roads on caribou distribution (Table \@ref(tab:du9-fix-eff-coef)). The population-level effect of 1 to 5 year old cutblocks was also negative, but weak and not statistically significant (p = 0.95). However, the effect of 6 to 10 year old cutblocks was positive, but not statistically significant (p = 0.06).

```{r, du9 model, echo = T, message = F, eval = T, cache=TRUE}
# model spec
du9$distance_to_resource_road_scale<-scale(du9$distance_to_road)
du9$distance_to_cut_1to5yo_scale<-scale(du9$distance_to_cut_1to5yo)
du9$distance_to_cut_6to10yo_scale<-scale(du9$distance_to_cut_6to10yo)
du9$distance_to_cut_11to40yo_scale<-scale(du9$distance_to_cut_11to40yo)

model.lme4.du9.cut.rd <- glmer (pttype ~ distance_to_resource_road_scale +
                                         distance_to_cut_1to5yo_scale +
                                         distance_to_cut_6to10yo_scale +
                                         distance_to_cut_11to40yo_scale +
                                        (distance_to_resource_road_scale +
                                         distance_to_cut_1to5yo_scale +
                                         distance_to_cut_6to10yo_scale +
                                         distance_to_cut_11to40yo_scale || HERD_NAME) +                                                          (1|year),
                                      data = du9, 
                                      family = binomial (link = "logit"),
                                      verbose = T) 


summary(model.lme4.du9.cut.rd)
Anova(model.lme4.du9.cut.rd,type="III")
# check residuals
binnedplot (fitted (model.lme4.du9.cut.rd), 
             residuals(model.lme4.du9.cut.rd, type = "response"), 
             nclass = NULL, 
             xlab = "Expected Values", 
             ylab = "Average residual", 
             main = "DU9 Model Binned Residual Plot", 
             cex.pts = 0.4, 
             col.pts = 1, 
             col.int = "red")
```

```{r du9-fix-eff-coef, echo = F, message = F, eval = T}
# summary table
table.glm.summary.du9 <- data.frame (matrix (ncol = 5, nrow = 0))
colnames (table.glm.summary.du9) <- c ("Coefficient", "Coefficient.Estimate", "Std.Error","z.value", "p.values")

table.glm.summary.du9[1,1]<-"Intercept"
table.glm.summary.du9[2,1]<-"Distance to Resource Road"
table.glm.summary.du9[3,1]<-"Distance to Cutblock 1 to 5 years old"
table.glm.summary.du9[4,1]<-"Distance to Cutblock 6 to 10 years old"
table.glm.summary.du9[5,1]<-"Distance to Cutblock 11 to 40 years old"
table.glm.summary.du9 [1, 2] <-fixef(model.lme4.du9.cut.rd)[1]
table.glm.summary.du9 [2, 2] <-fixef(model.lme4.du9.cut.rd)[2]
table.glm.summary.du9 [3, 2] <-fixef(model.lme4.du9.cut.rd)[3]
table.glm.summary.du9 [4, 2] <-fixef(model.lme4.du9.cut.rd)[4]
table.glm.summary.du9 [5, 2] <-fixef(model.lme4.du9.cut.rd)[5]
table.glm.summary.du9 [1, 3] <-se.fixef(model.lme4.du9.cut.rd)[1]
table.glm.summary.du9 [2, 3] <-se.fixef(model.lme4.du9.cut.rd)[2]
table.glm.summary.du9 [3, 3] <-se.fixef(model.lme4.du9.cut.rd)[3]
table.glm.summary.du9 [4, 3] <-se.fixef(model.lme4.du9.cut.rd)[4]
table.glm.summary.du9 [5, 3] <-se.fixef(model.lme4.du9.cut.rd)[5]
table.glm.summary.du9 [1, 4] <-coef(summary(model.lme4.du9.cut.rd))[,"z value"][1]
table.glm.summary.du9 [2, 4] <-coef(summary(model.lme4.du9.cut.rd))[,"z value"][2]
table.glm.summary.du9 [3, 4] <-coef(summary(model.lme4.du9.cut.rd))[,"z value"][3]
table.glm.summary.du9 [4, 4] <-coef(summary(model.lme4.du9.cut.rd))[,"z value"][4]
table.glm.summary.du9 [5, 4] <-coef(summary(model.lme4.du9.cut.rd))[,"z value"][5]
table.glm.summary.du9 [1, 5] <-coef(summary(model.lme4.du9.cut.rd))[,"Pr(>|z|)"][1]
table.glm.summary.du9 [2, 5] <-coef(summary(model.lme4.du9.cut.rd))[,"Pr(>|z|)"][2]
table.glm.summary.du9 [3, 5] <-coef(summary(model.lme4.du9.cut.rd))[,"Pr(>|z|)"][3]
table.glm.summary.du9 [4, 5] <-coef(summary(model.lme4.du9.cut.rd))[,"Pr(>|z|)"][4]
table.glm.summary.du9 [5, 5] <-coef(summary(model.lme4.du9.cut.rd))[,"Pr(>|z|)"][5]

kable (table.glm.summary.du9,
       caption = "<b> Fixed Effect Coefficients of the DU8 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)

```

Random effects in the DU9 model indicated that the Hart Ranges herd of caribou avoided roads but that the Nakusp and South Selkirks used habitats closer to roads than what was available on average. (Table \@ref(tab:du9-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du9)A). There was variability in use of areas close to 1 to 5 year cutblocks across herds, where caribou in the South Selkirks and Nakusp herds avoided areas close to cutblocks and caribou in the Hart Ranges utilized areas closer to cutblocks (Table \@ref(tab:du9-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du9)B). Similarly, caribou in the Nakusp and South Selkirks avoided 6 to 10 year old cutblocks but caribou in the Hart Ranges showed no preference or avoidance of 6 to 10 year old cutblocks (Table \@ref(tab:du9-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du9)C). Lastly, caribou in the Hart Ranges and nakusp avoided 11 to 40 year old cutblocks while the South Selkirks herd showed a preference for 11 to 40 year old cutblocks (Table \@ref(tab:du9-random-effects-coeffs), Fig. \@ref(fig:random-fixed-effects-du9)D).

```{r du9-random-effects-coeffs, echo = F, message = F, eval = T}
table.glm.summary.raneff9 <- data.frame (matrix (ncol = 6, nrow = 0))
colnames (table.glm.summary.raneff9) <- c ("Herd", "Intercept", "Distance to road","Distance to cutblock 1 to 5 years old", "Distance to cutblock 6 to 10 years old", "Distance to cutblock 11 to 40 years old")
tab<-as.data.frame(coef(model.lme4.du9.cut.rd)$HERD_NAME)

table.glm.summary.raneff9[1,1]<- "Hart Ranges"
table.glm.summary.raneff9[2,1]<-"Nakusp"
table.glm.summary.raneff9[3,1]<-"South Selkirks"
table.glm.summary.raneff9[1,2]<-tab[,"(Intercept)"][1]
table.glm.summary.raneff9[2,2]<-tab[,"(Intercept)"][2]
table.glm.summary.raneff9[3,2]<-tab[,"(Intercept)"][3]
table.glm.summary.raneff9[1,3]<-(tab[,"distance_to_resource_road_scale"][1])
table.glm.summary.raneff9[2,3]<-(tab[,"distance_to_resource_road_scale"][2])
table.glm.summary.raneff9[3,3]<-(tab[,"distance_to_resource_road_scale"][3])
table.glm.summary.raneff9[1,4]<-(tab[,"distance_to_cut_1to5yo_scale"][1])
table.glm.summary.raneff9[2,4]<-(tab[,"distance_to_cut_1to5yo_scale"][2])
table.glm.summary.raneff9[3,4]<-(tab[,"distance_to_cut_1to5yo_scale"][3])
table.glm.summary.raneff9[1,5]<-(tab[,"distance_to_cut_6to10yo_scale"][1])
table.glm.summary.raneff9[2,5]<-(tab[,"distance_to_cut_6to10yo_scale"][2])
table.glm.summary.raneff9[3,5]<-(tab[,"distance_to_cut_6to10yo_scale"][3])
table.glm.summary.raneff9[1,6]<-(tab[,"distance_to_cut_11to40yo_scale"][1])
table.glm.summary.raneff9[2,6]<-(tab[,"distance_to_cut_11to40yo_scale"][2])
table.glm.summary.raneff9[3,6]<-(tab[,"distance_to_cut_11to40yo_scale"][3])




kable (table.glm.summary.raneff9,
       caption = "<b> Random Effect Herd-Level Coefficients of the DU9 Caribou-Forestry Disturbance Model.<b>",
       digits = 3) %>%
  kable_styling (position = "left",
                 bootstrap_options = c("striped", "hover"),
                 fixed_thead = T,
                 full_width = F,
                 font_size = 11)
```

```{r random-fixed-effects-du9, fig.cap="Population and herd level effects of distance to (A) roads, (B) 1 to 5 year old cutblocks, (C) 6 to 10 year old cutblocks, and (D) 11 to 40 year old cutblocks in DU9. x-axis values were centered and scaled  to 1 standard deviation to assist model fitting",  echo = F, message = F, eval = T}

re1_du9<-ggpredict(model.lme4.du9.cut.rd, terms = c("distance_to_cut_1to5yo_scale", "HERD_NAME"), type = "re")
fe1_du9<-ggpredict(model.lme4.du9.cut.rd, "distance_to_cut_1to5yo_scale")

p1<-ggplot(data=fe1_du9,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe1_du9,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
  geom_line(data=re1_du9, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 1 to 5 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("longdash",  "longdash", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "darkviolet", "blue")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8)) +
  theme_bw ()
  


re2_du9<-ggpredict(model.lme4.du9.cut.rd, terms = c("distance_to_cut_6to10yo_scale", "HERD_NAME"), type = "re")
fe2_du9<-ggpredict(model.lme4.du9.cut.rd, "distance_to_cut_6to10yo_scale")

p2<-ggplot(data=fe2_du9,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe2_du9,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re2_du9, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to 6 to 10 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("longdash",  "longdash", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "darkviolet", "blue")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8)) +
  theme_bw ()

re3<-ggpredict(model.lme4.du9.cut.rd, terms = c("distance_to_cut_11to40yo_scale", "HERD_NAME"), type = "re")
fe3<-ggpredict(model.lme4.du9.cut.rd, "distance_to_cut_11to40yo_scale")

p3<-ggplot(data=fe3,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe3,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re3, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  ylab("Probability") +
  xlab("Distance to 11 to 40 year old cutblocks") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("longdash",  "longdash", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "darkviolet", "blue")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8)) +
  theme_bw ()

re4<-ggpredict(model.lme4.du9.cut.rd, terms = c("distance_to_resource_road_scale", "HERD_NAME"), type = "re")
fe4<-ggpredict(model.lme4.du9.cut.rd, "distance_to_resource_road_scale")

p4<-ggplot(data=fe4,aes(x=x,y=predicted)) +
         geom_line(size=1.5) +
         geom_ribbon(data=fe4,aes(ymin=conf.low,ymax=conf.high),alpha=.1) +
   geom_line(data=re4, aes(x,predicted,colour=group,
                  linetype = group, 
                  size = group)) +
  #ggtitle("Distance to 1 to 5 year old cutblocks") +
  ylab("Probability") +
  xlab("Distance to roads") +
  scale_linetype_manual (name = "Herd Name",
                         values = c ("longdash",  "longdash", "longdash")) +
  scale_color_manual (name = "Herd Name",
                      values = c ("red", "darkviolet", "blue")) +
  scale_size_manual (name = "Herd Name",
                     values = c (0.8, 0.8, 0.8)) +
  theme_bw ()

ggarrange(p4, p1, p2,p3, ncol=2, nrow=2,labels=c("A","B","C","D"), common.legend = TRUE, legend="right")

```

## Conclusions

Research has repeatedly shown that caribou are negatively influenced by forestry activity. This can include negative density effects, for example, on caribou survival ( [Wittmer et al. 2007](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2656.2007.01220.x), [Johnson et al. 2015](https://www.sciencedirect.com/science/article/pii/S0006320715001160)), and behavioural effects, for example, on caribou distribution (e.g., [Courbin et al. 2009](https://link.springer.com/article/10.1007/s10980-009-9389-x), [DeCesare et al. 2012](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/11-1610.1), [Mumma et al. 2018](https://www.sciencedirect.com/science/article/pii/S0006320718307225)). Here we built on this evidence and developed a CFDM that empirically related forestry disturbance to caribou distribution. The model provides an indicator of forestry influences on caribou habitat, and thus can be linked to forestry simulator models, i.e., the caribou and land use simualtor (CLUS), to indicate spatial-temporal changes in caribou habitat quality from forestry. 

Our CFDM showed a strong negative effect of resource roads on caribou distribution across DU's. Roads are likely representative of many ecological effects of resource development on caribou. Roads can act as semi-permeable barriers to caribou, resulting in loss of functional habitat due to caribou avoidance of areas near roads ( [Dyer et al. 2001](https://www.jstor.org/stable/3803106), [Dyer et al. 2002](https://www.nrcresearchpress.com/doi/abs/10.1139/z02-060#.XkXNFTFKikw), [Wilson et al. 2016](https://www.sciencedirect.com/science/article/pii/S0006320715302147)). Caribou may also avoid roads to minimize predation risk ( [Dussault et al. 2012](https://royalsocietypublishing.org/doi/pdf/10.1098/rspb.2012.1700)), as predators such as wolves and bears may make use of these areas to hunt prey ( [Whittington et al. 2011](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.1365-2664.2011.02043.x), [Latham et al 2011](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/11-0666.1)). The CFDM does not attempt to  measure or disentangle the effects of these different ecological processes, but it is assumed that the negative relationship between caribou and roads is indicative of these processes.  

In general, the CFDM indicated that the effect of cutblocks on caribou distribution was highly variable and weaker than the effect of roads. For example, caribou in the boreal (DU6), consistently selected cutblcosk 1 to 9 years old, but avoided cutblocks 10 to 40 years old, whereas the effect of 1 to 40 year old cutblocks varied across northern mountain (DU7) herds. Cutblocks can have a negative effect on caribou, as they provide forage for ungulates such as moose, thus supporting higher densities of ungulates and their predators, such as wolves, that then predate on caribou ( [Seip 1992](https://www.nrcresearchpress.com/doi/abs/10.1139/z92-206#.XkXfPTFKikw), [DeCesare et al. 2010](https://zslpublications.onlinelibrary.wiley.com/doi/full/10.1111/j.1469-1795.2009.00328.x), [Serrouya et al. 2017](https://peerj.com/articles/3736/?utm_source=TrendMD&utm_campaign=PeerJ_TrendMD_1&utm_medium=TrendMD)). However, there may be reasons why we detected a weak negative, or sometimes positive effect of cutblocks on caribou in some herds and DU's. First, caribou may use cutblocks periodically throughout the year to access forage. Caribou will select for deciduous shrub species during summer foraging ( [Denryter et al. 2017](https://www.nrcresearchpress.com/doi/full/10.1139/cjz-2016-0114#.XkbFSjFKikw)), and these species tend to increase in cutblocks ( [Strong and Gates 2006](https://www.sciencedirect.com/science/article/pii/S0378112705006456)). Indeed, research in Quebec has found that caribou selected younger cutblocks, presumably because of their forage benefit ( [Dussault et al. 2012](https://royalsocietypublishing.org/doi/pdf/10.1098/rspb.2012.1700)). Second, the negative effect of cutblocks may occur at larger scales, outside of the home range. [DeCesare et al. 2012](https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/11-1610.1) found that caribou avoided cutblocks at the range scale (i.e., caribou home ranges occurred in areas with fewer cutblocks), but not within their home ranges. This suggests the negative predation effect of cutblocks occurs at larger scales, that caribou are less likely to establish home ranges in areas with more cutblocks, perhaps because they are avoiding predation risk or they are unable to survive in those areas. Clearly, the effects of cutblocks on caribou distribution is more nuanced than roads, and the CFDM appears to represent these nuanced effects by representing a variable effect of cutblocks on caribou across herds and DUs.

The CFDM provides a framework for testing the effects of simulated future forestry activities on caribou. It includes random effects to account for individual and herd-level variability in caribou responses to cutblocks and roads, which provides a great deal of flexibility in estimating the effects of proposed future forestry activities on caribou. This model has been incorporated into the rsfCLUS module of the CLUS model.

Future work will focus on developing a similar model that accounts for the effects of roads and cutblocks at a larger scale, i.e., on the establishment of home rages by cariobu. In addition, we are relating these models to caribou population measures (e.g., trend) at a herd scale to assess their utility as indicators of caribou population responses to forestry disturbance.  